diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/Master/ocean_coupler.F roms-3.5/Master/ocean_coupler.F
--- roms-3.5f/Master/ocean_coupler.F	2012-04-02 16:43:26.362489000 +0200
+++ roms-3.5/Master/ocean_coupler.F	2012-05-02 09:40:29.532924000 +0200
@@ -119,4 +119,501 @@
 # endif
 
 #endif
+#if defined REGCM_COUPLING
+      USE mod_kinds
+      IMPLICIT NONE
+!
+      PRIVATE
+      PUBLIC :: atm2ocn_coupling
+      PUBLIC :: allocate_atm2ocn
+      PUBLIC :: initialize_atm2ocn 
+!
+!  Declarations.
+!
+      TYPE RCM_DATA
+      real(r8), pointer :: Pair(:,:)
+      real(r8), pointer :: Tair(:,:)
+      real(r8), pointer :: Qair(:,:)
+      real(r8), pointer :: swrad(:,:)
+      real(r8), pointer :: lwrad_down(:,:)
+      real(r8), pointer :: rain(:,:)
+      real(r8), pointer :: Uwind(:,:)
+      real(r8), pointer :: Vwind(:,:)
+      END TYPE RCM_DATA
+!
+      TYPE (RCM_DATA), PUBLIC, ALLOCATABLE :: rdata(:)
+!
+      INTEGER, PUBLIC, ALLOCATABLE :: CoupleSteps(:) 
+            
+      CONTAINS
+
+      SUBROUTINE atm2ocn_coupling (ng, tile)
+!
+!=======================================================================
+!                                                                      !
+!  This subroutine acquires the coupling data streams between ocean    !
+!  and atmosphere models. Currently, the following data streams are    !
+!  coded:                                                              !
+!                                                                      !
+!     (...) RegCM units                                                !
+!     [...] ROMS  units                                                !
+!                                                                      !
+!  Fields imported form RegCM model:                                   !
+!                                                                      !
+!     * Surface atmospheric pressure (Pa), [mb]                        !
+!     * Surface air relative humidity (percent), [fraction]            !
+!     * Surface (2 m) air temperature (Celsius), [Celsius]             !
+!     * Surface (10 m) U-wind speed (m/s), [m/s]                       !
+!     * Surface (10 m) V-wind speed (m/s), [m/s]                       !
+!     * Precipitation (m/s), [kg/m2/s]                                 !
+!     * Shortwave radiation (Watts/m2), [Celsius m/s]                  !
+!     * Downwelling long wave raditaion (Watts/m2), [Celsius m/s]      !
+!                                                                      !
+!  Fields exported to RegCM model:                                     !
+!                                                                      !
+!     * Sea surface potential temperature (Kelvin), [Celsius]          !
+!                                                                      !
+!=======================================================================
+!
+      USE mod_param
+!
+      implicit none
+!
+!  Imported variable declarations.
+!
+      integer, intent(in) :: ng, tile
+!
+!  Local variable declarations.
+!
+      integer :: LBi, UBi, LBj, UBj
+!
+      LBi=BOUNDS(ng)%LBi(tile)
+      UBi=BOUNDS(ng)%UBi(tile)
+      LBj=BOUNDS(ng)%LBj(tile)
+      UBj=BOUNDS(ng)%UBj(tile)
+!
+#ifdef PROFILE
+      CALL wclock_on (ng, iNLM, 48)
+#endif
+      CALL atm2ocn_coupling_tile (ng, tile,                             &
+     &                            LBi, UBi, LBj, UBj)
+#ifdef PROFILE
+      CALL wclock_off (ng, iNLM, 48)
+#endif
+!
+      RETURN
+      END SUBROUTINE atm2ocn_coupling
+!
+!***********************************************************************
+      SUBROUTINE atm2ocn_coupling_tile (ng, tile,                       &
+                                        LBi, UBi, LBj, UBj)
+!***********************************************************************
+!
+      USE mod_param
+      USE mod_parallel
+      USE mod_coupler
+      USE mod_forces
+      USE mod_ocean
+      USE mod_ncparam
+      USE mod_scalars
+      USE mod_stepping
+      USE mod_iounits
+      USE mod_grid 
+!
+      USE distribute_mod, ONLY : mp_reduce
+!
+      implicit none
+!
+!  Imported variable declarations.
+!
+      integer, intent(in) :: ng, tile
+      integer, intent(in) :: LBi, UBi, LBj, UBj
+!
+!  Local variable declarations.
+!
+      integer :: i, j, gtype, id, status
+      integer :: Istr, Iend, Jstr, Jend
+      integer :: IstrR, IendR, JstrR, JendR, IstrU, JstrV
+!
+!-----------------------------------------------------------------------
+!  Compute lower and upper bounds over a particular domain partition or
+!  tile for RHO-, U-, and V-variables. Notice that "set_bounds.h" is
+!  not used here because of implementation of periodicity in other
+!  models.
+!-----------------------------------------------------------------------
+!
+      IstrR = BOUNDS(ng)%IstrR(tile)
+      IendR = BOUNDS(ng)%IendR(tile)
+      JstrR = BOUNDS(ng)%JstrR(tile)
+      JendR = BOUNDS(ng)%JendR(tile)
+!
+!-----------------------------------------------------------------------
+!  Import fields from atmosphere model (RegCM) to ocean model (ROMS).
+!-----------------------------------------------------------------------
+!
+#if defined BULK_FLUXES || defined ECOSIM || defined ATM_PRESS
+!
+!-----------------------------------------------------------------------
+!  Surface air pressure (mb)
+!-----------------------------------------------------------------------
+!
+      id = idPair
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%Pair,                               &
+     &                    FORCES(ng)%Pair,                              &
+     &                    status)
+#endif
+#if defined BULK_FLUXES || defined ECOSIM || \
+   (defined SHORTWAVE && defined ANA_SRFLUX)
+!
+!-----------------------------------------------------------------------
+!  Surface air humidity (g/kg) 
+!-----------------------------------------------------------------------
+!
+      id = idQair
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%Qair,                               &
+     &                    FORCES(ng)%Hair,                              &
+     &                    status)
+!
+!-----------------------------------------------------------------------
+!  Surface (2m) air temperature (Celsius) 
+!-----------------------------------------------------------------------
+!
+      id = idTair
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%Tair,                               &
+     &                    FORCES(ng)%Tair,                              &
+     &                    status)
+#endif
+#if defined BULK_FLUXES || defined ECOSIM
+!
+!-----------------------------------------------------------------------
+!  U-wind (10m) component (m/s)
+!-----------------------------------------------------------------------
+!
+      id = idUair
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%Uwind,                              &
+     &                    FORCES(ng)%Uwind,                             &
+     &                    status)
+!
+!-----------------------------------------------------------------------
+!  V-wind (10m) component (m/s)
+!-----------------------------------------------------------------------
+!
+      id = idVair
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%Vwind,                              &
+     &                    FORCES(ng)%Vwind,                             &
+     &                    status)
+!
+!-----------------------------------------------------------------------
+!  Rotate wind components 
+!-----------------------------------------------------------------------
+!
+      FORCES(ng)%Uwind = FORCES(ng)%Uwind*cos(GRID(ng)%angler)+         &
+                         FORCES(ng)%Vwind*sin(GRID(ng)%angler)
+      FORCES(ng)%Vwind = FORCES(ng)%Vwind*cos(GRID(ng)%angler)-         &
+                         FORCES(ng)%Uwind*sin(GRID(ng)%angler)       
+#endif
+#ifdef CLOUDS
+!
+!-----------------------------------------------------------------------
+!  Cloud fraction (fraction, so 0 to 1)
+!-----------------------------------------------------------------------
+!
+      id = idCfra
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%cloud,                              &
+     &                    FORCES(ng)%cloud,                             &
+     &                    status)
+#endif
+#ifdef BULK_FLUXES
+!
+!-----------------------------------------------------------------------
+!  Precipitation (kg/m2/s) 
+!-----------------------------------------------------------------------
+!
+      id = idrain
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%rain,                               &
+     &                    FORCES(ng)%rain,                              &
+     &                    status)
+!
+!-----------------------------------------------------------------------
+!  Longwave radiation (Celsius m/s) 
+!-----------------------------------------------------------------------
+!
+      id = idLdwn
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%lwrad_down,                         &
+     &                    FORCES(ng)%lrflx,                             &
+     &                    status)
+#endif
+#ifdef SHORTWAVE
+!
+!-----------------------------------------------------------------------
+!  Shortwave radiation (Celsius m/s) 
+!-----------------------------------------------------------------------
+!
+      id = idSrad
+      gtype = r2dvar
+      CALL ROMS_import2d (ng, tile, gtype,                              &
+     &                    IstrR, IendR, JstrR, JendR,                   &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    rdata(ng)%swrad,                              &
+     &                    FORCES(ng)%srflx,                             &
+     &                    status)
+#endif
+!
+      RETURN
+      END SUBROUTINE atm2ocn_coupling_tile
+
+      SUBROUTINE allocate_atm2ocn (ng, LBi, UBi, LBj, UBj)
+      USE mod_param
+!
+!  Imported variable declarations.
+!
+      integer, intent(in) :: ng, LBi, UBi, LBj, UBj
+!
+      IF (ng .eq. 1) allocate(rdata(Ngrids))
+      allocate(rdata(ng)%Pair(LBi:UBi,LBj:UBj))
+      allocate(rdata(ng)%Tair(LBi:UBi,LBj:UBj))
+      allocate(rdata(ng)%Qair(LBi:UBi,LBj:UBj))
+      allocate(rdata(ng)%swrad(LBi:UBi,LBj:UBj))
+      allocate(rdata(ng)%lwrad_down(LBi:UBi,LBj:UBj))
+      allocate(rdata(ng)%rain(LBi:UBi,LBj:UBj))
+      allocate(rdata(ng)%Uwind(LBi:UBi,LBj:UBj))
+      allocate(rdata(ng)%Vwind(LBi:UBi,LBj:UBj))
+!
+      IF (ng .eq. 1) allocate(CoupleSteps(Ngrids))
+
+      RETURN
+      END SUBROUTINE allocate_atm2ocn
+!
+      SUBROUTINE initialize_atm2ocn (ng, tile)
+      USE mod_param
+      USE mod_scalars
+!
+!  Imported variable declarations.
+!
+      integer, intent(in) :: ng, tile
+!
+!  Local variable declarations.
+!
+      integer :: Imin, Imax, Jmin, Jmax
+      integer :: i, j, k
+!
+      real(r8), parameter :: IniVal = 0.0_r8
+!
+#include "set_bounds.h"
+!
+!  Set array initialization range.
+!
+#ifdef _OPENMP
+      IF (DOMAIN(ng)%Western_Edge(tile)) THEN
+        Imin=BOUNDS(ng)%LBi(tile)
+      ELSE
+        Imin=Istr
+      END IF
+      IF (DOMAIN(ng)%Eastern_Edge(tile)) THEN
+        Imax=BOUNDS(ng)%UBi(tile)
+      ELSE
+        Imax=Iend
+      END IF
+      IF (DOMAIN(ng)%Southern_Edge(tile)) THEN
+        Jmin=BOUNDS(ng)%LBj(tile)
+      ELSE
+        Jmin=Jstr
+      END IF
+      IF (DOMAIN(ng)%Northern_Edge(tile)) THEN
+        Jmax=BOUNDS(ng)%UBj(tile)
+      ELSE
+        Jmax=Jend
+      END IF
+#else
+      Imin=BOUNDS(ng)%LBi(tile)
+      Imax=BOUNDS(ng)%UBi(tile)
+      Jmin=BOUNDS(ng)%LBj(tile)
+      Jmax=BOUNDS(ng)%UBj(tile)
+#endif
+!
+      DO j=Jmin,Jmax
+        DO i=Imin,Imax
+          rdata(ng)%Pair(i,j) = IniVal
+          rdata(ng)%Tair(i,j) = IniVal
+          rdata(ng)%Qair(i,j) = IniVal
+          rdata(ng)%swrad(i,j) = IniVal
+          rdata(ng)%lwrad_down(i,j) = IniVal
+          rdata(ng)%rain(i,j) = IniVal
+          rdata(ng)%Uwind(i,j) = IniVal
+          rdata(ng)%Vwind(i,j) = IniVal
+        END DO
+      END DO  
+!
+      RETURN
+      END SUBROUTINE initialize_atm2ocn
+
+      SUBROUTINE ROMS_import2d (ng, tile, gtype,                        &
+     &                          Imin, Imax, Jmin, Jmax,                 &
+     &                          LBi, UBi, LBj, UBj,                     & 
+     &                          InpField,                               &
+     &                          OutField,                               &
+     &                          status)
+      USE mod_param
+      USE mod_ncparam
+# if defined EW_PERIODIC || defined NS_PERIODIC
+      USE exchange_2d_mod
+# endif
+# ifdef DISTRIBUTE
+      USE distribute_mod,  ONLY : mp_reduce
+      USE mp_exchange_mod, ONLY : mp_exchange2d
+# endif
+!
+!  Imported variable declarations.
+!
+      integer, intent(in) :: ng, tile, gtype
+      integer, intent(in) :: Imin, Imax, Jmin, Jmax
+      integer, intent(in) :: LBi, UBi, LBj, UBj
+      real(r8), intent(in) ::  InpField(:,:)
+      real(r8), intent(out) :: OutField(LBi:UBi,LBj:UBj)
+      integer, intent(out) :: status
+!
+!  Local variable declarations.
+!
+# ifdef DISTRIBUTE
+#  ifdef EW_PERIODIC
+      logical :: EWperiodic=.TRUE.
+#  else
+      logical :: EWperiodic=.FALSE.
+#  endif
+#  ifdef NS_PERIODIC
+      logical :: NSperiodic=.TRUE.
+#  else
+      logical :: NSperiodic=.FALSE.
+#  endif
+# endif
+      integer :: i, j
+      real(r8) :: OutFmin, OutFmax
+      real(r8), parameter :: Large = 1.0E+20_r8
+      real(r8), dimension(2) :: range
+# ifdef DISTRIBUTE
+      character (len=3), dimension(2) :: op_handle
+# endif
+!
+!-----------------------------------------------------------------------
+!  Import 2D field (update also halo regions).
+!-----------------------------------------------------------------------
+!
+      status=0
+      range(1)= Large
+      range(2)=-Large
+      OutField = InpField
+      range(1)=MINVAL(OutField)
+      range(2)=MAXVAL(OutField)
+!
+# ifdef DISTRIBUTE
+!
+!  Global reduction for imported field range values.
+!
+      op_handle(1)='MIN'
+      op_handle(2)='MAX'
+      CALL mp_reduce (ng, iNLM, 2, range, op_handle)
+      OutFmin=range(1)
+      OutFmax=range(2)
+# endif
+!
+!-----------------------------------------------------------------------
+!  Exchange boundary information.
+!-----------------------------------------------------------------------
+!
+# if defined EW_PERIODIC || defined NS_PERIODIC
+      IF (gtype.eq.r2dvar) THEN
+        CALL exchange_r2d_tile (ng, tile,                               &
+     &                          LBi, UBi, LBj, UBj,                     &
+     &                          OutField)
+      ELSE IF (gtype.eq.u2dvar) THEN
+        CALL exchange_u2d_tile (ng, tile,                               &
+     &                          LBi, UBi, LBj, UBj,                     &
+     &                          OutField)
+      ELSE IF (gtype.eq.v2dvar) THEN
+        CALL exchange_v2d_tile (ng, tile,                               &
+     &                          LBi, UBi, LBj, UBj,                     &
+     &                          OutField)
+      END IF
+# endif
+# ifdef DISTRIBUTE
+      CALL mp_exchange2d (ng, tile, iNLM, 1,                            &
+     &                    LBi, UBi, LBj, UBj,                           &
+     &                    NghostPoints, EWperiodic, NSperiodic,         &
+     &                    OutField)
+# endif
+      RETURN
+      END SUBROUTINE ROMS_import2d
+!
+      SUBROUTINE PRINT_MATRIX_R8(inp, iskip, jskip, pet, header)
+      implicit none
+!
+!-----------------------------------------------------------------------
+!     Imported variable declarations 
+!-----------------------------------------------------------------------
+!
+      real(r8), intent(in) :: inp(:,:)
+      integer, intent(in) ::  iskip, jskip, pet
+      character(len=*), intent(in) :: header
+!
+!-----------------------------------------------------------------------
+!     Local variable declarations 
+!-----------------------------------------------------------------------
+!
+      integer :: i, j, imin, imax, jmin, jmax
+      character(100) :: fmt_123
+!
+!-----------------------------------------------------------------------
+!     Write data 
+!-----------------------------------------------------------------------
+!
+      imin = lbound(inp, dim=1)
+      imax = ubound(inp, dim=1)
+      jmin = lbound(inp, dim=2)
+      jmax = ubound(inp, dim=2)
+!
+      WRITE(6, fmt="('PET(',I2,') - ',A)") pet, trim(header)
+!
+      WRITE(fmt_123, fmt="('(/, 5X, ', I3, 'I12)')") (imax-imin)+1
+      WRITE(6, fmt=trim(fmt_123))  (i, i=imin, imax, iskip)
+!   
+      WRITE(fmt_123, fmt="('(I5, ', I3, 'F12.6)')") imax
+      DO j = jmin, jmax, jskip
+        write(6, fmt=trim(fmt_123)) j, (inp(i,j),i=imin, imax, iskip)
+      END DO
+!
+      RETURN
+      END SUBROUTINE PRINT_MATRIX_R8
+#endif
       END MODULE ocean_coupler_mod
diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Nonlinear/main3d.F roms-3.5/ROMS/Nonlinear/main3d.F
--- roms-3.5f/ROMS/Nonlinear/main3d.F	2012-04-02 16:40:57.039631000 +0200
+++ roms-3.5/ROMS/Nonlinear/main3d.F	2012-05-02 09:40:29.539937000 +0200
@@ -75,6 +75,9 @@
 # ifdef AIR_OCEAN
       USE ocean_coupler_mod, ONLY : ocn2atm_coupling
 # endif
+# ifdef REGCM_COUPLING
+      USE ocean_coupler_mod, ONLY : atm2ocn_coupling
+# endif
 # ifdef WAVES_OCEAN
       USE ocean_coupler_mod, ONLY : ocn2wav_coupling
 # endif
@@ -279,6 +282,24 @@
         END DO
 # endif
 
+# ifdef REGCM_COUPLING
+!
+!-----------------------------------------------------------------------
+!  Couple atmosphere to ocean model 
+!-----------------------------------------------------------------------
+!
+        DO ng=1,Ngrids
+!$OMP PARALLEL DO PRIVATE(thread,subs,tile) SHARED(ng,numthreads)
+          DO thread=0,numthreads-1
+            subs=NtileX(ng)*NtileE(ng)/numthreads
+            DO tile=subs*thread,subs*(thread+1)-1,+1
+              CALL atm2ocn_coupling (ng, TILE)
+            END DO
+          END DO
+!$OMP END PARALLEL DO
+        END DO
+# endif
+
 # ifdef WAVES_OCEAN
 !
 !-----------------------------------------------------------------------
diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/def_his.F roms-3.5/ROMS/Utility/def_his.F
--- roms-3.5f/ROMS/Utility/def_his.F	2012-04-02 16:41:29.237546000 +0200
+++ roms-3.5/ROMS/Utility/def_his.F	2012-05-02 09:40:29.548940000 +0200
@@ -1190,6 +1190,28 @@
           IF (exit_flag.ne.NoError) RETURN
         END IF
 # endif
+# ifdef REGCM_COUPLING
+# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
+!
+!  Define surface air humidity.
+!
+        IF (Hout(idQair,ng)) THEN
+          Vinfo( 1)=Vname(1,idQair)
+          Vinfo( 2)=Vname(2,idQair)
+          Vinfo( 3)=Vname(3,idQair)
+          Vinfo(14)=Vname(4,idQair)
+          Vinfo(16)=Vname(1,idtime)
+#  if defined WRITE_WATER && defined MASKING
+          Vinfo(20)='mask_rho'
+#  endif  
+          Vinfo(22)='coordinates'
+          Aval(5)=REAL(Iinfo(1,idQair,ng),r8)
+          status=def_var(ng, iNLM, HIS(ng)%ncid, HIS(ng)%Vid(idQair),   &
+     &                   NF_FOUT, nvd3, t2dgrd, Aval, Vinfo, ncname)
+          IF (exit_flag.ne.NoError) RETURN
+        END IF
+# endif
+# endif
 # if defined BULK_FLUXES || defined ECOSIM
 !
 !  Define surface winds.
@@ -2441,6 +2463,13 @@
             got_var(idPair)=.TRUE.
             HIS(ng)%Vid(idPair)=var_id(i)
 # endif
+# ifdef REGCM_COUPLING
+# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
+          ELSE IF (TRIM(var_name(i)).eq.TRIM(Vname(1,idQair))) THEN
+            got_var(idQair)=.TRUE.
+            HIS(ng)%Vid(idQair)=var_id(i)
+# endif
+# endif
 # if defined BULK_FLUXES || defined ECOSIM
           ELSE IF (TRIM(var_name(i)).eq.TRIM(Vname(1,idUair))) THEN
             got_var(idUair)=.TRUE.
@@ -2858,6 +2887,16 @@
           RETURN
         END IF
 # endif
+# ifdef REGCM_COUPLING
+# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
+        IF (.not.got_var(idQair).and.Hout(idQair,ng)) THEN
+          IF (Master) WRITE (stdout,60) TRIM(Vname(1,idQair)),          &
+     &                                  TRIM(ncname)
+          exit_flag=3
+          RETURN
+        END IF
+# endif
+# endif
 # if defined BULK_FLUXES || defined ECOSIM
         IF (.not.got_var(idUair).and.Hout(idUair,ng)) THEN
           IF (Master) WRITE (stdout,60) TRIM(Vname(1,idUair)),          &
diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/get_date.F roms-3.5/ROMS/Utility/get_date.F
--- roms-3.5f/ROMS/Utility/get_date.F	2012-04-02 16:41:28.631521000 +0200
+++ roms-3.5/ROMS/Utility/get_date.F	2012-05-02 11:43:45.992491000 +0200
@@ -284,6 +284,10 @@
      &         (/ 1,32,61,92,122,153,183,214,245,275,306,336,367 /)
 
       real(r8) :: rday
+# ifdef REGCM_COUPLING
+      integer :: i
+      real(r8) :: sday, nday
+# endif
 !
 !-----------------------------------------------------------------------
 !  Get calendar day from model time.
@@ -292,6 +296,50 @@
 !  The reference time is a positive date specified at initialization.
 !
       IF (INT(r_date(1)).gt.0) THEN
+# ifdef REGCM_COUPLING
+        rday=time+r_date(3)+                                            &
+     &       (r_date(6)+(r_date(7)+r_date(8)/60.0_r8)/60.0_r8)/24.0_r8
+        year=INT(r_date(2))+INT(rday/365.25_r8)
+        sday = 0.0_r8
+        DO i = INT(r_date(2)), year-1
+          leap=MOD(i,4)
+          if (leap.eq.0) THEN
+            nday = 366.0_r8
+          else
+            nday = 365.0_r8
+          end if
+          sday = sday+nday
+        END DO
+        IF (rday .lt. sday) year = year-1
+        IF (year .eq. INT(r_date(2))) THEN
+          yday = rday
+        ELSE
+          IF ((sday-rday) .lt. 0.0_r8) THEN
+            yday=MAX(1.0_r8,MOD(rday,365.25_r8))
+          ELSE
+            yday = rday-(sday-nday)+1
+          END IF
+        END IF
+        leap=MOD(year,4)
+        IF (leap.eq.0) THEN
+          month=0
+          DO i = 1, 12
+            IF ((yday .GE. iydl(i)) .AND. (yday .LT. iydl(i+1))) THEN
+              month = i
+            END IF
+          END DO
+          day=INT(yday)-iydl(month)+1
+        ELSE
+          month=0
+          DO i = 1, 12
+            IF ((yday .GE. iyd(i)) .AND. (yday .LT. iyd(i+1))) THEN
+              month = i
+            END IF
+          END DO
+          day=INT(yday)-iyd(month)+1
+        END IF
+        hour=(rday-AINT(rday))*24.0_r8
+# else
         rday=time+r_date(3)+                                            &
      &       (r_date(6)+(r_date(7)+r_date(8)/60.0_r8)/60.0_r8)/24.0_r8
         year=INT(r_date(2))+INT(rday/365.25_r8)
@@ -306,6 +354,7 @@
           day=INT(yday)-iydl(month)+1
         END IF
         hour=(rday-AINT(rday))*24.0_r8
+# endif
 !
 !  The reference time is for a climatological simulation with 365.25
 !  days in every year.
diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/inp_par.F roms-3.5/ROMS/Utility/inp_par.F
--- roms-3.5f/ROMS/Utility/inp_par.F	2012-04-02 16:41:26.773399000 +0200
+++ roms-3.5/ROMS/Utility/inp_par.F	2012-05-02 09:40:29.566938000 +0200
@@ -105,7 +105,11 @@
 !  input parameters to all nodes.
 !
 !!    CALL my_getarg (1, Iname)
+#  ifdef REGCM_COUPLING 
+      IF (Master) CALL my_getarg (2, Iname)
+#  else
       IF (Master) CALL my_getarg (1, Iname)
+#  endif
       CALL mp_bcasts (1, model, Iname)
       OPEN (inp, FILE=TRIM(Iname), FORM='formatted', STATUS='old',      &
      &      ERR=20)
@@ -2219,6 +2223,24 @@
             END IF
             Npts=load_l(Nval, Cval, Ngrids, Hout(idPair,:))
 # endif
+# ifdef REGCM_COUPLING
+# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
+          ELSE IF (TRIM(KeyWord).eq.'Hout(idTair)') THEN
+            IF (idTair.eq.0) THEN
+              IF (Master) WRITE (out,280) 'idTair'
+              exit_flag=5
+              RETURN
+            END IF
+            Npts=load_l(Nval, Cval, Ngrids, Hout(idTair,:))
+          ELSE IF (TRIM(KeyWord).eq.'Hout(idQair)') THEN
+            IF (idQair.eq.0) THEN
+              IF (Master) WRITE (out,280) 'idQair'
+              exit_flag=5
+              RETURN
+            END IF
+            Npts=load_l(Nval, Cval, Ngrids, Hout(idQair,:))
+# endif
+# endif
 # if defined BULK_FLUXES || defined ECOSIM
           ELSE IF (TRIM(KeyWord).eq.'Hout(idUair)') THEN
             IF (idUair.eq.0) THEN
@@ -2228,7 +2250,7 @@
             END IF
             Npts=load_l(Nval, Cval, Ngrids, Hout(idUair,:))
           ELSE IF (TRIM(KeyWord).eq.'Hout(idVair)') THEN
-            IF (idPair.eq.0) THEN
+            IF (idVair.eq.0) THEN
               IF (Master) WRITE (out,280) 'idVair'
               exit_flag=5
               RETURN
@@ -4407,6 +4429,16 @@
      &       'Hout(idPair)',                                            &
      &       'Write out surface air pressure.'
 # endif
+# ifdef REGCM_COUPLING
+#if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
+          IF (Hout(idTair,ng)) WRITE (out,170) Hout(idTair,ng),         &
+     &       'Hout(idTair)',                                            &
+     &       'Write out surface air temperature.'
+          IF (Hout(idQair,ng)) WRITE (out,170) Hout(idQair,ng),         &
+     &       'Hout(idQair)',                                            &
+     &       'Write out surface air humidity.'
+# endif
+# endif
 # if defined BULK_FLUXES || defined ECOSIM
           IF (Hout(idUair,ng)) WRITE (out,170) Hout(idUair,ng),         &
      &       'Hout(idUair)',                                            &
diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/wrt_his.F roms-3.5/ROMS/Utility/wrt_his.F
--- roms-3.5f/ROMS/Utility/wrt_his.F	2012-04-02 16:41:29.652568000 +0200
+++ roms-3.5/ROMS/Utility/wrt_his.F	2012-05-02 09:40:29.572944000 +0200
@@ -1032,6 +1032,54 @@
         END IF
       END IF
 # endif
+# ifdef REGCM_COUPLING
+# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
+!
+!  Write out surface air temperature.
+!
+      IF (Hout(idTair,ng)) THEN
+        scale=1.0_r8
+        gtype=gfactor*r2dvar
+        status=nf_fwrite2d(ng, iNLM, HIS(ng)%ncid, HIS(ng)%Vid(idTair), &
+     &                     HIS(ng)%Rindex, gtype,                       &
+     &                     LBi, UBi, LBj, UBj, scale,                   &
+#  ifdef MASKING
+     &                     GRID(ng) % rmask_io,                         &
+#  endif
+     &                     FORCES(ng) % Tair)
+        IF (status.ne.nf90_noerr) THEN
+          IF (Master) THEN
+            WRITE (stdout,10) TRIM(Vname(1,idTair)), HIS(ng)%Rindex 
+          END IF
+          exit_flag=3
+          ioerror=status
+          RETURN
+        END IF
+      END IF
+!
+!  Write out surface air humidity.
+!
+      IF (Hout(idQair,ng)) THEN
+        scale=1.0_r8
+        gtype=gfactor*r2dvar
+        status=nf_fwrite2d(ng, iNLM, HIS(ng)%ncid, HIS(ng)%Vid(idQair), &
+     &                     HIS(ng)%Rindex, gtype,                       &
+     &                     LBi, UBi, LBj, UBj, scale,                   &
+#  ifdef MASKING
+     &                     GRID(ng) % rmask_io,                         &
+#  endif
+     &                     FORCES(ng) % Hair)
+        IF (status.ne.nf90_noerr) THEN
+          IF (Master) THEN
+            WRITE (stdout,10) TRIM(Vname(1,idQair)), HIS(ng)%Rindex
+          END IF
+          exit_flag=3
+          ioerror=status
+          RETURN
+        END IF
+      END IF
+# endif
+# endif
 # if defined BULK_FLUXES || defined ECOSIM
 !
 !  Write out surface winds.
diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/roms-3.5.patch roms-3.5/roms-3.5.patch
--- roms-3.5f/roms-3.5.patch	1970-01-01 01:00:00.000000000 +0100
+++ roms-3.5/roms-3.5.patch	2012-05-02 09:40:17.480205000 +0200
@@ -0,0 +1,802 @@
+diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/Master/ocean_coupler.F roms-3.5/Master/ocean_coupler.F
+--- roms-3.5f/Master/ocean_coupler.F	2012-04-02 16:43:26.362489000 +0200
++++ roms-3.5/Master/ocean_coupler.F	2012-04-03 11:24:25.766093000 +0200
+@@ -119,4 +119,501 @@
+ # endif
+ 
+ #endif
++#if defined REGCM_COUPLING
++      USE mod_kinds
++      IMPLICIT NONE
++!
++      PRIVATE
++      PUBLIC :: atm2ocn_coupling
++      PUBLIC :: allocate_atm2ocn
++      PUBLIC :: initialize_atm2ocn 
++!
++!  Declarations.
++!
++      TYPE RCM_DATA
++      real(r8), pointer :: Pair(:,:)
++      real(r8), pointer :: Tair(:,:)
++      real(r8), pointer :: Qair(:,:)
++      real(r8), pointer :: swrad(:,:)
++      real(r8), pointer :: lwrad_down(:,:)
++      real(r8), pointer :: rain(:,:)
++      real(r8), pointer :: Uwind(:,:)
++      real(r8), pointer :: Vwind(:,:)
++      END TYPE RCM_DATA
++!
++      TYPE (RCM_DATA), PUBLIC, ALLOCATABLE :: rdata(:)
++!
++      INTEGER, PUBLIC, ALLOCATABLE :: CoupleSteps(:) 
++            
++      CONTAINS
++
++      SUBROUTINE atm2ocn_coupling (ng, tile)
++!
++!=======================================================================
++!                                                                      !
++!  This subroutine acquires the coupling data streams between ocean    !
++!  and atmosphere models. Currently, the following data streams are    !
++!  coded:                                                              !
++!                                                                      !
++!     (...) RegCM units                                                !
++!     [...] ROMS  units                                                !
++!                                                                      !
++!  Fields imported form RegCM model:                                   !
++!                                                                      !
++!     * Surface atmospheric pressure (Pa), [mb]                        !
++!     * Surface air relative humidity (percent), [fraction]            !
++!     * Surface (2 m) air temperature (Celsius), [Celsius]             !
++!     * Surface (10 m) U-wind speed (m/s), [m/s]                       !
++!     * Surface (10 m) V-wind speed (m/s), [m/s]                       !
++!     * Precipitation (m/s), [kg/m2/s]                                 !
++!     * Shortwave radiation (Watts/m2), [Celsius m/s]                  !
++!     * Downwelling long wave raditaion (Watts/m2), [Celsius m/s]      !
++!                                                                      !
++!  Fields exported to RegCM model:                                     !
++!                                                                      !
++!     * Sea surface potential temperature (Kelvin), [Celsius]          !
++!                                                                      !
++!=======================================================================
++!
++      USE mod_param
++!
++      implicit none
++!
++!  Imported variable declarations.
++!
++      integer, intent(in) :: ng, tile
++!
++!  Local variable declarations.
++!
++      integer :: LBi, UBi, LBj, UBj
++!
++      LBi=BOUNDS(ng)%LBi(tile)
++      UBi=BOUNDS(ng)%UBi(tile)
++      LBj=BOUNDS(ng)%LBj(tile)
++      UBj=BOUNDS(ng)%UBj(tile)
++!
++#ifdef PROFILE
++      CALL wclock_on (ng, iNLM, 48)
++#endif
++      CALL atm2ocn_coupling_tile (ng, tile,                             &
++     &                            LBi, UBi, LBj, UBj)
++#ifdef PROFILE
++      CALL wclock_off (ng, iNLM, 48)
++#endif
++!
++      RETURN
++      END SUBROUTINE atm2ocn_coupling
++!
++!***********************************************************************
++      SUBROUTINE atm2ocn_coupling_tile (ng, tile,                       &
++                                        LBi, UBi, LBj, UBj)
++!***********************************************************************
++!
++      USE mod_param
++      USE mod_parallel
++      USE mod_coupler
++      USE mod_forces
++      USE mod_ocean
++      USE mod_ncparam
++      USE mod_scalars
++      USE mod_stepping
++      USE mod_iounits
++      USE mod_grid 
++!
++      USE distribute_mod, ONLY : mp_reduce
++!
++      implicit none
++!
++!  Imported variable declarations.
++!
++      integer, intent(in) :: ng, tile
++      integer, intent(in) :: LBi, UBi, LBj, UBj
++!
++!  Local variable declarations.
++!
++      integer :: i, j, gtype, id, status
++      integer :: Istr, Iend, Jstr, Jend
++      integer :: IstrR, IendR, JstrR, JendR, IstrU, JstrV
++!
++!-----------------------------------------------------------------------
++!  Compute lower and upper bounds over a particular domain partition or
++!  tile for RHO-, U-, and V-variables. Notice that "set_bounds.h" is
++!  not used here because of implementation of periodicity in other
++!  models.
++!-----------------------------------------------------------------------
++!
++      IstrR = BOUNDS(ng)%IstrR(tile)
++      IendR = BOUNDS(ng)%IendR(tile)
++      JstrR = BOUNDS(ng)%JstrR(tile)
++      JendR = BOUNDS(ng)%JendR(tile)
++!
++!-----------------------------------------------------------------------
++!  Import fields from atmosphere model (RegCM) to ocean model (ROMS).
++!-----------------------------------------------------------------------
++!
++#if defined BULK_FLUXES || defined ECOSIM || defined ATM_PRESS
++!
++!-----------------------------------------------------------------------
++!  Surface air pressure (mb)
++!-----------------------------------------------------------------------
++!
++      id = idPair
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%Pair,                               &
++     &                    FORCES(ng)%Pair,                              &
++     &                    status)
++#endif
++#if defined BULK_FLUXES || defined ECOSIM || \
++   (defined SHORTWAVE && defined ANA_SRFLUX)
++!
++!-----------------------------------------------------------------------
++!  Surface air humidity (g/kg) 
++!-----------------------------------------------------------------------
++!
++      id = idQair
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%Qair,                               &
++     &                    FORCES(ng)%Hair,                              &
++     &                    status)
++!
++!-----------------------------------------------------------------------
++!  Surface (2m) air temperature (Celsius) 
++!-----------------------------------------------------------------------
++!
++      id = idTair
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%Tair,                               &
++     &                    FORCES(ng)%Tair,                              &
++     &                    status)
++#endif
++#if defined BULK_FLUXES || defined ECOSIM
++!
++!-----------------------------------------------------------------------
++!  U-wind (10m) component (m/s)
++!-----------------------------------------------------------------------
++!
++      id = idUair
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%Uwind,                              &
++     &                    FORCES(ng)%Uwind,                             &
++     &                    status)
++!
++!-----------------------------------------------------------------------
++!  V-wind (10m) component (m/s)
++!-----------------------------------------------------------------------
++!
++      id = idVair
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%Vwind,                              &
++     &                    FORCES(ng)%Vwind,                             &
++     &                    status)
++!
++!-----------------------------------------------------------------------
++!  Rotate wind components 
++!-----------------------------------------------------------------------
++!
++      FORCES(ng)%Uwind = FORCES(ng)%Uwind*cos(GRID(ng)%angler)+         &
++                         FORCES(ng)%Vwind*sin(GRID(ng)%angler)
++      FORCES(ng)%Vwind = FORCES(ng)%Vwind*cos(GRID(ng)%angler)-         &
++                         FORCES(ng)%Uwind*sin(GRID(ng)%angler)       
++#endif
++#ifdef CLOUDS
++!
++!-----------------------------------------------------------------------
++!  Cloud fraction (fraction, so 0 to 1)
++!-----------------------------------------------------------------------
++!
++      id = idCfra
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%cloud,                              &
++     &                    FORCES(ng)%cloud,                             &
++     &                    status)
++#endif
++#ifdef BULK_FLUXES
++!
++!-----------------------------------------------------------------------
++!  Precipitation (kg/m2/s) 
++!-----------------------------------------------------------------------
++!
++      id = idrain
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%rain,                               &
++     &                    FORCES(ng)%rain,                              &
++     &                    status)
++!
++!-----------------------------------------------------------------------
++!  Longwave radiation (Celsius m/s) 
++!-----------------------------------------------------------------------
++!
++      id = idLdwn
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%lwrad_down,                         &
++     &                    FORCES(ng)%lrflx,                             &
++     &                    status)
++#endif
++#ifdef SHORTWAVE
++!
++!-----------------------------------------------------------------------
++!  Shortwave radiation (Celsius m/s) 
++!-----------------------------------------------------------------------
++!
++      id = idSrad
++      gtype = r2dvar
++      CALL ROMS_import2d (ng, tile, gtype,                              &
++     &                    IstrR, IendR, JstrR, JendR,                   &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    rdata(ng)%swrad,                              &
++     &                    FORCES(ng)%srflx,                             &
++     &                    status)
++#endif
++!
++      RETURN
++      END SUBROUTINE atm2ocn_coupling_tile
++
++      SUBROUTINE allocate_atm2ocn (ng, LBi, UBi, LBj, UBj)
++      USE mod_param
++!
++!  Imported variable declarations.
++!
++      integer, intent(in) :: ng, LBi, UBi, LBj, UBj
++!
++      IF (ng .eq. 1) allocate(rdata(Ngrids))
++      allocate(rdata(ng)%Pair(LBi:UBi,LBj:UBj))
++      allocate(rdata(ng)%Tair(LBi:UBi,LBj:UBj))
++      allocate(rdata(ng)%Qair(LBi:UBi,LBj:UBj))
++      allocate(rdata(ng)%swrad(LBi:UBi,LBj:UBj))
++      allocate(rdata(ng)%lwrad_down(LBi:UBi,LBj:UBj))
++      allocate(rdata(ng)%rain(LBi:UBi,LBj:UBj))
++      allocate(rdata(ng)%Uwind(LBi:UBi,LBj:UBj))
++      allocate(rdata(ng)%Vwind(LBi:UBi,LBj:UBj))
++!
++      IF (ng .eq. 1) allocate(CoupleSteps(Ngrids))
++
++      RETURN
++      END SUBROUTINE allocate_atm2ocn
++!
++      SUBROUTINE initialize_atm2ocn (ng, tile)
++      USE mod_param
++      USE mod_scalars
++!
++!  Imported variable declarations.
++!
++      integer, intent(in) :: ng, tile
++!
++!  Local variable declarations.
++!
++      integer :: Imin, Imax, Jmin, Jmax
++      integer :: i, j, k
++!
++      real(r8), parameter :: IniVal = 0.0_r8
++!
++#include "set_bounds.h"
++!
++!  Set array initialization range.
++!
++#ifdef _OPENMP
++      IF (DOMAIN(ng)%Western_Edge(tile)) THEN
++        Imin=BOUNDS(ng)%LBi(tile)
++      ELSE
++        Imin=Istr
++      END IF
++      IF (DOMAIN(ng)%Eastern_Edge(tile)) THEN
++        Imax=BOUNDS(ng)%UBi(tile)
++      ELSE
++        Imax=Iend
++      END IF
++      IF (DOMAIN(ng)%Southern_Edge(tile)) THEN
++        Jmin=BOUNDS(ng)%LBj(tile)
++      ELSE
++        Jmin=Jstr
++      END IF
++      IF (DOMAIN(ng)%Northern_Edge(tile)) THEN
++        Jmax=BOUNDS(ng)%UBj(tile)
++      ELSE
++        Jmax=Jend
++      END IF
++#else
++      Imin=BOUNDS(ng)%LBi(tile)
++      Imax=BOUNDS(ng)%UBi(tile)
++      Jmin=BOUNDS(ng)%LBj(tile)
++      Jmax=BOUNDS(ng)%UBj(tile)
++#endif
++!
++      DO j=Jmin,Jmax
++        DO i=Imin,Imax
++          rdata(ng)%Pair(i,j) = IniVal
++          rdata(ng)%Tair(i,j) = IniVal
++          rdata(ng)%Qair(i,j) = IniVal
++          rdata(ng)%swrad(i,j) = IniVal
++          rdata(ng)%lwrad_down(i,j) = IniVal
++          rdata(ng)%rain(i,j) = IniVal
++          rdata(ng)%Uwind(i,j) = IniVal
++          rdata(ng)%Vwind(i,j) = IniVal
++        END DO
++      END DO  
++!
++      RETURN
++      END SUBROUTINE initialize_atm2ocn
++
++      SUBROUTINE ROMS_import2d (ng, tile, gtype,                        &
++     &                          Imin, Imax, Jmin, Jmax,                 &
++     &                          LBi, UBi, LBj, UBj,                     & 
++     &                          InpField,                               &
++     &                          OutField,                               &
++     &                          status)
++      USE mod_param
++      USE mod_ncparam
++# if defined EW_PERIODIC || defined NS_PERIODIC
++      USE exchange_2d_mod
++# endif
++# ifdef DISTRIBUTE
++      USE distribute_mod,  ONLY : mp_reduce
++      USE mp_exchange_mod, ONLY : mp_exchange2d
++# endif
++!
++!  Imported variable declarations.
++!
++      integer, intent(in) :: ng, tile, gtype
++      integer, intent(in) :: Imin, Imax, Jmin, Jmax
++      integer, intent(in) :: LBi, UBi, LBj, UBj
++      real(r8), intent(in) ::  InpField(:,:)
++      real(r8), intent(out) :: OutField(LBi:UBi,LBj:UBj)
++      integer, intent(out) :: status
++!
++!  Local variable declarations.
++!
++# ifdef DISTRIBUTE
++#  ifdef EW_PERIODIC
++      logical :: EWperiodic=.TRUE.
++#  else
++      logical :: EWperiodic=.FALSE.
++#  endif
++#  ifdef NS_PERIODIC
++      logical :: NSperiodic=.TRUE.
++#  else
++      logical :: NSperiodic=.FALSE.
++#  endif
++# endif
++      integer :: i, j
++      real(r8) :: OutFmin, OutFmax
++      real(r8), parameter :: Large = 1.0E+20_r8
++      real(r8), dimension(2) :: range
++# ifdef DISTRIBUTE
++      character (len=3), dimension(2) :: op_handle
++# endif
++!
++!-----------------------------------------------------------------------
++!  Import 2D field (update also halo regions).
++!-----------------------------------------------------------------------
++!
++      status=0
++      range(1)= Large
++      range(2)=-Large
++      OutField = InpField
++      range(1)=MINVAL(OutField)
++      range(2)=MAXVAL(OutField)
++!
++# ifdef DISTRIBUTE
++!
++!  Global reduction for imported field range values.
++!
++      op_handle(1)='MIN'
++      op_handle(2)='MAX'
++      CALL mp_reduce (ng, iNLM, 2, range, op_handle)
++      OutFmin=range(1)
++      OutFmax=range(2)
++# endif
++!
++!-----------------------------------------------------------------------
++!  Exchange boundary information.
++!-----------------------------------------------------------------------
++!
++# if defined EW_PERIODIC || defined NS_PERIODIC
++      IF (gtype.eq.r2dvar) THEN
++        CALL exchange_r2d_tile (ng, tile,                               &
++     &                          LBi, UBi, LBj, UBj,                     &
++     &                          OutField)
++      ELSE IF (gtype.eq.u2dvar) THEN
++        CALL exchange_u2d_tile (ng, tile,                               &
++     &                          LBi, UBi, LBj, UBj,                     &
++     &                          OutField)
++      ELSE IF (gtype.eq.v2dvar) THEN
++        CALL exchange_v2d_tile (ng, tile,                               &
++     &                          LBi, UBi, LBj, UBj,                     &
++     &                          OutField)
++      END IF
++# endif
++# ifdef DISTRIBUTE
++      CALL mp_exchange2d (ng, tile, iNLM, 1,                            &
++     &                    LBi, UBi, LBj, UBj,                           &
++     &                    NghostPoints, EWperiodic, NSperiodic,         &
++     &                    OutField)
++# endif
++      RETURN
++      END SUBROUTINE ROMS_import2d
++!
++      SUBROUTINE PRINT_MATRIX_R8(inp, iskip, jskip, pet, header)
++      implicit none
++!
++!-----------------------------------------------------------------------
++!     Imported variable declarations 
++!-----------------------------------------------------------------------
++!
++      real(r8), intent(in) :: inp(:,:)
++      integer, intent(in) ::  iskip, jskip, pet
++      character(len=*), intent(in) :: header
++!
++!-----------------------------------------------------------------------
++!     Local variable declarations 
++!-----------------------------------------------------------------------
++!
++      integer :: i, j, imin, imax, jmin, jmax
++      character(100) :: fmt_123
++!
++!-----------------------------------------------------------------------
++!     Write data 
++!-----------------------------------------------------------------------
++!
++      imin = lbound(inp, dim=1)
++      imax = ubound(inp, dim=1)
++      jmin = lbound(inp, dim=2)
++      jmax = ubound(inp, dim=2)
++!
++      WRITE(6, fmt="('PET(',I2,') - ',A)") pet, trim(header)
++!
++      WRITE(fmt_123, fmt="('(/, 5X, ', I3, 'I12)')") (imax-imin)+1
++      WRITE(6, fmt=trim(fmt_123))  (i, i=imin, imax, iskip)
++!   
++      WRITE(fmt_123, fmt="('(I5, ', I3, 'F12.6)')") imax
++      DO j = jmin, jmax, jskip
++        write(6, fmt=trim(fmt_123)) j, (inp(i,j),i=imin, imax, iskip)
++      END DO
++!
++      RETURN
++      END SUBROUTINE PRINT_MATRIX_R8
++#endif
+       END MODULE ocean_coupler_mod
+diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Nonlinear/main3d.F roms-3.5/ROMS/Nonlinear/main3d.F
+--- roms-3.5f/ROMS/Nonlinear/main3d.F	2012-04-02 16:40:57.039631000 +0200
++++ roms-3.5/ROMS/Nonlinear/main3d.F	2012-04-02 16:52:44.722642000 +0200
+@@ -75,6 +75,9 @@
+ # ifdef AIR_OCEAN
+       USE ocean_coupler_mod, ONLY : ocn2atm_coupling
+ # endif
++# ifdef REGCM_COUPLING
++      USE ocean_coupler_mod, ONLY : atm2ocn_coupling
++# endif
+ # ifdef WAVES_OCEAN
+       USE ocean_coupler_mod, ONLY : ocn2wav_coupling
+ # endif
+@@ -279,6 +282,24 @@
+         END DO
+ # endif
+ 
++# ifdef REGCM_COUPLING
++!
++!-----------------------------------------------------------------------
++!  Couple atmosphere to ocean model 
++!-----------------------------------------------------------------------
++!
++        DO ng=1,Ngrids
++!$OMP PARALLEL DO PRIVATE(thread,subs,tile) SHARED(ng,numthreads)
++          DO thread=0,numthreads-1
++            subs=NtileX(ng)*NtileE(ng)/numthreads
++            DO tile=subs*thread,subs*(thread+1)-1,+1
++              CALL atm2ocn_coupling (ng, TILE)
++            END DO
++          END DO
++!$OMP END PARALLEL DO
++        END DO
++# endif
++
+ # ifdef WAVES_OCEAN
+ !
+ !-----------------------------------------------------------------------
+diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/def_his.F roms-3.5/ROMS/Utility/def_his.F
+--- roms-3.5f/ROMS/Utility/def_his.F	2012-04-02 16:41:29.237546000 +0200
++++ roms-3.5/ROMS/Utility/def_his.F	2012-04-03 16:52:59.984717000 +0200
+@@ -1190,6 +1190,28 @@
+           IF (exit_flag.ne.NoError) RETURN
+         END IF
+ # endif
++# ifdef REGCM_COUPLING
++# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
++!
++!  Define surface air humidity.
++!
++        IF (Hout(idQair,ng)) THEN
++          Vinfo( 1)=Vname(1,idQair)
++          Vinfo( 2)=Vname(2,idQair)
++          Vinfo( 3)=Vname(3,idQair)
++          Vinfo(14)=Vname(4,idQair)
++          Vinfo(16)=Vname(1,idtime)
++#  if defined WRITE_WATER && defined MASKING
++          Vinfo(20)='mask_rho'
++#  endif  
++          Vinfo(22)='coordinates'
++          Aval(5)=REAL(Iinfo(1,idQair,ng),r8)
++          status=def_var(ng, iNLM, HIS(ng)%ncid, HIS(ng)%Vid(idQair),   &
++     &                   NF_FOUT, nvd3, t2dgrd, Aval, Vinfo, ncname)
++          IF (exit_flag.ne.NoError) RETURN
++        END IF
++# endif
++# endif
+ # if defined BULK_FLUXES || defined ECOSIM
+ !
+ !  Define surface winds.
+@@ -2441,6 +2463,13 @@
+             got_var(idPair)=.TRUE.
+             HIS(ng)%Vid(idPair)=var_id(i)
+ # endif
++# ifdef REGCM_COUPLING
++# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
++          ELSE IF (TRIM(var_name(i)).eq.TRIM(Vname(1,idQair))) THEN
++            got_var(idQair)=.TRUE.
++            HIS(ng)%Vid(idQair)=var_id(i)
++# endif
++# endif
+ # if defined BULK_FLUXES || defined ECOSIM
+           ELSE IF (TRIM(var_name(i)).eq.TRIM(Vname(1,idUair))) THEN
+             got_var(idUair)=.TRUE.
+@@ -2858,6 +2887,16 @@
+           RETURN
+         END IF
+ # endif
++# ifdef REGCM_COUPLING
++# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
++        IF (.not.got_var(idQair).and.Hout(idQair,ng)) THEN
++          IF (Master) WRITE (stdout,60) TRIM(Vname(1,idQair)),          &
++     &                                  TRIM(ncname)
++          exit_flag=3
++          RETURN
++        END IF
++# endif
++# endif
+ # if defined BULK_FLUXES || defined ECOSIM
+         IF (.not.got_var(idUair).and.Hout(idUair,ng)) THEN
+           IF (Master) WRITE (stdout,60) TRIM(Vname(1,idUair)),          &
+diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/get_date.F roms-3.5/ROMS/Utility/get_date.F
+--- roms-3.5f/ROMS/Utility/get_date.F	2012-04-02 16:41:28.631521000 +0200
++++ roms-3.5/ROMS/Utility/get_date.F	2012-04-02 16:55:36.462845000 +0200
+@@ -284,6 +284,10 @@
+      &         (/ 1,32,61,92,122,153,183,214,245,275,306,336,367 /)
+ 
+       real(r8) :: rday
++# ifdef REGCM_COUPLING
++      integer :: i
++      real(r8) :: sday
++# endif
+ !
+ !-----------------------------------------------------------------------
+ !  Get calendar day from model time.
+@@ -292,6 +296,49 @@
+ !  The reference time is a positive date specified at initialization.
+ !
+       IF (INT(r_date(1)).gt.0) THEN
++# ifdef REGCM_COUPLING
++        rday=time+r_date(3)+                                            &
++     &       (r_date(6)+(r_date(7)+r_date(8)/60.0_r8)/60.0_r8)/24.0_r8
++        year=INT(r_date(2))+INT(rday/365.25_r8)
++        sday = 0.0_r8
++        DO i = INT(r_date(2)), year-1
++          leap=MOD(i,4)
++          if (leap.eq.0) THEN
++            sday = sday+366.0_r8
++          else
++            sday = sday+365.0_r8
++          end if
++        END DO
++        IF (rday .lt. sday) year = year-1
++        IF (year .eq. INT(r_date(2))) THEN
++          yday = rday
++        ELSE
++          IF (sday .gt. 0.0_r8) THEN
++            yday=MAX(1.0_r8,MOD(rday,sday/(year-r_date(2)+1.0_r8)))
++          ELSE
++            yday=MAX(1.0_r8,MOD(rday,365.25_r8))
++          END IF
++        END IF
++        leap=MOD(year,4)
++        IF (leap.eq.0) THEN
++          month=0
++          DO i = 1, 12
++            IF ((yday .GE. iydl(i)) .AND. (yday .LT. iydl(i+1))) THEN
++              month = i
++            END IF
++          END DO
++          day=INT(yday)-iydl(month)+1
++        ELSE
++          month=0
++          DO i = 1, 12
++            IF ((yday .GE. iyd(i)) .AND. (yday .LT. iyd(i+1))) THEN
++              month = i
++            END IF
++          END DO
++          day=INT(yday)-iyd(month)+1
++        END IF
++        hour=(rday-AINT(rday))*24.0_r8
++# else
+         rday=time+r_date(3)+                                            &
+      &       (r_date(6)+(r_date(7)+r_date(8)/60.0_r8)/60.0_r8)/24.0_r8
+         year=INT(r_date(2))+INT(rday/365.25_r8)
+@@ -306,6 +353,7 @@
+           day=INT(yday)-iydl(month)+1
+         END IF
+         hour=(rday-AINT(rday))*24.0_r8
++# endif
+ !
+ !  The reference time is for a climatological simulation with 365.25
+ !  days in every year.
+diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/inp_par.F roms-3.5/ROMS/Utility/inp_par.F
+--- roms-3.5f/ROMS/Utility/inp_par.F	2012-04-02 16:41:26.773399000 +0200
++++ roms-3.5/ROMS/Utility/inp_par.F	2012-04-03 16:32:34.563965000 +0200
+@@ -105,7 +105,11 @@
+ !  input parameters to all nodes.
+ !
+ !!    CALL my_getarg (1, Iname)
++#  ifdef REGCM_COUPLING 
++      IF (Master) CALL my_getarg (2, Iname)
++#  else
+       IF (Master) CALL my_getarg (1, Iname)
++#  endif
+       CALL mp_bcasts (1, model, Iname)
+       OPEN (inp, FILE=TRIM(Iname), FORM='formatted', STATUS='old',      &
+      &      ERR=20)
+@@ -2219,6 +2223,24 @@
+             END IF
+             Npts=load_l(Nval, Cval, Ngrids, Hout(idPair,:))
+ # endif
++# ifdef REGCM_COUPLING
++# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
++          ELSE IF (TRIM(KeyWord).eq.'Hout(idTair)') THEN
++            IF (idTair.eq.0) THEN
++              IF (Master) WRITE (out,280) 'idTair'
++              exit_flag=5
++              RETURN
++            END IF
++            Npts=load_l(Nval, Cval, Ngrids, Hout(idTair,:))
++          ELSE IF (TRIM(KeyWord).eq.'Hout(idQair)') THEN
++            IF (idQair.eq.0) THEN
++              IF (Master) WRITE (out,280) 'idQair'
++              exit_flag=5
++              RETURN
++            END IF
++            Npts=load_l(Nval, Cval, Ngrids, Hout(idQair,:))
++# endif
++# endif
+ # if defined BULK_FLUXES || defined ECOSIM
+           ELSE IF (TRIM(KeyWord).eq.'Hout(idUair)') THEN
+             IF (idUair.eq.0) THEN
+@@ -2228,7 +2250,7 @@
+             END IF
+             Npts=load_l(Nval, Cval, Ngrids, Hout(idUair,:))
+           ELSE IF (TRIM(KeyWord).eq.'Hout(idVair)') THEN
+-            IF (idPair.eq.0) THEN
++            IF (idVair.eq.0) THEN
+               IF (Master) WRITE (out,280) 'idVair'
+               exit_flag=5
+               RETURN
+@@ -4407,6 +4429,16 @@
+      &       'Hout(idPair)',                                            &
+      &       'Write out surface air pressure.'
+ # endif
++# ifdef REGCM_COUPLING
++#if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
++          IF (Hout(idTair,ng)) WRITE (out,170) Hout(idTair,ng),         &
++     &       'Hout(idTair)',                                            &
++     &       'Write out surface air temperature.'
++          IF (Hout(idQair,ng)) WRITE (out,170) Hout(idQair,ng),         &
++     &       'Hout(idQair)',                                            &
++     &       'Write out surface air humidity.'
++# endif
++# endif
+ # if defined BULK_FLUXES || defined ECOSIM
+           IF (Hout(idUair,ng)) WRITE (out,170) Hout(idUair,ng),         &
+      &       'Hout(idUair)',                                            &
+diff --exclude=Linux-ifort.mk --exclude=.svn --exclude=.svnignore --exclude=CVS -Naur roms-3.5f/ROMS/Utility/wrt_his.F roms-3.5/ROMS/Utility/wrt_his.F
+--- roms-3.5f/ROMS/Utility/wrt_his.F	2012-04-02 16:41:29.652568000 +0200
++++ roms-3.5/ROMS/Utility/wrt_his.F	2012-04-03 16:53:06.416099000 +0200
+@@ -1032,6 +1032,54 @@
+         END IF
+       END IF
+ # endif
++# ifdef REGCM_COUPLING
++# if defined BULK_FLUXES || defined ECOSIM || (defined SHORTWAVE && defined ANA_SRFLUX)
++!
++!  Write out surface air temperature.
++!
++      IF (Hout(idTair,ng)) THEN
++        scale=1.0_r8
++        gtype=gfactor*r2dvar
++        status=nf_fwrite2d(ng, iNLM, HIS(ng)%ncid, HIS(ng)%Vid(idTair), &
++     &                     HIS(ng)%Rindex, gtype,                       &
++     &                     LBi, UBi, LBj, UBj, scale,                   &
++#  ifdef MASKING
++     &                     GRID(ng) % rmask_io,                         &
++#  endif
++     &                     FORCES(ng) % Tair)
++        IF (status.ne.nf90_noerr) THEN
++          IF (Master) THEN
++            WRITE (stdout,10) TRIM(Vname(1,idTair)), HIS(ng)%Rindex 
++          END IF
++          exit_flag=3
++          ioerror=status
++          RETURN
++        END IF
++      END IF
++!
++!  Write out surface air humidity.
++!
++      IF (Hout(idQair,ng)) THEN
++        scale=1.0_r8
++        gtype=gfactor*r2dvar
++        status=nf_fwrite2d(ng, iNLM, HIS(ng)%ncid, HIS(ng)%Vid(idQair), &
++     &                     HIS(ng)%Rindex, gtype,                       &
++     &                     LBi, UBi, LBj, UBj, scale,                   &
++#  ifdef MASKING
++     &                     GRID(ng) % rmask_io,                         &
++#  endif
++     &                     FORCES(ng) % Hair)
++        IF (status.ne.nf90_noerr) THEN
++          IF (Master) THEN
++            WRITE (stdout,10) TRIM(Vname(1,idQair)), HIS(ng)%Rindex
++          END IF
++          exit_flag=3
++          ioerror=status
++          RETURN
++        END IF
++      END IF
++# endif
++# endif
+ # if defined BULK_FLUXES || defined ECOSIM
+ !
+ !  Write out surface winds.

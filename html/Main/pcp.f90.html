<HTML>

<HEAD>
<TITLE>pcp.f90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>pcp.f90</H1>
<HR>
<H2 ALIGN=CENTER>pcp.f90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=pcp><H3>pcp</H3></a></p> Click <a href="./callingtree/pcp_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where pcp is used.
<hr>
20:       subroutine pcp(j , istart , iend , nk)
21: 
22: !cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
23: !                                                                     c
24: !     This subroutine computes the 'large scale' precipitation        c
25: !     based on the excess of cloud water above a threshold value.     c
26: !     The threshold (qcth) is temperature dependant and is based      c
27: !     on in cloud measurements of liquid cloud water (not ice).       c
28: !     Rain is only produced from the cloudy fraction of a grid cell   c
29: !     but the calculated precip value is a grid cell average.         c
30: !                                                                     c
31: !     This routine also computes raindrop evaporation and accretion.  c
32: !                                                                     c
33: !     See Pal et al. 2000 JGR-Atmos for more information.             c
34: !                                                                     c
35: !cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
36: 
37:       use <a href="./mod_param1.f90.html#mod_param1" TARGET=CENT_PANEL>mod_param1</a> , only : dt , dtmin , nbatst
38:       use <a href="./mod_param2.F90.html#mod_param2" TARGET=CENT_PANEL>mod_param2</a> , only : ichem
39:       use <a href="./mod_param3.f90.html#mod_param3" TARGET=CENT_PANEL>mod_param3</a> , only : dsigma
40:       use <a href="./mod_bats.F90.html#mod_bats" TARGET=CENT_PANEL>mod_bats</a> , only : pptnc
41:       use <a href="./mod_main.F90.html#mod_main" TARGET=CENT_PANEL>mod_main</a> , only : psb , rainnc
42:       use <a href="./mod_cvaria.F90.html#mod_cvaria" TARGET=CENT_PANEL>mod_cvaria</a> , only : qcten , qvten , tten
43:       use <a href="./mod_pmoist.F90.html#mod_pmoist" TARGET=CENT_PANEL>mod_pmoist</a> , only : cgul , fcc , rhmax , qcth , qck1 , cevap ,&
44:                             & caccr
45:       use <a href="./mod_slice.F90.html#mod_slice" TARGET=CENT_PANEL>mod_slice</a> , only : qcb3d , pb3d , tb3d , qvb3d
46:       use <a href="./mod_trachem.F90.html#mod_trachem" TARGET=CENT_PANEL>mod_trachem</a> , only : remrat , rembc
47:       use <a href="./mod_date.F90.html#mod_date" TARGET=CENT_PANEL>mod_date</a> , only : jyear , jyear0 , ktau
48:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rgti , rgas , ep2 , wlhvocp , svp1 ,   &
49:                                & svp2 , svp3 , svp4 , svp5 , svp6 ,     &
50:                                & tzero
51:       implicit none
52: !
53: ! Dummy arguments
54: !
55:       integer , intent(in) :: j , istart , iend , nk
56: !
57: ! Local variables
58: !
59:       real(8) :: aprdiv , dpovg , es , afc , i1000 , p , pptacc ,       &
60:                & pptkm1 , pptmax , pptnew , q , qcincld , qcleft , qcw ,&
61:                & qs , rdevap , rh , rhcs , rho , tcel , thog , tk ,     &
62:                & uch , uconv
63:       integer :: i , k , kk
64:       real(8) , dimension(istart:iend) :: pptsum
65: !
66:  
67: ! Precip sum beginning from top
68: ! maximum precipation rate (total cloud water/dt)
69:  
70: !--------------------------------------------------------------------
71: !     1. Compute the precipitation formed in each layer.
72: !     The computations are performed from the top to the surface.
73: !     - Auto-conversion: similar to SIMEX (Giorgi and Shields 1999).
74: !     - Raindrop Accretion:  Beheng (1994); EQN 6
75: !     - Raindrop Evaporation:  Sundqvist (1988); EQN 3.4a
76: !--------------------------------------------------------------------
77:  
78:  
79: !     1a. Perform computations for the top layer (layer 1)
80:       thog = 1000.*rgti       ! precipation accumulated from above
81:       i1000 = 1./1000.
82: 
83:       remrat(istart:iend,1:nk) = 0.0
84: 
85:       do i = istart , iend
86:  
87:         afc = fcc(i,1,j)                                      ![frac][avg]
88:  
89:         if ( afc.gt.0.01 ) then ! if there is a cloud
90: !         1aa. Compute temperature and humidities with the adjustments
91: !         due to convection.
92: !         q = qvb3d(i,1,j) + qcuten(i,1)*dt                 
93: !         ![kg/kg][avg] tk = tb3d(i,1,j) + tcuten(i,1)*dt              
94: !         ![k][avg]
95:           q = qvb3d(i,1,j)                                   ![kg/kg][avg]
96:           tk = tb3d(i,1,j)                                   ![k][avg]
97:           tcel = tk - tzero                                  ![C][avg]
98:           p = pb3d(i,1,j)*1000.                              ![Pa][avg]
99:           rho = p/(rgas*tk)                                  ![kg/m3][avg]
100:           qcw = qcb3d(i,1,j)                                 ![kg/kg][avg]
101: !         1ab. Calculate the in cloud mixing ratio [kg/kg]
102:           qcincld = qcw/afc                                  ![kg/kg][cld]
103: !         1ac. Compute the maximum precipation rate
104: !         (i.e. total cloud water/dt) [kg/kg/s]
105:           pptmax = qcw/dt                                    ![kg/kg/s][avg]
106: !         1ad. Implement here the formula for qcth.
107: !         - Gultepe & Isaac, J. Clim, 1997, v10 p446 table 4, eq 5
108: !         - The factor of 1000 converts from g/kg to kg/kg
109: !         - The factor of cgul accounts for the fact that the Gultepe
110: !         and Isaac equation is for mean cloud water while qcth is the
111: !         theshhold for auto-conversion.
112:           qcth = cgul(i,j)*(10.**(-0.489+0.0134*tcel))*i1000 ![kg/kg][cld]
113: !         1ae. Compute the gridcell average autoconversion [kg/k g/s]
114:           pptnew = qck1(i,j)*(qcincld-qcth)*afc              ![kg/kg/s][avg]
115:           pptnew = dmin1(dmax1(pptnew,0.0D0),pptmax)         ![kg/kg/s][avg]
116:           if ( pptnew.gt.0.0 ) then
117:                                    ! New precipitation
118: !           1af. Compute the cloud removal rate (for chemistry) [1/s]
119: !chem2
120:             remrat(i,1) = pptnew/qcw
121: !chem2_
122: !           1ag. Compute the amount of cloud water removed by raindrop
123: !           accretion [kg/kg/s].  In the layer where the precipitation
124: !           is formed, only half of the precipitation is assumed to
125: !           accrete. 1aga. Compute the amount of water remaining in the
126: !           cloud [kg/kg]
127:             qcleft = qcw - pptnew*dt                         ![kg/kg][avg]
128: !           1agb. Add 1/2 of the new precipitation can accrete.
129:             pptkm1 = 0.5*pptnew/afc*rho*dt                   ![kg/m3][cld]
130: !           1agc. Accretion [kg/kg/s]=[m3/kg/s]*[kg/kg]*[kg/m3]
131:             pptacc = caccr*qcleft*pptkm1                     ![kg/kg/s][avg]
132: !           1agd. Update the precipitation accounting for the accretion
133: !           [kg/kg/s]
134:             pptnew = dmin1(pptmax,pptacc+pptnew)             ![kg/kg/s][avg]
135: !           1ah. Accumulate precipitation and convert to kg/m2/s
136:             dpovg = dsigma(1)*psb(i,j)*thog                  ![kg/m2]
137:             pptsum(i) = pptnew*dpovg                         ![kg/m2/s][avg]
138: !           1ai. Compute the cloud water tendency [kg/kg/s*cb]
139:             qcten(i,1,j) = qcten(i,1,j) - pptnew*psb(i,j)    ![kg/kg/s*cb][avg]
140:           else  ! Cloud but no new precipitation
141:             pptsum(i) = 0.0                                  ![kg/m2/s][avg]
142:           end if
143:         else  ! No cloud
144:           pptsum(i) = 0.0                                    ![kg/m2/s][avg]
145:         end if
146:  
147:       end do
148:  
149: !     ****  LAYER TWO TO KL ****
150: !     1b. Perform computations for the 2nd layer to the surface
151:       do k = 2 , nk
152:         do i = istart , iend
153:  
154: !         1ba. Compute temperature and humidities with the adjustments
155: !         due to convection.
156: !         q = qvb3d(i,k,j) ! + qcuten(i,k)*dt                 
157: !         ![kg/kg][avg] tk = tb3d(i,k,j) ! + tcuten(i,k)*dt            
158: !         ![k][avg]
159:           q = qvb3d(i,k,j)                                   ![kg/kg][avg]
160:           tk = tb3d(i,k,j)                                   ![k][avg]
161:           tcel = tk - tzero                                  ![C][avg]
162:           p = pb3d(i,k,j)*1000.                              ![Pa][avg]
163:           rho = p/(rgas*tk)                                  ![kg/m3][avg]
164:           qcw = qcb3d(i,k,j)                                 ![kg/kg][avg]
165:           afc = fcc(i,k,j)                                   ![frac][avg]
166:           if ( tcel.gt.0.0 ) then
167:             es = svp1*1000.*dexp(svp2*tcel/(tk-svp3))        ![Pa][avg]
168:           else
169:             es = svp4*1000.*dexp(svp5-svp6/tk)               ![Pa][avg]
170:           end if
171:           qs = ep2*es/(p-es)                                 ![kg/kg][avg]
172:           rh = dmin1(dmax1(q/qs,0.0D0),rhmax)                ![frac][avg]
173:  
174: !         1bb. Convert accumlated precipitation to kg/kg/s.
175: !         Used for raindrop evaporation and accretion.
176:           dpovg = dsigma(k)*psb(i,j)*thog                    ![kg/m2][avg]
177:           pptkm1 = pptsum(i)/dpovg                           ![kg/kg/s][avg]
178:  
179: !         1bc. Compute the raindrop evaporation in the clear portion of
180: !         the gridcell.
181: !         - It is assumed that raindrops do not evaporate in clouds
182: !         and the rainfall from above is evenly distributed in
183: !         gridcell (i.e. the gridcell average precipitation is used).
184:           if ( pptsum(i).gt.0.0 .and. afc.lt.0.99 ) then
185: !           2bca. Compute the clear sky relative humidity
186:             rhcs = (rh-afc*rhmax)/(1.0-afc)                  ![frac][clr]
187:             rhcs = dmax1(dmin1(rhcs,rhmax),0.0D0)            ![frac][clr]
188: !           2bcb. Raindrop evaporation [kg/kg/s]
189:             rdevap = cevap*(rhmax-rhcs)*sqrt(pptsum(i))*(1.-afc)
190:                                                              ![kg/kg/s][avg]
191:             rdevap = dmin1((qs-q)/dt,rdevap)                 ![kg/kg/s][avg]
192:             rdevap = dmin1(dmax1(rdevap,0.0D0),pptkm1)       ![kg/kg/s][avg]
193: !           2bcc. Update the precipitation accounting for the raindrop
194: !           evaporation [kg/m2/s]
195:             pptsum(i) = pptsum(i) - rdevap*dpovg             ![kg/m2/s][avg]
196: !           2bcf. Compute the water vapor tendency [kg/kg/s*cb]
197:             qvten(i,k,j) = qvten(i,k,j) + rdevap*psb(i,j)    ![kg/kg/s*cb][avg]
198: !           2bcf. Compute the temperature tendency [K/s*cb]
199:             tten(i,k,j) = tten(i,k,j) - wlhvocp*rdevap*psb(i,j)
200:                                                              ![k/s*cb][avg]
201:           else
202:               ! no precipitation from above
203:             rdevap = 0.0                                     ![kg/kg/s][avg]
204:           end if
205:  
206: !         1bd. Compute the autoconversion and accretion [kg/kg/s]
207:           if ( afc.gt.0.01 ) then
208:                              ! if there is a cloud
209: !           1bda. Calculate the in cloud mixing ratio [kg/kg]
210:             qcincld = qcw/afc                                ![kg/kg][cld]
211: !           1bdb. Compute the maximum precipation rate
212: !           (i.e. total cloud water/dt) [kg/kg/s]
213:             pptmax = qcw/dt                                  ![kg/kg/s][cld]
214: !           1bdc. Implement the Gultepe & Isaac formula for qcth.
215:             qcth = cgul(i,j)*(10.**(-0.489+0.0134*tcel))*i1000
216:                                                              ![kg/kg][cld]
217: !           1bdd. Compute the gridcell average autoconversion [kg/kg/s]
218:             pptnew = qck1(i,j)*(qcincld-qcth)*afc            ![kg/kg/s][avg]
219:             pptnew = dmin1(dmax1(pptnew,0.0D0),pptmax)       ![kg/kg/s][avg]
220: !           1be. Compute the cloud removal rate (for chemistry) [1/s]
221: !chem2
222:             if ( pptnew.gt.0.0 ) remrat(i,k) = pptnew/qcw
223: !chem2_
224:  
225: !           1bf. Compute the amount of cloud water removed by raindrop
226: !           accretion [kg/kg/s].  In the layer where the precipitation
227: !           is formed, only half of the precipitation can accrete.
228:             if ( pptkm1.gt.0.0 .or. pptnew.gt.0.0 ) then
229: !             1bfa. Compute the amount of water remaining in the cloud
230: !             [kg/kg]
231:               qcleft = dmax1(qcw-pptnew*dt,0.D0)             ![kg/kg][avg]
232: !             1bfb. Add 1/2 of the new precipitation to the accumulated
233: !             precipitation [kg/m3]
234:               pptkm1 = (pptkm1+0.5*pptnew/afc)*rho*dt        ![kg/m3][cld]
235: !             1bfc. accretion [kg/kg/s]
236:               pptacc = caccr*qcleft*pptkm1                   ![kg/kg/s][avg]
237: !             1bfd. Update the precipitation accounting for the
238: !             accretion [kg/kg/s]
239:               pptnew = dmin1(pptmax,pptacc+pptnew)           ![kg/kg/s][avg]
240:             end if
241: !           1bg. Accumulate precipitation and convert to kg/m2/s
242:             pptsum(i) = pptsum(i) + pptnew*dpovg             ![kg/m2/s][avg]
243: !           1bh. Compute the cloud water tendency [kg/kg/s*cb]
244:             qcten(i,k,j) = qcten(i,k,j) - pptnew*psb(i,j)    ![kg/kg/s*cb][avg]
245:           else
246:             pptnew = 0.0                                     ![kg/kg/s][avg]
247:           end if
248:  
249:         end do
250:       end do
251:  
252: !chem2
253: !--------------------------------------------------------------------
254: !     2. Perform aerosol removal computations
255: !     - swith do i,k loop, add rembc (the below cloud scavenging
256: !     rate, s^-1)
257: !     - Levin & Schwatz
258: !--------------------------------------------------------------------
259:       if ( ichem.eq.1 ) then
260:         uch = 1000.*rgti*3600.
261:         do i = istart , iend
262:           rembc(i,1) = 0.
263:           do k = 2 , nk
264:             rembc(i,k) = 0.
265:             if ( remrat(i,k).gt.0. ) then
266:               do kk = 1 , k - 1
267:                 rembc(i,k) = rembc(i,k) + remrat(i,kk)*qcb3d(i,kk,j)    &
268:                            & *psb(i,j)*dsigma(kk)*uch
269:                                                 ! mm/hr
270:               end do
271:               rembc(i,k) = 6.5*1.E-5*rembc(i,k)**.68   ! s^-1
272:             end if
273:           end do
274:         end do
275:       end if
276: !chem2_
277:  
278:  
279: !--------------------------------------------------------------------
280: !     3. Convert the accumlated precipitation to appropriate units for
281: !     the surface physics and the output
282: !--------------------------------------------------------------------
283:       uconv = 60.*dtmin
284:       aprdiv = 1./dble(nbatst)
285:       if ( jyear.eq.jyear0 .and. ktau.eq.0 ) aprdiv = 1.
286:       do i = istart , iend
287:         rainnc(i,j) = rainnc(i,j) + pptsum(i)*uconv
288:         pptnc(i,j) = pptnc(i,j) + pptsum(i)*aprdiv
289:       end do
290:  
291:       end subroutine pcp
</PRE>

<HR>

</BODY>
</HTML>

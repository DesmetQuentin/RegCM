<HTML>

<HEAD>
<TITLE>mkfile.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>mkfile.F90</H1>
<HR>
<H2 ALIGN=CENTER>mkfile.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=mkfile><H3>mkfile</H3></a></p> Click <a href="./callingtree/mkfile_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where mkfile is used.
<hr>
20:       subroutine mkfile
21:  
22:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
23:       use <a href="./mod_param1.f90.html#mod_param1" TARGET=CENT_PANEL>mod_param1</a>
24:       use <a href="./mod_param2.F90.html#mod_param2" TARGET=CENT_PANEL>mod_param2</a>
25:       use <a href="./mod_iunits.f90.html#mod_iunits" TARGET=CENT_PANEL>mod_iunits</a>
26:       use <a href="./mod_date.F90.html#mod_date" TARGET=CENT_PANEL>mod_date</a>
27:       use <a href="./mod_bats.F90.html#mod_bats" TARGET=CENT_PANEL>mod_bats</a>
28:       use <a href="./mod_mainchem.F90.html#mod_mainchem" TARGET=CENT_PANEL>mod_mainchem</a>
29:       use <a href="./mod_outrad.F90.html#mod_outrad" TARGET=CENT_PANEL>mod_outrad</a>
30:       implicit none
31: !
32: ! PARAMETER definitions
33: !
34:       integer , parameter :: nfmax = 999
35: !
36: ! Local variables
37: !
38: !      character(1) :: a1
39: !      character(16) :: a16
40: !      character(2) :: a2
41: !      character(22) :: a22
42: !      character(78) :: a78
43: !      real(4) :: dtb , dtc , dto , dtr
44:       character(14) :: filatm , filchem , fillak , filrad , filsrf ,    &
45:                      & filsub
46: !      character(40) :: filnam
47:       integer , dimension(nfmax) :: idate1d , imo , iyr
48: !      integer :: iyr1 , iyr2
49:       integer :: idatepp , n , nmo
50:       character(3) :: itype
51: !
52:       print * , ' '
53:       print * , '******* OPENING NEW OUTPUT FILES:' , idatex
54:       if ( iftape ) then
55:         close (iutdat)
56:         itype = 'ATM'
57:         write (filatm,99001) itype , idatex
58:         if ( iotyp.eq.1 ) then
59:           open (iutdat,file=trim(dirout)//pthsep//filatm,               &
60:               & status='replace',form='unformatted',                    &
61:               & recl=iym2*jxm2*ibyte,access='direct')
62:           nrcout = 0
63:         else if ( iotyp.eq.2 ) then
64:           open (iutdat,file=trim(dirout)//pthsep//filatm,               &
65:               & status='replace',form='unformatted')
66:         else
67:         end if
68:         call <a href="./grads_stuf.F90.html#gradsout" TARGET=CENT_PANEL>gradsout</a>(filatm//'.ctl')
69:         print * , 'OPENING NEW OUT FILE: ',trim(dirout),'/',filatm
70:       end if
71:  
72:       if ( ifbat ) then
73:         close (iutbat)
74:         itype = 'SRF'
75:         write (filsrf,99001) itype , idatex
76:         if ( iotyp.eq.1 ) then
77:           open (iutbat,file=trim(dirout)//pthsep//filsrf,               &
78:               & status='replace',form='unformatted',                    &
79:               & recl=iym2*jxm2*ibyte,access='direct')
80:           nrcbat = 0
81:         else if ( iotyp.eq.2 ) then
82:           open (iutbat,file=trim(dirout)//pthsep//filsrf,               &
83:               & status='replace',form='unformatted')
84:         else
85:         end if
86:         call <a href="./grads_stuf.F90.html#gradsbat" TARGET=CENT_PANEL>gradsbat</a>(filsrf//'.ctl')
87:         print * , 'OPENING NEW SRF FILE: ',trim(dirout),'/',filsrf
88:       end if
89:  
90:       if ( nsg.gt.1 .and. ifsub ) then
91:         close (iutsub)
92:         itype = 'SUB'
93:         write (filsub,99001) itype , idatex
94:         if ( iotyp.eq.1 ) then
95:           open (iutsub,file=trim(dirout)//pthsep//filsub,               &
96:               & status='replace',form='unformatted',                    &
97:               & recl=iym2*jxm2*nnsg*ibyte,access='direct')
98:           nrcsub = 0
99:         else if ( iotyp.eq.2 ) then
100:           open (iutsub,file=trim(dirout)//pthsep//filsub,               &
101:               & status='replace',form='unformatted')
102:         else
103:         end if
104:         call <a href="./grads_stuf.F90.html#gradssub" TARGET=CENT_PANEL>gradssub</a>(filsub//'.ctl')
105:         print * , 'OPENING NEW SUB FILE: ',trim(dirout),'/',filsub
106:       end if
107:  
108:       if ( ifrad ) then
109:         close (iutrad)
110:         itype = 'RAD'
111:         write (filrad,99001) itype , idatex
112:         if ( iotyp.eq.1 ) then
113:           open (iutrad,file=trim(dirout)//pthsep//filrad,               &
114:               & status='replace',form='unformatted',                    &
115:               & recl=iym2*jxm2*ibyte,access='direct')
116:           nrcrad = 0
117:         else if ( iotyp.eq.2 ) then
118:           open (iutrad,file=trim(dirout)//pthsep//filrad,               &
119:               & status='replace',form='unformatted')
120:         else
121:         end if
122:         call <a href="./grads_stuf.F90.html#gradsrad" TARGET=CENT_PANEL>gradsrad</a>(filrad//'.ctl')
123:         print * , 'OPENING NEW RAD FILE: ',trim(dirout),'/',filrad
124:       end if
125:  
126: !chem2
127:       if ( ichem.eq.1 ) then
128:         if ( ifchem ) then
129:           close (iutchem)
130:           itype = 'CHE'
131:           write (filchem,99001) itype , idatex
132:           if ( iotyp.eq.1 ) then
133:             open (iutchem,file=trim(dirout)//pthsep//filchem,           &
134:                 & status='replace',form='unformatted',                  &
135:                 & recl=iym2*jxm2*ibyte,access='direct')
136:             nrcchem = 0
137:           else if ( iotyp.eq.2 ) then
138:             open (iutchem,file=trim(dirout)//pthsep//filchem,           &
139:                 & status='replace',form='unformatted')
140:           else
141:           end if
142:           call <a href="./grads_stuf.F90.html#gradschem" TARGET=CENT_PANEL>gradschem</a>(filchem//'.ctl')
143:           print * , 'OPENING NEW CHEM FILE: ',trim(dirout),'/',filchem
144:         end if
145:       end if
146: !chem2_
147:       if ( lakemod.eq.1 ) then
148:         close (iutlak)
149:         itype = 'LAK'
150:         write (fillak,99001) itype , idatex
151:         open (iutlak,file=trim(dirout)//pthsep//fillak,                 &
152:             & status='replace',form='unformatted')
153:         print * , 'OPENING NEW LAK FILE: ',trim(dirout),'/',fillak
154:       end if
155:  
156:       if ( jyear.eq.jyear0 .and. ktau.eq.0 ) then
157:         nmo = (idate2/1000000-idate0/1000000)                           &
158:             & *12 + (idate2/10000-(idate2/1000000)*100)                 &
159:             & - (idate0/10000-(idate0/1000000)*100)
160:         nmo = min(nmo,nfmax)
161:         idatepp = idate0
162:         iyr(1) = idatepp/1000000
163:         imo(1) = (idatepp-iyr(1)*1000000)/10000
164:         idate1d(1) = idatepp
165:         do n = 2 , nmo
166:           idatepp = (idatepp/10000)*10000 + 10100
167:           iyr(n) = idatepp/1000000
168:           imo(n) = (idatepp-iyr(n)*1000000)/10000
169:           if ( imo(n).gt.12 ) then
170:             iyr(n) = iyr(n) + 1
171:             imo(n) = 1
172:             idatepp = iyr(n)*1000000 + imo(n)*10000 + 100
173:           end if
174:           idate1d(n) = idatepp
175:         end do
176:         if ( nmo.le.1 ) then
177:           nmo = 1
178:           idate1d(2) = idate0
179:         end if
180:  
181: !       **** Write out postprocessing information
182: 
183: ! here below commented out: useless with new postprocessing tools 
184: !
185: !        open (99,file='postproc.in',form='FORMATTED',status='unknown')
186: !        a1 = char(39)
187: !        write (99,99002) idate1d(2)
188: !        write (99,99003) idate1d(2)
189: !        write (99,99004) idate2
190: !        a78 = '2,              ! iotype: 1=I*2 NetCDF;'//               &
191: !             &' 2=r*4 NetCDF; 3=grads; 4=vis5d'
192: !        write (99,99008) a78
193: !        a78 = '.false.,        ! Write out header?'
194: !        write (99,99008) a78
195: !        a78 = '.false.,        ! Write out all RegCM data b/twn'//      &
196: !             &' idate1 & idate2?'
197: !        write (99,99008) a78
198: !        a78 = '.false.,        ! Average RegCM data b/twn idate1'//     &
199: !             &' & idate2?'
200: !        write (99,99008) a78
201: !        a78 = '.false.,        ! Diurnali avg of RegCM data b/twn'//    &
202: !             &' idate1 & idate2?'
203: !        write (99,99008) a78
204: !        a78 = '.true.,         ! Continually average ATM data b/twn'//  &
205: !             &' idate1 & idate2?'
206: !        write (99,99008) a78
207: !        a78 = '-1.,            ! No. Days for continual averaging'//    &
208: !             &' (-1=monthly;1=daily;5=5day)'
209: !        write (99,99008) a78
210: !        if ( nmo.le.1 ) then
211: !          iyr1 = iyr(nmo)*100 + imo(nmo)
212: !          write (a16,99005) a1 , iyr1 , a1
213: !        else if ( nmo.le.2 ) then
214: !          iyr1 = iyr(nmo)*100 + imo(nmo)
215: !          write (a16,99005) a1 , iyr1 , a1
216: !        else
217: !          iyr1 = iyr(2)*100 + imo(2)
218: !          iyr2 = iyr(nmo)*100 + imo(nmo)
219: !          write (a16,99006) a1 , iyr1 , iyr2 , a1
220: !        end if
221: !        a78 = a16//'! postproc output filename (not'//                  &
222: !             &' including type & ext)'
223: !        write (99,99008) a78
224: ! 
225: !        a78 = a1//'../Input'//a1//',     ! ICBC directory'
226: !        write (99,99008) a78
227: !        a78 = a1//trim(dirout)/a1//',    ! RegCM Output directory'
228: !        write (99,99008) a78
229: !        a78 = a1//'DOMAIN.INFO'//a1//                                   &
230: !             &',  ! Domain Info Filename (from terrain)'
231: !        write (99,99008) a78
232: !        a78 = a1//'OUT_HEAD'//a1//                                      &
233: !             &',     ! Header File name (from RegCM)'
234: !        write (99,99008) a78
235: !        if ( nmo.le.1 ) then
236: !          a2 = 'st'
237: !          write (a22,99007) a1 , idate1d(1) , a1 , nmo , a2
238: !          a78 = a22//' RegCM Output File Extension'
239: !          write (99,99008) a78
240: !        else
241: !          do n = 2 , nmo
242: !            if ( n.eq.2 ) then
243: !              a2 = 'st'
244: !            else if ( n.eq.3 ) then
245: !              a2 = 'nd'
246: !            else if ( n.eq.4 ) then
247: !              a2 = 'rd'
248: !            else
249: !              a2 = 'th'
250: !            end if
251: !            write (a22,99007) a1 , idate1d(n) , a1 , n - 1 , a2
252: !            a78 = a22//'RegCM Output File Extension'
253: !            write (99,99008) a78
254: !          end do
255: !        end if
256: !        close (98)
257: !        close (99)
258: ! 
259: !        filnam = '../PostProc/postproc.param'
260: !        open (99,file=filnam,form='FORMATTED',status='replace')
261: !        dto = tapfrq
262: !        dtb = batfrq
263: !        dtr = radisp
264: !        dtc = chemfrq
265: !        a78 = 'cccc SET DOMAIN DIMENSIONS'
266: !        write (99,99008) a78
267: !        a78 = 'cccc ny = number of north-south points'
268: !        write (99,99008) a78
269: !        a78 = 'cccc nx = number of east-west points'
270: !        write (99,99008) a78
271: !        a78 = 'cccc nz = number of vertical levels'
272: !        write (99,99008) a78
273: !        a78 = 'cccc SET MODEL OUTPUT INTERVALS'
274: !        write (99,99008) a78
275: !        a78 = 'cccc dtbc = ibdyfrq = ICBC output interval (hrs)'
276: !        write (99,99008) a78
277: !        a78 = 'cccc dtout = atmfrq = atmospheric output interval (hrs)'
278: !        write (99,99008) a78
279: !        a78 = 'cccc dtbat = srffrq = surface output interval (hrs)'
280: !        write (99,99008) a78
281: !        a78 = 'cccc dtrad = radfrq = radiation output interval (hrs)'
282: !        write (99,99008) a78
283: !        a78 = 'cccc DIRECT ACCESS BINARY SPECIFICATION'
284: !        write (99,99008) a78
285: !        a78 = 'cccc ibyte = 4 for PGI, IFC; 1 for SUN, SGI, DEC, IBM'
286: !        write (99,99008) a78
287: !        a78 = '      integer nxf,nyf,nz,nxs,nys'
288: !        write (99,99008) a78
289: !        write (a78,99009) iy
290: !        write (99,99008) a78
291: !        write (a78,99010) jx
292: !        write (99,99008) a78
293: !        write (a78,99011) kz
294: !        write (99,99008) a78
295: !        write (a78,99012) 1
296: !                         ! nxs when SUBBATS si in
297: !        write (99,99008) a78
298: !        write (a78,99013) 1
299: !                         ! nys when SUBBATS si in
300: !        write (99,99008) a78
301: !        a78 = '      integer ibyte'
302: !        write (99,99008) a78
303: !        write (a78,99014) ibyte
304: !        write (99,99008) a78
305: !        a78 = '      real dtbc,dtout,dtbat,dtrad,dtche,dtsub'
306: !        write (99,99008) a78
307: !        write (a78,99015) ibdyfrq
308: !        write (99,99008) a78
309: !        write (a78,99016) dto
310: !        write (99,99008) a78
311: !        write (a78,99017) dtb
312: !        write (99,99008) a78
313: !        write (a78,99018) dtr
314: !        write (99,99008) a78
315: !        write (a78,99019) dtc
316: !        write (99,99008) a78
317: !        write (a78,99020) dtb
318: !        write (99,99008) a78
319: !        close (99)
320:       end if
321:  
322: 99001 format (a3,'.',i10)
323: !99002 format (i10,',     ! idate0 = First date in File (yymmddhh)')
324: !99003 format (i10,                                                      &
325: !             &',     ! idate1 = Start date for averaging and re-writing'&
326: !            & )
327: !99004 format (i10,                                                      &
328: !             &',     ! idate2 = End date for averaging and re-writing')
329: !99005 format (a1,i6,a1,',')
330: !99006 format (a1,i6,'_',i6,a1,',')
331: !99007 format (a1,i10,a1,',   !',i3,a2)
332:  
333: !99008 format (a78)
334: !99009 format ('      parameter (nyf =',i4,')')
335: !99010 format ('      parameter (nxf =',i4,')')
336: !99011 format ('      parameter (nz  =',i4,')')
337: !99012 format ('      parameter (nxs =',i4,')')
338: !99013 format ('      parameter (nys =',i4,')')
339: !99014 format ('      parameter (ibyte =',i4,')')
340: !99015 format ('      parameter (dtbc  =',i7,'.00)')
341: !99016 format ('      parameter (dtout =',f10.2,')')
342: !99017 format ('      parameter (dtbat =',f10.2,')')
343: !99018 format ('      parameter (dtrad =',f10.2,')')
344: !99019 format ('      parameter (dtche =',f10.2,')')
345: !99020 format ('      parameter (dtsub =',f10.2,')')
346:  
347:       end subroutine mkfile
</PRE>

<HR>

</BODY>
</HTML>

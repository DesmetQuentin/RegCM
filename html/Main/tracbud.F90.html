<HTML>

<HEAD>
<TITLE>tracbud.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>tracbud.F90</H1>
<HR>
<H2 ALIGN=CENTER>tracbud.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=tracbud><H3>tracbud</H3></a></p> Click <a href="./callingtree/tracbud_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where tracbud is used.
<hr>
20:       subroutine tracbud
21: !cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
22:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
23:       use <a href="./mod_param1.f90.html#mod_param1" TARGET=CENT_PANEL>mod_param1</a>
24:       use <a href="./mod_param2.F90.html#mod_param2" TARGET=CENT_PANEL>mod_param2</a>
25:       use <a href="./mod_param3.f90.html#mod_param3" TARGET=CENT_PANEL>mod_param3</a> , only : dsigma
26:       use <a href="./mod_main.F90.html#mod_main" TARGET=CENT_PANEL>mod_main</a>
27:       use <a href="./mod_mainchem.F90.html#mod_mainchem" TARGET=CENT_PANEL>mod_mainchem</a>
28:       use <a href="./mod_trachem.F90.html#mod_trachem" TARGET=CENT_PANEL>mod_trachem</a>
29:       use <a href="./mod_date.F90.html#mod_date" TARGET=CENT_PANEL>mod_date</a>
30:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rgti
31: #ifdef DIAG
32:       use <a href="./mod_diagnosis.f90.html#mod_diagnosis" TARGET=CENT_PANEL>mod_diagnosis</a>
33: #endif
34: #ifdef MPP1
35:       use <a href="./mod_mppio.F90.html#mod_mppio" TARGET=CENT_PANEL>mod_mppio</a>
36: #ifndef IBM
37:       use <a href="#" TARGET=CENT_PANEL>mpi</a>
38: #else 
39:       include 'mpif.h'
40: #endif 
41: #endif
42:       implicit none
43: !
44: ! Local variables
45: !
46:       integer :: i , itr , j , k
47: #ifdef DIAG
48: #ifdef MPP1
49:       integer :: ierr , l
50: #endif
51:       real(8) :: tttmp
52: #endif
53: !
54: !---- add tracers,  tremlsc, tremcvc, tremdrd are total amount mass
55: !     and chemical conversion term
56: !     removed by large scale, convective precipation and dry deposition
57: !     respectively
58:  
59:       do itr = 1 , ntr
60: !
61: #ifdef DIAG
62:         ttrace(itr,1) = 0.
63:         tremlsc(itr,1) = 0.
64:         tremcvc(itr,1) = 0.
65:         trxsg(itr,1) = 0.
66:         trxsaq1(itr,1) = 0.
67:         trxsaq2(itr,1) = 0.
68:         tremdrd(itr,1) = 0.
69: #endif
70: !
71: #ifdef MPP1
72:         do j = 1 , jendx
73: #else
74:         do j = 1 , jxm1
75: #endif
76:           do i = 1 , iym1
77:             dtrace(i,j,itr) = 0.0
78:             wdlsc(i,j,itr) = 0.0
79:             wdcvc(i,j,itr) = 0.0
80:             wxsg(i,j,itr) = 0.0
81:             wxaq(i,j,itr) = 0.0
82:             ddsfc(i,j,itr) = 0.0
83:           end do
84:         end do
85:       end do
86:  
87:  
88: !-----tracers (unit = kg):
89:       do itr = 1 , ntr
90: #ifdef MPP1
91:         do j = 1 , jendx
92: #else
93:         do j = 1 , jxm1
94: #endif
95:           do i = 1 , iym1
96:             do k = 1 , kz
97:               dtrace(i,j,itr) = dtrace(i,j,itr) + chia(i,k,j,itr)       &
98:                               & *dsigma(k)
99:               wdlsc(i,j,itr) = wdlsc(i,j,itr) + remlsc(i,k,j,itr)       &
100:                              & *dsigma(k)
101:               wdcvc(i,j,itr) = wdcvc(i,j,itr) + remcvc(i,k,j,itr)       &
102:                              & *dsigma(k)
103:               wxsg(i,j,itr) = wxsg(i,j,itr) + rxsg(i,k,j,itr)*dsigma(k)
104: !             sum ls and conv contribution
105:               wxaq(i,j,itr) = wxaq(i,j,itr)                             &
106:                             & + (rxsaq1(i,k,j,itr)+rxsaq2(i,k,j,itr))   &
107:                             & *dsigma(k)
108:             end do
109:             ddsfc(i,j,itr) = ddsfc(i,j,itr) + remdrd(i,j,itr)*dsigma(kz)
110: !           Source cumulated diag(care the unit are alredy .m-2)
111:             cemtrac(i,j,itr) = cemtr(i,j,itr)
112:           end do
113:         end do
114:       end do
115:  
116: #ifdef DIAG
117: #ifdef MPP1
118:       do itr = 1 , ntr
119:         call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(chia(1,1,1,itr),   iy*kz*jxp,mpi_real8,         &
120:                       & chia_io(1,1,1,itr),iy*kz*jxp,mpi_real8,         &
121:                       & 0,mpi_comm_world,ierr)
122:         call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(remlsc(1,1,1,itr),   iy*kz*jxp,mpi_real8,       &
123:                       & remlsc_io(1,1,1,itr),iy*kz*jxp,mpi_real8,       &
124:                       & 0,mpi_comm_world,ierr)
125:         call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(remcvc(1,1,1,itr),   iy*kz*jxp,mpi_real8,       &
126:                       & remcvc_io(1,1,1,itr),iy*kz*jxp,mpi_real8,       &
127:                       & 0,mpi_comm_world,ierr)
128:         call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(rxsg(1,1,1,itr),   iy*kz*jxp,mpi_real8,         &
129:                       & rxsg_io(1,1,1,itr),iy*kz*jxp,mpi_real8,         &
130:                       & 0,mpi_comm_world,ierr)
131:         call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(rxsaq1(1,1,1,itr),   iy*kz*jxp,mpi_real8,       &
132:                       & rxsaq1_io(1,1,1,itr),iy*kz*jxp,mpi_real8,       &
133:                       & 0,mpi_comm_world,ierr)
134:         call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(rxsaq2(1,1,1,itr),   iy*kz*jxp,mpi_real8,       &
135:                       & rxsaq2_io(1,1,1,itr),iy*kz*jxp,mpi_real8,       &
136:                       & 0,mpi_comm_world,ierr)
137:         call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(remdrd(1,1,itr),   iy*jxp,mpi_real8,            &
138:                       & remdrd_io(1,1,itr),iy*jxp,mpi_real8,            &
139:                       & 0,mpi_comm_world,ierr)
140:         do l = 1 , 12
141:           call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(chemsrc(1,1,l,itr),   iy*jxp,mpi_real8,       &
142:                         & chemsrc_io(1,1,l,itr),iy*jxp,mpi_real8,       &
143:                         & 0,mpi_comm_world,ierr)
144:         end do
145:       end do
146:       if ( myid.eq.0 ) then
147:         do itr = 1 , ntr
148:           do k = 1 , kz
149:             tttmp = 0.
150:             do j = 2 , jxm2
151:               do i = 2 , iym2
152:                 tttmp = tttmp + chia_io(i,k,j,itr)
153:               end do
154:             end do
155:             ttrace(itr,1) = ttrace(itr,1) + tttmp*dsigma(k)
156:             tttmp = 0.
157:             do j = 2 , jxm2
158:               do i = 2 , iym2
159:                 tttmp = tttmp + remlsc_io(i,k,j,itr)
160:               end do
161:             end do
162:             tremlsc(itr,1) = tremlsc(itr,1) + tttmp*dsigma(k)
163:             tttmp = 0.
164:             do j = 2 , jxm2
165:               do i = 2 , iym2
166:                 tttmp = tttmp + remcvc_io(i,k,j,itr)
167:               end do
168:             end do
169:             tremcvc(itr,1) = tremcvc(itr,1) + tttmp*dsigma(k)
170:             tttmp = 0.
171:             do j = 2 , jxm2
172:               do i = 2 , iym2
173:                 tttmp = tttmp + rxsg_io(i,k,j,itr)
174:               end do
175:             end do
176:             trxsg(itr,1) = trxsg(itr,1) + tttmp*dsigma(k)
177:             tttmp = 0.
178:             do j = 2 , jxm2
179:               do i = 2 , iym2
180:                 tttmp = tttmp + rxsaq1_io(i,k,j,itr)
181:               end do
182:             end do
183:             trxsaq1(itr,1) = trxsaq1(itr,1) + tttmp*dsigma(k)
184:             tttmp = 0.
185:             do j = 2 , jxm2
186:               do i = 2 , iym2
187:                 tttmp = tttmp + rxsaq2_io(i,k,j,itr)
188:               end do
189:             end do
190:             trxsaq2(itr,1) = trxsaq2(itr,1) + tttmp*dsigma(k)
191:           end do
192:         end do
193:  
194:         do itr = 1 , ntr
195:           ttrace(itr,1) = ttrace(itr,1)*dx*dx
196:           tremlsc(itr,1) = tremlsc(itr,1)*dx*dx
197:           tremcvc(itr,1) = tremcvc(itr,1)*dx*dx
198:           trxsg(itr,1) = trxsg(itr,1)*dx*dx
199:           trxsaq1(itr,1) = trxsaq1(itr,1)*dx*dx
200:           trxsaq2(itr,1) = trxsaq2(itr,1)*dx*dx
201:         end do
202:  
203:         do itr = 1 , ntr
204:           tttmp = 0.
205:           do j = 2 , jxm2
206:             do i = 2 , iym2
207:               tttmp = tttmp + remdrd_io(i,j,itr)
208:             end do
209:           end do
210:           tremdrd(itr,1) = tremdrd(itr,1) + tttmp*dx*dx*dsigma(kz)
211:  
212: !         emissions
213:           tttmp = 0.
214:           do j = 2 , jxm2
215:             do i = 2 , iym2
216:               tttmp = tttmp + chemsrc_io(i,j,lmonth,itr)*dtmin*60.*dx*dx
217:             end do
218:           end do
219:           tchie(itr) = tchie(itr) + tttmp
220:         end do
221:       end if
222:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(ttrace(1,1),ntr,mpi_real8,0,mpi_comm_world,ierr)
223:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tremlsc(1,1),ntr,mpi_real8,0,mpi_comm_world,ierr)
224:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tremcvc(1,1),ntr,mpi_real8,0,mpi_comm_world,ierr)
225:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(trxsg(1,1),ntr,mpi_real8,0,mpi_comm_world,ierr)
226:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(trxsaq1(1,1),ntr,mpi_real8,0,mpi_comm_world,ierr)
227:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(trxsaq2(1,1),ntr,mpi_real8,0,mpi_comm_world,ierr)
228:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tremdrd(1,1),ntr,mpi_real8,0,mpi_comm_world,ierr)
229:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tchie(1),ntr,mpi_real8,0,mpi_comm_world,ierr)
230: #else
231:       do itr = 1 , ntr
232:         do k = 1 , kz
233:           tttmp = 0.
234:           do j = 2 , jxm2
235:             do i = 2 , iym2
236:               tttmp = tttmp + chia(i,k,j,itr)
237:             end do
238:           end do
239:           ttrace(itr,1) = ttrace(itr,1) + tttmp*dsigma(k)
240:           tttmp = 0.
241:           do j = 2 , jxm2
242:             do i = 2 , iym2
243:               tttmp = tttmp + remlsc(i,k,j,itr)
244:             end do
245:           end do
246:           tremlsc(itr,1) = tremlsc(itr,1) + tttmp*dsigma(k)
247:           tttmp = 0.
248:           do j = 2 , jxm2
249:             do i = 2 , iym2
250:               tttmp = tttmp + remcvc(i,k,j,itr)
251:             end do
252:           end do
253:           tremcvc(itr,1) = tremcvc(itr,1) + tttmp*dsigma(k)
254:           tttmp = 0.
255:           do j = 2 , jxm2
256:             do i = 2 , iym2
257:               tttmp = tttmp + rxsg(i,k,j,itr)
258:             end do
259:           end do
260:           trxsg(itr,1) = trxsg(itr,1) + tttmp*dsigma(k)
261:           tttmp = 0.
262:           do j = 2 , jxm2
263:             do i = 2 , iym2
264:               tttmp = tttmp + rxsaq1(i,k,j,itr)
265:             end do
266:           end do
267:           trxsaq1(itr,1) = trxsaq1(itr,1) + tttmp*dsigma(k)
268:           tttmp = 0.
269:           do j = 2 , jxm2
270:             do i = 2 , iym2
271:               tttmp = tttmp + rxsaq2(i,k,j,itr)
272:             end do
273:           end do
274:           trxsaq2(itr,1) = trxsaq2(itr,1) + tttmp*dsigma(k)
275:         end do
276:       end do
277: 
278:       do itr = 1 , ntr
279:         ttrace(itr,1) = ttrace(itr,1)*dx*dx
280:         tremlsc(itr,1) = tremlsc(itr,1)*dx*dx
281:         tremcvc(itr,1) = tremcvc(itr,1)*dx*dx
282:         trxsg(itr,1) = trxsg(itr,1)*dx*dx
283:         trxsaq1(itr,1) = trxsaq1(itr,1)*dx*dx
284:         trxsaq2(itr,1) = trxsaq2(itr,1)*dx*dx
285:       end do
286: 
287:       do itr = 1 , ntr
288:         tttmp = 0.
289:         do j = 2 , jxm2
290:           do i = 2 , iym2
291:             tttmp = tttmp + remdrd(i,j,itr)
292:           end do
293:         end do
294:         tremdrd(itr,1) = tremdrd(itr,1) + tttmp*dx*dx*dsigma(kz)
295: 
296: !       emissions
297:         tttmp = 0.
298:         do j = 2 , jxm2
299:           do i = 2 , iym2
300:             tttmp = tttmp + chemsrc(i,j,lmonth,itr)*dtmin*60.*dx*dx
301:           end do
302:         end do
303:         tchie(itr) = tchie(itr) + tttmp
304:       end do
305: #endif
306: #endif
307:  
308:       do itr = 1 , ntr
309: #ifdef DIAG
310:         ttrace(itr,1) = ttrace(itr,1)*1000.*rgti
311:         tremlsc(itr,1) = tremlsc(itr,1)*1000.*rgti
312:         tremcvc(itr,1) = tremcvc(itr,1)*1000.*rgti
313:         tremdrd(itr,1) = tremdrd(itr,1)*1000.*rgti
314:         trxsg(itr,1) = trxsg(itr,1)*1000.*rgti
315:         trxsaq1(itr,1) = trxsaq1(itr,1)*1000.*rgti
316:         trxsaq2(itr,1) = trxsaq2(itr,1)*1000.*rgti
317: #endif
318: !
319: #ifdef MPP1
320:         do j = 1 , jendx
321: #else
322:         do j = 1 , jxm1
323: #endif
324:           do i = 1 , iym1
325:             dtrace(i,j,itr) = 1.E6*dtrace(i,j,itr)*1000.*rgti
326:                                                         ! unit: mg/m2
327:             wdlsc(i,j,itr) = 1.E6*wdlsc(i,j,itr)*1000.*rgti
328:             wdcvc(i,j,itr) = 1.E6*wdcvc(i,j,itr)*1000.*rgti
329:             ddsfc(i,j,itr) = 1.E6*ddsfc(i,j,itr)*1000.*rgti
330:             wxsg(i,j,itr) = 1.E6*wxsg(i,j,itr)*1000.*rgti
331:             wxaq(i,j,itr) = 1.E6*wxaq(i,j,itr)*1000.*rgti
332: !           emtrac isbuilt from chsurfem so just need the 1e6*dt/2
333: !           factor to to pass im mg/m2
334:             cemtrac(i,j,itr) = 1.E6*cemtrac(i,j,itr)
335:           end do
336:         end do
337:       end do
338: 
339:  
340: !-----print out the information:
341: #ifdef DIAG
342: #ifdef MPP1
343:       if ( myid.eq.0 ) then
344:  
345:         if ( ifprt .and. mod(ntime,nprtfrq).eq.0 ) then
346:  
347: !----     tracers
348:  
349:           print * , '************************************************'
350:           print * , ' Budgets for tracers (intergrated quantitites)'
351:           print * , ' day = ' , ldatez , ' *****'
352:           print * , '************************************************'
353:  
354:           do itr = 1 , ntr
355:  
356: !           errort= ttrace(itr,1)-
357: !           &     (tchie(itr) - (tchiad(itr)-tchitb(itr)+
358: !           &     tremdrd(itr,1)+ tremlsc(itr,1)+tremcvc(itr,1)))
359:  
360:             print * , '****************************'
361:             print 99001 , itr , tchie(itr)
362:             print 99002 , itr , tchiad(itr)
363:             print 99003 , itr , tchitb(itr)
364:             print 99004 , itr , tremdrd(itr,1)
365:             print 99005 , itr , tremlsc(itr,1)
366:             print 99006 , itr , tremcvc(itr,1)
367:             print 99007 , itr , ttrace(itr,1)
368: !           print 99008 , itr , errort
369:  
370:           end do
371:  
372:         end if
373:       end if
374: #else
375:       if ( ifprt .and. mod(ntime,nprtfrq).eq.0 ) then
376: 
377: !----   tracers
378: 
379:         print * , '************************************************'
380:         print * , ' Budgets for tracers (intergrated quantitites)'
381:         print * , ' day = ' , ldatez , ' *****'
382:         print * , '************************************************'
383: 
384:         do itr = 1 , ntr
385: 
386: !         errort= ttrace(itr,1)-
387: !         &     (tchie(itr) - (tchiad(itr)-tchitb(itr)+
388: !         &     tremdrd(itr,1)+ tremlsc(itr,1)+tremcvc(itr,1)))
389: 
390:           print * , '****************************'
391:           print 99001 , itr , tchie(itr)
392:           print 99002 , itr , tchiad(itr)
393:           print 99003 , itr , tchitb(itr)
394:           print 99004 , itr , tremdrd(itr,1)
395:           print 99005 , itr , tremlsc(itr,1)
396:           print 99006 , itr , tremcvc(itr,1)
397:           print 99007 , itr , ttrace(itr,1)
398: !         print 99008 , itr , errort
399:         end do
400:       end if
401: #endif
402:  
403: 99001       format ('total emission tracer',i1,':',e12.5,' kg')
404: 99002       format ('total advected tracer',i1,':',e12.5,' kg')
405: 99003       format ('total diffused tracer',i1,':',e12.5,' kg')
406: 99004       format ('total dry deposition tracer',i1,':',e12.5,' kg')
407: 99005       format ('total large scale wet dep.tracer',i1,':',e12.5,    &
408:                    &' kg')
409: 99006       format ('total convective wet dep.tracer',i1,':',e12.5,     &
410:                   & ' kg')
411: 99007       format ('total mass (at ktau), tracer',i1,':',e12.5,' kg')
412: !99008       format('error trac',I1,':',e12.5,' % ')
413: #endif
414: 
415:       end subroutine tracbud
</PRE>

<HR>

</BODY>
</HTML>

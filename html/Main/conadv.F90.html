<HTML>

<HEAD>
<TITLE>conadv.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>conadv.F90</H1>
<HR>
<H2 ALIGN=CENTER>conadv.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=conadv><H3>conadv</H3></a></p> Click <a href="./callingtree/conadv_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where conadv is used.
<hr>
20:       subroutine conadv
21: 
22: !cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
23: !                                                                     c
24: !     this subroutine computes the amounts of dry air and water       c
25: !     substance advected through the lateral boundaries.              c
26: !                                                                     c
27: !     ---the unit from advection is converted to "kg".                c
28: !                                                                     c
29: !cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
30: 
31:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
32:       use <a href="./mod_param1.f90.html#mod_param1" TARGET=CENT_PANEL>mod_param1</a>
33:       use <a href="./mod_param3.f90.html#mod_param3" TARGET=CENT_PANEL>mod_param3</a> , only : dsigma
34:       use <a href="./mod_diagnosis.f90.html#mod_diagnosis" TARGET=CENT_PANEL>mod_diagnosis</a>
35:       use <a href="./mod_main.F90.html#mod_main" TARGET=CENT_PANEL>mod_main</a>
36:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rgti
37: #ifdef MPP1
38:       use <a href="./mod_mppio.F90.html#mod_mppio" TARGET=CENT_PANEL>mod_mppio</a>
39: #ifndef IBM
40:       use <a href="#" TARGET=CENT_PANEL>mpi</a>
41: #else 
42:       include 'mpif.h'
43: #endif 
44: #endif
45:       implicit none
46: !
47: ! Local variables
48: !
49: #ifdef MPP1
50:       integer :: ierr
51:       real(8) , dimension(jxp) :: psa01 , psailx
52:       real(8) , dimension(jx) :: psa01_g , psailx_g
53:       real(8) , dimension(kz,jxp) :: qca01 , qcailx , qva01 , qvailx ,  &
54:                                    & va01 , vaix
55:       real(8) , dimension(kz,jx) :: qca01_g , qcailx_g , qva01_g ,      &
56:                                    & qvailx_g , va01_g , vaix_g
57: #endif
58:       real(8) , dimension(iym1,kz) :: worka , workb
59:       integer :: i ,  j , k
60: !
61: !----------------------------------------------------------------------
62: !-----advection of dry air through the lateral boundaries:
63: !
64: !.....advection through east-west boundaries:
65: !
66: #ifdef MPP1
67:       if ( myid.eq.nproc-1 ) then
68:         do k = 1 , kz
69:           do i = 1 , iym1
70:             worka(i,k) = (ua(i+1,k,jendl)+ua(i,k,jendl))                &
71:                        & /(msfx(i,jendx)*msfx(i,jendx))
72:           end do
73:         end do
74:       end if
75:       if ( myid.eq.0 ) then
76:         do k = 1 , kz
77:           do i = 1 , iym1
78:             workb(i,k) = (ua(i+1,k,1)+ua(i,k,1))/(msfx(i,1)*msfx(i,1))
79:           end do
80:         end do
81:       end if
82:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(worka,iym1*kz,mpi_real8,nproc-1,                   &
83:                    & mpi_comm_world,ierr)
84:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(workb,iym1*kz,mpi_real8,0,                         &
85:                    & mpi_comm_world,ierr)
86: #else
87:       do k = 1 , kz
88:         do i = 1 , iym1
89:           worka(i,k) = (ua(i+1,k,jx)+ua(i,k,jx))                        &
90:                      & /(msfx(i,jxm1)*msfx(i,jxm1))
91:           workb(i,k) = (ua(i+1,k,1)+ua(i,k,1))/(msfx(i,1)*msfx(i,1))
92:         end do
93:       end do
94: #endif
95:       do k = 1 , kz
96:         do i = 1 , iym1
97:           tdadv = tdadv - dtmin*3.E4*dsigma(k)                          &
98:                 & *dx*(worka(i,k)-workb(i,k))*rgti
99:         end do
100:       end do
101: !
102: !.....advection through north-south boundaries:
103: !
104: #ifdef MPP1
105:       do j = 1 , jendl
106:         do k = 1 , kz
107:           vaix(k,j) = va(iy,k,j)
108:           va01(k,j) = va(1,k,j)
109:         end do
110:       end do
111:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(vaix(1,1),  kz*jxp,mpi_real8,                     &
112:                     & vaix_g(1,1),kz*jxp,mpi_real8,                     &
113:                     & 0,mpi_comm_world,ierr)
114:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(va01(1,1),  kz*jxp,mpi_real8,                     &
115:                     & va01_g(1,1),kz*jxp,mpi_real8,                     &
116:                     & 0,mpi_comm_world,ierr)
117:       if ( myid.eq.0 ) then
118:         do k = 1 , kz
119:           do j = 1 , jxm1
120:             tdadv = tdadv - dtmin*3.E4*dsigma(k)                        &
121:                   & *dx*((vaix_g(k,j+1)+vaix_g(k,j))                    &
122:                   & /(msfx_io(iym1,j)*msfx_io(iym1,j))                  &
123:                   & -(va01_g(k,j+1)+va01_g(k,j))                        &
124:                   & /(msfx_io(1,j)*msfx_io(1,j)))*rgti
125:           end do
126:         end do
127:       end if
128:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tdadv,1,mpi_real8,0,mpi_comm_world,ierr)
129: #else
130:       do k = 1 , kz
131:         do j = 1 , jxm1
132:           tdadv = tdadv - dtmin*3.E4*dsigma(k)                          &
133:                 & *dx*((va(iy,k,j+1)+va(iy,k,j))                        &
134:                 & /(msfx(iym1,j)*msfx(iym1,j))-(va(1,k,j+1)+va(1,k,j))  &
135:                 & /(msfx(1,j)*msfx(1,j)))*rgti
136:         end do
137:       end do
138: #endif
139: !
140: !----------------------------------------------------------------------
141: !-----advection of water vapor through the lateral boundaries:
142: !
143: !.....advection through east-west boundaries:
144: !
145: #ifdef MPP1
146:       if ( myid.eq.nproc-1 ) then
147:         do k = 1 , kz
148:           do i = 1 , iym1
149:             worka(i,k) = (ua(i+1,k,jendl)+ua(i,k,jendl))                &
150:                        & *(qva(i,k,jendx)/psa(i,jendx))                 &
151:                        & /(msfx(i,jendx)*msfx(i,jendx))
152:           end do
153:         end do
154:       end if
155:       if ( myid.eq.0 ) then
156:         do k = 1 , kz
157:           do i = 1 , iym1
158:             workb(i,k) = (ua(i+1,k,1)+ua(i,k,1))*(qva(i,k,1)/psa(i,1))  &
159:                        & /(msfx(i,1)*msfx(i,1))
160:           end do
161:         end do
162:       end if
163:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(worka,iym1*kz,mpi_real8,nproc-1,                   &
164:                    & mpi_comm_world,ierr)
165:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(workb,iym1*kz,mpi_real8,0,                         &
166:                    & mpi_comm_world,ierr)
167: #else
168:       do k = 1 , kz
169:         do i = 1 , iym1
170:           worka(i,k) = (ua(i+1,k,jx)+ua(i,k,jx))                        &
171:                      & *(qva(i,k,jxm1)/psa(i,jxm1))                     &
172:                      & /(msfx(i,jxm1)*msfx(i,jxm1))
173:           workb(i,k) = (ua(i+1,k,1)+ua(i,k,1))*(qva(i,k,1)/psa(i,1))    &
174:                      & /(msfx(i,1)*msfx(i,1))
175:         end do
176:       end do
177: #endif
178:       do k = 1 , kz
179:         do i = 1 , iym1
180:           tqadv = tqadv - dtmin*3.E4*dsigma(k)                          &
181:                 & *dx*(worka(i,k)-workb(i,k))*rgti
182:         end do
183:       end do
184: !
185: !....advection through north-south boundaries:
186: !
187: #ifdef MPP1
188:       do j = 1 , jendl
189:         do k = 1 , kz
190:           qvailx(k,j) = qva(iym1,k,j)
191:           qva01(k,j) = qva(1,k,j)
192:         end do
193:         psailx(j) = psa(iym1,j)
194:         psa01(j) = psa(1,j)
195:       end do
196:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(qvailx(1,1),  kz*jxp,mpi_real8,                   &
197:                     & qvailx_g(1,1),kz*jxp,mpi_real8,                   &
198:                     & 0,mpi_comm_world,ierr)
199:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(qva01(1,1),  kz*jxp,mpi_real8,                    &
200:                     & qva01_g(1,1),kz*jxp,mpi_real8,                    &
201:                     & 0,mpi_comm_world,ierr)
202:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(psailx(1),  jxp,mpi_real8,                        &
203:                     & psailx_g(1),jxp,mpi_real8,0,mpi_comm_world,ierr)
204:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(psa01(1),  jxp,mpi_real8,                         &
205:                       psa01_g(1),jxp,mpi_real8,0,mpi_comm_world,ierr)
206:       if ( myid.eq.0 ) then
207:         do k = 1 , kz
208:           do j = 1 , jxm1
209:             tqadv = tqadv - dtmin*3.E4*dsigma(k)                        &
210:                   & *dx*((vaix_g(k,j+1)+vaix_g(k,j))                    &
211:                   & *(qvailx_g(k,j)/psailx_g(j))                        &
212:                   & /(msfx_io(iym1,j)*msfx_io(iym1,j))                  &
213:                   & -(va01_g(k,j+1)+va01_g(k,j))                        &
214:                   & *(qva01_g(k,j)/psa01_g(j))                          &
215:                   & /(msfx_io(1,j)*msfx_io(1,j)))*rgti
216:           end do
217:         end do
218:       end if
219:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tqadv,1,mpi_real8,0,mpi_comm_world,ierr)
220: #else
221:       do k = 1 , kz
222:         do j = 1 , jxm1
223:           tqadv = tqadv - dtmin*3.E4*dsigma(k)                          &
224:                 & *dx*((va(iy,k,j+1)+va(iy,k,j))                        &
225:                 & *(qva(iym1,k,j)/psa(iym1,j))/(msfx(iym1,j)            &
226:                 & *msfx(iym1,j))-(va(1,k,j+1)+va(1,k,j))                &
227:                 & *(qva(1,k,j)/psa(1,j))/(msfx(1,j)*msfx(1,j)))*rgti
228:         end do
229:       end do
230: #endif
231: !
232: !-----advection of cloud water and rainwater through lateral boundaries:
233: !
234: !.....advection through east-west boundaries:
235: !
236: #ifdef MPP1
237:       if ( myid.eq.nproc-1 ) then
238:         do k = 1 , kz
239:           do i = 1 , iym1
240:             worka(i,k) = (ua(i+1,k,jendl)+ua(i,k,jendl))                &
241:                        & *(qca(i,k,jendx)/psa(i,jendx))                 &
242:                        & /(msfx(i,jendx)*msfx(i,jendx))
243:           end do
244:         end do
245:       end if
246:       if ( myid.eq.0 ) then
247:         do k = 1 , kz
248:           do i = 1 , iym1
249:             workb(i,k) = (ua(i+1,k,1)+ua(i,k,1))*(qca(i,k,1)/psa(i,1))  &
250:                        & /(msfx(i,1)*msfx(i,1))
251:           end do
252:         end do
253:       end if
254:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(worka,iym1*kz,mpi_real8,nproc-1,                   &
255:                    & mpi_comm_world,ierr)
256:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(workb,iym1*kz,mpi_real8,0,                         &
257:                    & mpi_comm_world,ierr)
258: #else
259:       do k = 1 , kz
260:         do i = 1 , iym1
261:           worka(i,k) = (ua(i+1,k,jx)+ua(i,k,jx))                        &
262:                      & *(qca(i,k,jxm1)/psa(i,jxm1))                     &
263:                      & /(msfx(i,jxm1)*msfx(i,jxm1))
264:           workb(i,k) = (ua(i+1,k,1)+ua(i,k,1))*(qca(i,k,1)/psa(i,1))    &
265:                      & /(msfx(i,1)*msfx(i,1))
266:         end do
267:       end do
268: #endif
269:       do k = 1 , kz
270:         do i = 1 , iym1
271:           tqadv = tqadv - dtmin*3.E4*dsigma(k)                          &
272:                 & *dx*(worka(i,k)-workb(i,k))*rgti
273:         end do
274:       end do
275: !
276: !....advection through north-south boundaries:
277: !
278: #ifdef MPP1
279:       do j = 1 , jendl
280:         do k = 1 , kz
281:           qcailx(k,j) = qca(iym1,k,j)
282:           qca01(k,j) = qca(1,k,j)
283:         end do
284:       end do
285:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(qcailx(1,1),  kz*jxp,mpi_real8,                   &
286:                     & qcailx_g(1,1),kz*jxp,mpi_real8,                   &
287:                     & 0,mpi_comm_world,ierr)
288:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(qca01(1,1),  kz*jxp,mpi_real8,                    &
289:                     & qca01_g(1,1),kz*jxp,mpi_real8,                    &
290:                     & 0,mpi_comm_world,ierr)
291:       if ( myid.eq.0 ) then
292:         do k = 1 , kz
293:           do j = 1 , jxm1
294:             tqadv = tqadv - dtmin*3.E4*dsigma(k)                        &
295:                   & *dx*((vaix_g(k,j+1)+vaix_g(k,j))                    &
296:                   & *(qcailx_g(k,j)/psailx_g(j))                        &
297:                   & /(msfx_io(iym1,j)*msfx_io(iym1,j))                  &
298:                   & -(va01_g(k,j+1)+va01_g(k,j))                        &
299:                   & *(qca01_g(k,j)/psa01_g(j))                          &
300:                   & /(msfx_io(1,j)*msfx_io(1,j)))*rgti
301:           end do
302:         end do
303:       end if
304:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tqadv,1,mpi_real8,0,mpi_comm_world,ierr)
305: #else
306:       do k = 1 , kz
307:         do j = 1 , jxm1
308:           tqadv = tqadv - dtmin*3.E4*dsigma(k)                          &
309:                 & *dx*((va(iy,k,j+1)+va(iy,k,j))                        &
310:                 & *(qca(iym1,k,j)/psa(iym1,j))/(msfx(iym1,j)            &
311:                 & *msfx(iym1,j))-(va(1,k,j+1)+va(1,k,j))                &
312:                 & *(qca(1,k,j)/psa(1,j))/(msfx(1,j)*msfx(1,j)))*rgti
313:         end do
314:       end do
315: #endif
316: !
317:       end subroutine conadv
</PRE>

<HR>

</BODY>
</HTML>

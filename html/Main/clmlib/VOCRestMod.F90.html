<HTML>

<HEAD>
<TITLE>VOCRestMod.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>clmlib/VOCRestMod.F90</H1>
<HR>
<H2 ALIGN=CENTER>VOCRestMod.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: #include <<a href="./preproc.h.html" TARGET=CENT_PANEL>preproc.h</a>>
2: 
<p><a name=vocrestmod><H3>vocrestmod</H3></a></p>3: module VOCRestMod
4: 
5: !-----------------------------------------------------------------------
6: !BOP
7: !
8: ! !MODULE: VOCRestMod
9: !
10: ! !DESCRIPTION:
11: ! Reads from or volatile organic compound emissions restart/initial data
12: !
13: ! !USES:
<p><a name=only : r8><H3>only : r8</H3></a></p> Click <a href="./../callingtree/only : r8_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where only : r8 is used.
<hr>
14:   use shr_kind_mod, only : r8 => <a href="#" TARGET=CENT_PANEL>shr_kind_r8</a>
15:   use <a href="#" TARGET=CENT_PANEL>abortutils</a>,   only : endrun
16: !
17: ! !PUBLIC TYPES:
18:   implicit none
19: ! save
20: !
21: ! !PUBLIC MEMBER FUNCTIONS:
22:   public :: VOCRest
23: !
24: ! !REVISION HISTORY:
25: ! 2005-06-12: Created by Mariana Vertenstein
26: !
27: !EOP
28: !-----------------------------------------------------------------------
29: 
30: contains
31: 
32: !-----------------------------------------------------------------------
33: !BOP
34: !
35: ! !IROUTINE: VOCRest
36: !
37: ! !INTERFACE:
<p><a name=vocrest><H3>vocrest</H3></a></p> Click <a href="./../callingtree/vocrest_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where vocrest is used.
<hr>
38:   subroutine VOCRest( ncid, flag )
39: !
40: ! !DESCRIPTION:
41: ! Read/Write volatile organic compound information to/from restart file.
42: !
43: ! !USES:
44:     use <a href="#" TARGET=CENT_PANEL>clmtype</a>
45:     use <a href="#" TARGET=CENT_PANEL>ncdio</a>
46:     use <a href="#" TARGET=CENT_PANEL>decompMod</a>     , only : get_proc_bounds
47:     use <a href="#" TARGET=CENT_PANEL>clm_varcon</a>    , only : denice, denh2o
48:     use <a href="#" TARGET=CENT_PANEL>clm_varctl</a>    , only : allocate_all_vegpfts, nsrest
49: !abt added below
50:     use <a href="./clm_varvoc.F90.html#clm_varvoc" TARGET=CENT_PANEL>clm_varvoc</a>    , only : c24,c240,n24,n240
51: !abt added above
52: !
53: ! !ARGUMENTS:
54:     implicit none
55:     integer, intent(in) :: ncid           ! netcdf id
56:     character(len=*), intent(in) :: flag  ! 'read' or 'write'
57: !
58: ! !CALLED FROM:
59: !
60: ! !REVISION HISTORY:
61: ! Author: Mariana Vertenstein
62: ! 12/11/2003, Peter Thornton: Added cps%coszen, pps%gdir, and pps%omega
63: !   for new sunlit/shaded canopy algorithm (in SUNSHA ifdef block)
64: ! 4/25/2005, Peter Thornton: Removed the SUNSHA ifdefs, since this is now the
65: !   default code behavior.
66: ! 6/12/2005, Moved to netcdf format and renamed file
67: ! 12/15/2008, modified biogeophysics restart to voc restart
68: !
69: !EOP
70: !
71: ! !LOCAL VARIABLES:
72:     integer :: p,c,l,g,j    ! indices
73:     integer :: begp, endp   ! per-proc beginning and ending pft indices
74:     integer :: begc, endc   ! per-proc beginning and ending column indices
75:     integer :: begl, endl   ! per-proc beginning and ending landunit indices
76:     integer :: begg, endg   ! per-proc gridcell ending gridcell indices
77:     logical :: readvar      ! determine if variable is on initial file
78:     character(len=128) :: varname         ! temporary
79:     type(gridcell_type), pointer :: gptr  ! pointer to gridcell derived subtype
80:     type(landunit_type), pointer :: lptr  ! pointer to landunit derived subtype
81:     type(column_type)  , pointer :: cptr  ! pointer to column derived subtype
82:     type(pft_type)     , pointer :: pptr  ! pointer to pft derived subtype
83: !-----------------------------------------------------------------------
84: 
85:     ! Set pointers into derived type
86: 
87:     gptr => clm3%g
88:     lptr => clm3%g%l
89:     cptr => clm3%g%l%c
90:     pptr => clm3%g%l%c%p
91:     
92: 
93:     ! accumulation variable - c24/c240
94: 
95:     if (flag == 'define') then
96:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='c24', xtype=nf_int, &
97:                long_name='current timestep count until 24hr')
98:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='c240', xtype=nf_int,  &
99:                long_name='current timestep count until 240hr')
100:     else if (flag == 'write' .or. flag == 'read') then
101:        call <a href="#" TARGET=CENT_PANEL>ncd_ioglobal</a>(varname='c24', data=c24, ncid=ncid, flag=flag, readvar=readvar)
102:        call <a href="#" TARGET=CENT_PANEL>ncd_ioglobal</a>(varname='c240' , data=c240 , ncid=ncid, flag=flag, readvar=readvar)
103:        if (flag=='read' .and. .not. readvar) then
104:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
105:        end if
106:     end if
107: 
108:     ! pft lai for current and previous month variable - monlai
109: 
110:     if (flag == 'define') then
111:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='monlai', xtype=nf_double,  &
112:             dim1name='pft', dim2name='numrad', &
113:             long_name='leaf area index for current and previous month', units=' ')
114:     else if (flag == 'read' .or. flag == 'write') then
115:        call <a href="#" TARGET=CENT_PANEL>ncd_iolocal</a>(varname='monlai', data=pptr%pva%monlai, &
116:             dim1name='pft', dim2name='numrad', &
117:             ncid=ncid, flag=flag, readvar=readvar)
118:        if (flag=='read' .and. .not. readvar) then
119:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
120:        end if
121:     end if
122: 
123:     ! pft previous temperature/ppfd variable - t_sum24
124: 
125:     if (flag == 'define') then
126:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='TEMP_24', xtype=nf_double,  &
127:             dim1name='pft', dim2name='nday', &
128:             long_name='past 24 hour temp', units='K')
129:     else if (flag == 'read' .or. flag == 'write') then
130:        call <a href="#" TARGET=CENT_PANEL>ncd_iolocal</a>(varname='TEMP_24', data=pptr%pva%t_sum24, &
131: !            dim1name='nday', dim2name='pft', &
132:             dim1name='pft', dim2name='nday', &
133:             ncid=ncid, flag=flag, readvar=readvar)
134:        if (flag=='read' .and. .not. readvar) then
135:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
136:        end if
137:     end if
138: 
139:     ! pft previous temperature/ppfd variable - t_sum240
140: 
141:     if (flag == 'define') then
142:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='TEMP_240', xtype=nf_double,  &
143: !            dim1name='nten', dim2name='pft', &
144:             dim1name='pft', dim2name='nten', &
145:             long_name='past 240 hour temp', units='K')
146:     else if (flag == 'read' .or. flag == 'write') then
147:        call <a href="#" TARGET=CENT_PANEL>ncd_iolocal</a>(varname='TEMP_240', data=pptr%pva%t_sum240, &
148: !            dim1name='nten', dim2name='pft', &
149:             dim1name='pft', dim2name='nten', &
150:             ncid=ncid, flag=flag, readvar=readvar)
151:        if (flag=='read' .and. .not. readvar) then
152:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
153:        end if
154:     end if
155: 
156:     ! pft previous temperature/ppfd variable - p_sum24su
157: 
158:     if (flag == 'define') then
159:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='PPFD_24su', xtype=nf_double,  &
160: !            dim1name='nday', dim2name='pft', &
161:             dim1name='pft', dim2name='nday', &
162:             long_name='past 24 hour ppfd for sunlit portion', units='umol/m2/s')
163:     else if (flag == 'read' .or. flag == 'write') then
164:        call <a href="#" TARGET=CENT_PANEL>ncd_iolocal</a>(varname='PPFD_24su', data=pptr%pva%p_sum24su, &
165: !            dim1name='nday', dim2name='pft', &
166:             dim1name='pft', dim2name='nday', &
167:             ncid=ncid, flag=flag, readvar=readvar)
168:        if (flag=='read' .and. .not. readvar) then
169:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
170:        end if
171:     end if
172: 
173:     ! pft previous temperature/ppfd variable - p_sum240su
174: 
175:     if (flag == 'define') then
176:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='PPFD_240su', xtype=nf_double,  &
177: !            dim1name='nten', dim2name='pft', &
178:             dim1name='pft', dim2name='nten', &
179:             long_name='past 240 hour ppfd for sunlit', units='umol/m2/s')
180:     else if (flag == 'read' .or. flag == 'write') then
181:        call <a href="#" TARGET=CENT_PANEL>ncd_iolocal</a>(varname='PPFD_240su', data=pptr%pva%p_sum240su, &
182: !            dim1name='nten', dim2name='pft', &
183:             dim1name='pft', dim2name='nten', &
184:             ncid=ncid, flag=flag, readvar=readvar)
185:        if (flag=='read' .and. .not. readvar) then
186:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
187:        end if
188:     end if
189: 
190:     ! pft previous temperature/ppfd variable - p_sum24sh
191: 
192:     if (flag == 'define') then
193:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='PPFD_24sh', xtype=nf_double,  &
194:             dim1name='pft', dim2name='nday', &
195:             long_name='past 24 hour ppfd for shaded', units='umol/m2/s')
196:     else if (flag == 'read' .or. flag == 'write') then
197:        call <a href="#" TARGET=CENT_PANEL>ncd_iolocal</a>(varname='PPFD_24sh', data=pptr%pva%p_sum24sh, &
198:             dim1name='pft', dim2name='nday', &
199:             ncid=ncid, flag=flag, readvar=readvar)
200:        if (flag=='read' .and. .not. readvar) then
201:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
202:        end if
203:     end if
204: 
205:     ! pft previous temperature/ppfd variable - p_sum240sh
206: 
207:     if (flag == 'define') then
208:        call <a href="#" TARGET=CENT_PANEL>ncd_defvar</a>(ncid=ncid, varname='PPFD_240sh', xtype=nf_double,  &
209:             dim1name='pft', dim2name='nten', &
210:             long_name='past 240 hour ppfd for shaded', units='umol/m2/s')
211:     else if (flag == 'read' .or. flag == 'write') then
212:        call <a href="#" TARGET=CENT_PANEL>ncd_iolocal</a>(varname='PPFD_240sh', data=pptr%pva%p_sum240sh, &
213:             dim1name='pft', dim2name='nten', &
214:             ncid=ncid, flag=flag, readvar=readvar)
215:        if (flag=='read' .and. .not. readvar) then
216:           if (is_restart()) call <a href="#" TARGET=CENT_PANEL>endrun</a>()
217:        end if
218:     end if
219: 
220: 
221: 
222:   end subroutine VOCRest
223: 
224: !-----------------------------------------------------------------------
225: !BOP
226: !
227: ! !IROUTINE: is_restart
228: !
229: ! !INTERFACE:
<p><a name=is_restart><H3>is_restart</H3></a></p> Click <a href="./../callingtree/is_restart_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where is_restart is used.
<hr>
230:   logical function is_restart( )
231: !
232: ! !DESCRIPTION:
233: ! Determine if restart run
234: !
235: ! !USES:
236:     use <a href="#" TARGET=CENT_PANEL>clm_varctl</a>, only : nsrest
237: !
238: ! !ARGUMENTS:
239:     implicit none
240: !
241: ! !CALLED FROM:
242: ! subroutine initialize in this module
243: !
244: ! !REVISION HISTORY:
245: ! Created by Mariana Vertenstein
246: !
247: !EOP
248: !-----------------------------------------------------------------------
249: 
250:     if (nsrest == 1) then
251:        <a href="./VOCRestMod.F90.html#is_restart" TARGET=CENT_PANEL>is_restart</a> = .true.
252:     else
253:        <a href="./VOCRestMod.F90.html#is_restart" TARGET=CENT_PANEL>is_restart</a> = .false.
254:     end if
255: 
256:   end function is_restart
257: 
258: end module VOCRestMod
</PRE>

<HR>

</BODY>
</HTML>

<HTML>

<HEAD>
<TITLE>program_offMod.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>clmlib/program_offMod.F90</H1>
<HR>
<H2 ALIGN=CENTER>program_offMod.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: #include <<a href="./misc.h.html" TARGET=CENT_PANEL>misc.h</a>>
2: #include <<a href="./preproc.h.html" TARGET=CENT_PANEL>preproc.h</a>>
3: 
<p><a name=program_offmod><H3>program_offmod</H3></a></p>4: module program_offMod
5: 
6: ! ! #if (defined OFFLINE)
7: 
8: !-----------------------------------------------------------------------
9: !BOP
10: !
11: ! !MODULE: program_offMod
12: !
13: ! !DESCRIPTION (for coupled REGCM-CLM):  
14: ! The information in the description below may not accurately reflect 
15: ! the coupled code.  Program_off is used to initialize the land surface
16: ! and is called from init_clm.f
17: !
18: ! !DESCRIPTION:
19: ! "off-line" code to mimic coupling to an atmospheric model.
20: ! This program is an "off-line" driver for clm3.
21: ! This code can be used to run the clm3 uncoupled from any atmospheric model.
22: ! The appropriate atmospheric forcing is provided in module [atmdrvMod.F90]
23: ! o If running as an offline driver, the land surface model may use
24: !   a different grid than the input atmospheric data. The atmospheric
25: !   data is then interpolated to the land model grid inside the
26: !   atmospheric driver module [atmdrvMod.F90].
27: ! o If running as part of cam, the land surface model must use the
28: !   same grid as the cam.
29: ! o If running through the flux coupler, the land surface model grid
30: !   is interpolated to the atmospheric grid inside the flux coupler
31: ! o To map from the atmospheric grid to the land grid, the atmospheric
32: !   model must provide latitudes and longitudes (degrees) for each grid
33: !   point and the North, East, South, and West edges of atmospheric grid.
34: !   Comparable data for the land grid are provided by the land model.
35: !   When mapping from land to atm grid, an atm grid cell that is part
36: !   land and part ocean (as defined by the land surface grid) will have
37: !   fluxes only based on the land portion.
38: ! o The zenith angle calculation is for the NEXT time step rather
39: !   than the current time step. Make sure the calendar day is for
40: !   the NEXT time step. Make sure the calendar day is for Greenwich
41: !   time (see next comment).
42: ! o The land surface model calculates its own net solar radiation and
43: !   net longwave radiation at the surface. The net longwave radiation
44: !   at the surface will differ somewhat from that calculated in the
45: !   atmospheric model because the atm model will use the upward
46: !   longwave flux (or radiative temperature) from the previous time
47: !   step whereas the land surface model uses the flux for the current
48: !   time step. The net solar radiation should equal that calculated
49: !   in the atmospheric model. If not, there is a problem in how
50: !   the models are coupled.
51: !
52: !
53: ! !PUBLIC TYPES:
54:   implicit none
55:   save
56: !
57: ! !PUBLIC MEMBER FUNCTIONS:
58:   public :: program_off  ! initialize land surface
59:   public :: program_off_stub !from original code
60: !
61: ! !REVISION HISTORY:
62: ! Author: Gordon Bonan and Mariana Vertenstein
63: ! Modified for RegCM by: Ahmed Tawfik
64: !EOP
65: !
66: !-----------------------------------------------------------------------
67: 
68: contains
69: 
70: !=======================================================================
71: 
72: !------------------------------------------------------------------------
73: !BOP
74: !
75: ! !IROUTINE: program_off
76: !
77: ! !INTERFACE:
<p><a name=program_off><H3>program_off</H3></a></p> Click <a href="./../callingtree/program_off_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where program_off is used.
<hr>
78:   subroutine program_off(eccen       , obliqr      , lambm0    , mvelpp)
79: !!
80: !
81: ! !DESCRIPTION:
82: ! Subroutine for initializing the land surface variables.  
83: !
84: ! !CALLED FROM: 
85: ! init_clm(sera/para).f
86: !
87: ! !USES:
<p><a name=only : r8><H3>only : r8</H3></a></p> Click <a href="./../callingtree/only : r8_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where only : r8 is used.
<hr>
88:   use shr_kind_mod    , only : r8 => <a href="#" TARGET=CENT_PANEL>shr_kind_r8</a>, SHR_KIND_CL
89:   use <a href="#" TARGET=CENT_PANEL>shr_orb_mod</a>          
90: !  use clm_varorb      , only : eccen, mvelpp, lambm0, obliqr, obliq, &
91: !                               iyear_AD, nmvelp
92:   use <a href="#" TARGET=CENT_PANEL>clm_comp</a>        , only : clm_init0, clm_init1, clm_init2 !, clm_run1, clm_run2
93:   use <a href="#" TARGET=CENT_PANEL>clm_time_manager</a>, only : is_last_step, advance_timestep, get_nstep
94:   use <a href="#" TARGET=CENT_PANEL>atmdrvMod</a>       , only : rcmdrv_init
95:   use <a href="#" TARGET=CENT_PANEL>abortutils</a>      , only : endrun
96:   use <a href="#" TARGET=CENT_PANEL>controlMod</a>      , only : control_setNL
97:   use <a href="#" TARGET=CENT_PANEL>clm_mct_mod</a>
98:   use <a href="#" TARGET=CENT_PANEL>spmdMod</a>  
99:   use <a href="#" TARGET=CENT_PANEL>ESMF_Mod</a>
100:   use <a href="#" TARGET=CENT_PANEL>perf_mod</a>
101:   use <a href="./../mod_clm.F90.html#mod_clm" TARGET=CENT_PANEL>mod_clm</a>
102:   use <a href="./../mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
103: 
104: ! !ARGUMENTS:
105:     implicit none
106: !rcm below
107: ! eccen, obliqr, lambm0 & mvelpp all passed in
108:     real(r8), intent(inout) :: eccen    !Earth's orbital eccentricity
109:     real(r8), intent(inout) :: obliqr   !Earth's obliquity in radians
110:     real(r8), intent(inout) :: lambm0   !Mean longitude of perihelion at the vernal equinox (radians)
111:     real(r8), intent(inout) :: mvelpp   !Earth's moving vernal equinox longitude of perihelion + pi (radians)
112: !rcm above
113: 
114: 
115: ! !LOCAL VARIABLES:
116:   integer  :: nstep     ! time step index
117:   real(r8) :: dtime     ! time step increment (sec)
118:   integer  :: ier       ! error code
119: 
120: ! Orbital information after call to routine shr_orbit_params
121: 
122:   logical  :: log_print    ! true=> print diagnostics
123:   real(r8) :: eccf         ! earth orbit eccentricity factor
124:   logical  :: mpi_running  ! true => MPI is initialized 
125:   integer  :: mpicom_glob  ! MPI communicator
126: 
127:   character(len=SHR_KIND_CL) :: nlfilename = "lnd.stdin"
128: !-----------------------------------------------------------------------
129: 
130: 
131: 
132:   ! -----------------------------------------------------------------
133:   ! Initialize MPI
134:   ! -----------------------------------------------------------------
135:   call <a href="#" TARGET=CENT_PANEL>mpi_initialized</a> (mpi_running, ier)
136:   if (.not. mpi_running) call <a href="#" TARGET=CENT_PANEL>mpi_init</a>(ier)
137:   mpicom_glob = MPI_COMM_WORLD
138:   call <a href="#" TARGET=CENT_PANEL>spmd_init</a>(mpicom_glob)
139:   call <a href="#" TARGET=CENT_PANEL>mct_world_init</a>(1,mpicom_glob,mpicom,comp_id)
140: 
141:   call <a href="#" TARGET=CENT_PANEL>t_startf</a>('init')
142: 
143:   ! -----------------------------------------------------------------
144:   ! Initialize ESMF (needed for time-manager)
145:   ! -----------------------------------------------------------------
146: 
147:   call <a href="#" TARGET=CENT_PANEL>ESMF_Initialize</a>()
148: 
149:   ! -----------------------------------------------------------------
150:   ! Initialize timing library, and set full path to namelist
151:   ! -----------------------------------------------------------------
152: !abt commented: surpress namelist file; use regcm options
153: !  call control_setNL( nlfilename )     ! Set namelist
154: !abt commented above
155:   call <a href="#" TARGET=CENT_PANEL>t_initf</a>(nlfilename, LogPrint=masterproc, Mpicom=mpicom, &
156:                MasterTask=masterproc)
157: 
158: 
159:   ! -----------------------------------------------------------------
160:   ! Initialize Orbital parameters
161:   ! -----------------------------------------------------------------
162: 
163:   ! obliq, eccen and nmvelp are determined based on value of iyear_AD
164: 
165:   if (masterproc) then
166:      log_print = .true.
167:   else
168:      log_print = .false.
169:   end if
170: 
171: ! abt rcm below
172: !!! orbital calculations where done in solar1_clm.f which was called
173: !!! from init.f and tend.f
174: !  iyear_AD = 1950
175: !  obliq    = SHR_ORB_UNDEF_REAL
176: !  eccen    = SHR_ORB_UNDEF_REAL
177: !  nmvelp   = SHR_ORB_UNDEF_REAL
178: !  call shr_orb_params (iyear_AD, eccen, obliq, nmvelp, obliqr, &
179: !                       lambm0, mvelpp, log_print)
180: ! abt rcm above
181: 
182:   ! -----------------------------------------------------------------
183:   ! Initialize land model
184:   ! -----------------------------------------------------------------
185: 
186: !  call clm_init0()
187: !  call clm_init1()
188: !  call clm_init2()
189: 
190:   ! -----------------------------------------------------------------
191:   ! Initialize "external" atmospheric forcing
192:   ! -----------------------------------------------------------------
193: 
194:   ! Read atmospheric forcing dataset one time to obtain the longitudes
195:   ! and latitudes of the atmospheric dataset, as well as the edges. When
196:   ! coupled to atm model, these are input variables. If no
197:   ! atmospheric data files are provided, model uses dummy atmospheric
198:   ! forcing and sets atmospheric grid to land grid.
199: 
200: 
201: !  call t_stopf('init')
202: 
203: !!!!!!!!!!!!!!!!!!!!!!! RCM ONLY USES ABOVE; ignore below !!!!!!!!!
204: ! abt rcm below  
205:   ! -----------------------------------------------------------------
206:   ! Time stepping loop
207:   ! -----------------------------------------------------------------
208: 
209: !  call t_barrierf('barrieri',mpicom)
210: !  call t_startf('runtotal')
211: 
212: !  do
213:      ! Current atmospheric state and fluxes for all [atmlon] x [atmlat] points.
214: 
215: !     nstep = get_nstep()
216: !     call t_startf('atmdrv')
217: !     call atmdrv(nstep)
218: !     call t_stopf('atmdrv')
219: 
220: !     !  call t_barrierf('barrier1b',mpicom)
221: !     ! Run
222: 
223: !     call clm_run1()
224: !
225: !     !  call t_barrierf('barrier2b',mpicom)
226: !
227: !     call clm_run2()
228: !
229: !     !  call t_barrierf('barrierd2p',mpicom)
230: !     ! Determine if time to stop
231: !
232: !     if (is_last_step()) exit
233: 
234: !     ! Increment time step
235: 
236: !     call advance_timestep()
237: 
238: !  end do
239: !  call t_stopf('runtotal')
240: 
241:   ! -----------------------------------------------------------------
242:   ! Exit gracefully
243:   ! -----------------------------------------------------------------
244: 
245: !#if (defined BGL)
246: !     call print_stack_size()
247: !#endif
248: 
249: !  if (masterproc) then
250: !     write(6,*)'SUCCESFULLY TERMINATING CLM MODEL at nstep= ',get_nstep()
251: !  endif
252: !  call t_prf('timing_all',mpicom)
253: !  call t_finalizef()
254: 
255: !  ! Finalize ESMF
256: !  call ESMF_Finalize()
257: 
258: !  stop
259: !!!!!!!!!!!!!!!!!!!!!!!!! abt rcm above !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
260: end subroutine program_off
261: 
262: !! #else
263: 
264: !The following is only here since empty file won't compile
<p><a name=program_off_stub><H3>program_off_stub</H3></a></p> Click <a href="./../callingtree/program_off_stub_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where program_off_stub is used.
<hr>
265: subroutine program_off_stub
266:   write(6,*) 'PROGRAM_OFF: this routine should not be called'
267:   return
268: end subroutine program_off_stub
269: 
270: !! #endif
271: 
272: end module program_offMod
</PRE>

<HR>

</BODY>
</HTML>

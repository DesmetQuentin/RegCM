<HTML>

<HEAD>
<TITLE>mkarbinitMod.F90.patch</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>clmlib/patchset/mkarbinitMod.F90.patch</H1>
<HR>
<H2 ALIGN=CENTER>mkarbinitMod.F90.patch</H2>
<HR>
</FONT>

<HR>

<PRE>
<OL>
<LI>--- orig/mkarbinitMod.F90	2010-03-10 16:34:21.000000000 +0100
<LI>+++ patchd/mkarbinitMod.F90	2010-03-10 16:30:20.989670289 +0100
<LI>@@ -27,7 +27,13 @@
<LI>     use clm_varcon   , only : bdsno, istice, istwet, istsoil, denice, denh2o, spval, sb
<LI>     use spmdMod      , only : masterproc
<LI>     use decompMod    , only : get_proc_bounds
<LI>-!
<LI>+!!abt added below rcm
<LI>+    use clm_varsur   , only : satbrt_clm,init_tgb
<LI>+    use clm_varpar   , only : lsmlon,lsmlat
<LI>+    use clm_varsur   , only : slmo,iexsol,xmopor 
<LI>+    use decompMod    , only : ldecomp
<LI>+    use pftvarcon    , only : smpsc
<LI>+!!abt above
<LI> ! !ARGUMENTS:
<LI>     implicit none
<LI> !
<LI>@@ -83,6 +89,13 @@
<LI>     integer :: begl, endl   ! per-proc beginning and ending landunit indices
<LI>     integer :: begg, endg   ! per-proc gridcell ending gridcell indices
<LI>     real(r8):: vwc,psi      ! for calculating soilpsi
<LI>+!!abt added below
<LI>+    integer :: ii,jj,g,nveg,tex,is,dtime
<LI>+    real(r8), allocatable :: temp_veg(:,:)  !temporary array for storing BATS landuse type
<LI>+    real(r8), allocatable :: temp_veg1(:,:) !temporary array for storing BATS landuse type
<LI>+    integer , pointer :: cgridcell(:)       !gridcell index of corresponding column
<LI>+    integer , pointer :: ivt(:)             ! vegetation type
<LI>+!!abt added above
<LI> !-----------------------------------------------------------------------
<LI> 
<LI>     if ( masterproc ) write (6,*) 'Setting initial data to non-spun up values'
<LI>@@ -93,7 +106,10 @@
<LI>     lakpoi     => clm3%g%l%lakpoi
<LI> 
<LI>     ! Assign local pointers to derived subtypes components (column-level)
<LI>-
<LI>+!!abt added below
<LI>+    cgridcell  => clm3%g%l%c%gridcell
<LI>+    ivt        => clm3%g%l%c%p%itype
<LI>+!!abt added above
<LI>     clandunit  => clm3%g%l%c%landunit
<LI>     snl        => clm3%g%l%c%cps%snl
<LI>     dz         => clm3%g%l%c%cps%dz
<LI>@@ -145,6 +161,23 @@
<LI>        !clm3%g%l%c%p%pps%frac_veg_nosno_alb(p) = 0._r8
<LI>     end do
<LI> 
<LI>+!!!abt added below
<LI>+!!! convert from 2d BATS types to 1d at gridcell level !!!
<LI>+!!!         also convert from meters to kg/m^2         !!!
<LI>+
<LI>+    allocate(temp_veg(lsmlat,lsmlon))
<LI>+    allocate(temp_veg1(lsmlat,lsmlon))
<LI>+
<LI>+    do jj = 1,lsmlat
<LI>+    do ii = 1,lsmlon
<LI>+        g = (jj-1)*lsmlon + ii
<LI>+        temp_veg(jj,ii)  = satbrt_clm(jj,ii)
<LI>+        temp_veg1(jj,ii) = satbrt_clm(jj,ii)
<LI>+    enddo
<LI>+    enddo
<LI>+
<LI>+!!!abt above added
<LI>+
<LI> !dir$ concurrent
<LI> !cdir nodep
<LI>     do c = begc,endc
<LI>@@ -185,38 +218,69 @@
<LI> !dir$ concurrent
<LI> !cdir nodep
<LI>     do c = begc,endc
<LI>+       g = cgridcell(c) !abt added
<LI>+      ii = ldecomp%gdc2i(g) !abt
<LI>+      jj = ldecomp%gdc2j(g) !abt
<LI>+       l = clandunit(c)
<LI> 
<LI>        t_soisno(c,-nlevsno+1:nlevsoi) = spval
<LI>        t_lake(c,1:nlevlak) = spval
<LI> 
<LI>-       l = clandunit(c)
<LI>+!abt original code below       if (.not. lakpoi(l)) then  !not lake
<LI>+!          t_soisno(c,-nlevsno+1:0) = spval
<LI>+!          if (snl(c) < 0) then    !snow layer temperatures
<LI>+!             do j = snl(c)+1, 0
<LI>+!                t_soisno(c,j) = 250._r8
<LI>+!             enddo
<LI>+!          endif
<LI>+!          if (ltype(l) == istice) then
<LI>+!             do j = 1, nlevsoi
<LI>+!                t_soisno(c,j) = 250._r8
<LI>+!             end do
<LI>+!          else if (ltype(l) == istwet) then
<LI>+!             do j = 1, nlevsoi
<LI>+!                t_soisno(c,j) = 277._r8
<LI>+!             end do
<LI>+!          else
<LI>+!             do j = 1, nlevsoi
<LI>+!                t_soisno(c,j) = 283._r8
<LI>+!             end do
<LI>+!          endif
<LI>+!          t_grnd(c) = t_soisno(c,snl(c)+1)
<LI>+!       else                     !lake
<LI>+!          t_lake(c,1:nlevlak) = 277._r8
<LI>+!          t_grnd(c) = t_lake(c,1)
<LI>+!abt original code above       endif
<LI>+
<LI>+!abt below !!edit initialization to match BATS
<LI>        if (.not. lakpoi(l)) then  !not lake
<LI>           t_soisno(c,-nlevsno+1:0) = spval
<LI>           if (snl(c) < 0) then    !snow layer temperatures
<LI>              do j = snl(c)+1, 0
<LI>-                t_soisno(c,j) = 250._r8
<LI>+                t_soisno(c,j) = init_tgb(jj,ii)
<LI>              enddo
<LI>           endif
<LI>           if (ltype(l) == istice) then
<LI>              do j = 1, nlevsoi
<LI>-                t_soisno(c,j) = 250._r8
<LI>+                t_soisno(c,j) = init_tgb(jj,ii)
<LI>              end do
<LI>           else if (ltype(l) == istwet) then
<LI>              do j = 1, nlevsoi
<LI>-                t_soisno(c,j) = 277._r8
<LI>+                t_soisno(c,j) = init_tgb(jj,ii)
<LI>              end do
<LI>           else
<LI>              do j = 1, nlevsoi
<LI>-                t_soisno(c,j) = 283._r8
<LI>+                t_soisno(c,j) = init_tgb(jj,ii)
<LI>              end do
<LI>           endif
<LI>           t_grnd(c) = t_soisno(c,snl(c)+1)
<LI>        else                     !lake
<LI>-          t_lake(c,1:nlevlak) = 277._r8
<LI>+          t_lake(c,1:nlevlak) = init_tgb(jj,ii)
<LI>           t_grnd(c) = t_lake(c,1)
<LI>        endif
<LI> 
<LI>     end do
<LI>+!abt above !!edit initialization to match BATS
<LI> 
<LI> !dir$ concurrent
<LI> !cdir nodep
<LI>@@ -256,24 +320,58 @@
<LI> !cdir nodep
<LI>        do c = begc,endc
<LI>           l = clandunit(c)
<LI>+          g = cgridcell(c) !abt added
<LI>+         ii = ldecomp%gdc2i(g) !abt
<LI>+         jj = ldecomp%gdc2j(g) !abt
<LI>+
<LI>           if (.not. lakpoi(l)) then  !not lake
<LI> 
<LI>-             ! volumetric water
<LI>-             if (ltype(l) == istsoil) then
<LI>-                h2osoi_vol(c,j) = 0.4_r8
<LI>+!abt original below             ! volumetric water
<LI>+!             if (ltype(l) == istsoil) then
<LI>+!                h2osoi_vol(c,j) = 0.4_r8
<LI>+!             else
<LI>+!                h2osoi_vol(c,j) = 1.0_r8
<LI>+!             endif
<LI>+!             h2osoi_vol(c,j) = min(h2osoi_vol(c,j),watsat(c,j))
<LI>+
<LI>+!             ! soil layers
<LI>+!             if (t_soisno(c,j) <= SHR_CONST_TKFRZ) then
<LI>+!                h2osoi_ice(c,j)  = dz(c,j)*denice*h2osoi_vol(c,j)
<LI>+!                h2osoi_liq(c,j) = 0._r8
<LI>+!             else
<LI>+!                h2osoi_ice(c,j) = 0._r8
<LI>+!                h2osoi_liq(c,j) = dz(c,j)*denh2o*h2osoi_vol(c,j)
<LI>+!abt original above             endif
<LI>+
<LI>+!abt added section below
<LI>+             if(temp_veg(jj,ii).lt.15.1 .and. temp_veg(jj,ii).gt.13.9) then
<LI>+                temp_veg(jj,ii) = 0
<LI>+             endif
<LI>+
<LI>+             nveg = nint(temp_veg(jj,ii))
<LI>+             if(nveg.eq.0) then
<LI>+                nveg = 15
<LI>              else
<LI>-                h2osoi_vol(c,j) = 1.0_r8
<LI>+                nveg = nveg
<LI>              endif
<LI>-             h2osoi_vol(c,j) = min(h2osoi_vol(c,j),watsat(c,j))
<LI>+
<LI>+             tex = iexsol(nveg)
<LI>+             is  = nint(temp_veg1(jj,ii))
<LI>+
<LI>+             h2osoi_vol(c,j) = xmopor(tex) * slmo(is)
<LI> 
<LI>              ! soil layers
<LI>-             if (t_soisno(c,j) <= SHR_CONST_TKFRZ) then
<LI>-                h2osoi_ice(c,j)  = dz(c,j)*denice*h2osoi_vol(c,j)
<LI>-                h2osoi_liq(c,j) = 0._r8
<LI>-             else
<LI>+!             if (t_soisno(c,j) <= SHR_CONST_TKFRZ) then
<LI>+!                h2osoi_ice(c,j)  = dz(c,j)*denice*h2osoi_vol(c,j)
<LI>+!                h2osoi_liq(c,j) = 0._r8
<LI>+!             else
<LI>                 h2osoi_ice(c,j) = 0._r8
<LI>                 h2osoi_liq(c,j) = dz(c,j)*denh2o*h2osoi_vol(c,j)
<LI>-             endif
<LI>+!             endif
<LI>+!Initialization with no ice to match BATS initialization 
<LI>+!abt added section above
<LI>+   
<LI>+
<LI> 
<LI> #if (defined CN)
<LI>              ! soil water potential (added 10/21/03, PET)
<LI>@@ -293,6 +391,10 @@
<LI> 
<LI>     end do
<LI> 
<LI>+!!!abt added below
<LI>+   deallocate(temp_veg1,temp_veg)
<LI>+!!!abt added above
<LI>+
<LI>     ! Set snow
<LI> 
<LI>     do j = -nlevsno+1, 0
</OL>
</PRE>

<HR>

</BODY>
</HTML>

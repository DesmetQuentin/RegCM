<HTML>

<HEAD>
<TITLE>initializeMod.F90.patch</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>clmlib/patchset/initializeMod.F90.patch</H1>
<HR>
<H2 ALIGN=CENTER>initializeMod.F90.patch</H2>
<HR>
</FONT>

<HR>

<PRE>
<OL>
<LI>--- orig/initializeMod.F90	2010-03-10 16:34:21.000000000 +0100
<LI>+++ patchd/initializeMod.F90	2010-03-10 16:30:08.128597725 +0100
<LI>@@ -47,7 +47,7 @@
<LI> ! !IROUTINE: initialize1
<LI> !
<LI> ! !INTERFACE:
<LI>-  subroutine initialize1( CCSMInit )
<LI>+  subroutine initialize1( CCSMInit)
<LI> !
<LI> ! !DESCRIPTION:
<LI> ! Land model initialization.
<LI>@@ -77,11 +77,19 @@
<LI>     use domainMod , only : latlon_check, latlon_setsame
<LI>     use areaMod   , only : map_setgatm
<LI>     use surfrdMod , only : surfrd,surfrd_get_grid,surfrd_get_frac,&
<LI>-                           surfrd_get_topo, surfrd_get_latlon
<LI>+                           surfrd_get_topo, surfrd_get_latlon,&
<LI>+                           rcmsurfrd_get_topo, rcmsurfrd_get_frac,&
<LI>+                           rcmsurfrd_get_latlon,rcmsurfrd_get_grid,&
<LI>+                           rcmsurfrd !abt
<LI>     use clm_varctl, only : fsurdat, fatmgrid, fatmlndfrc, &
<LI>-                           fatmtopo, flndtopo
<LI>+                           fatmtopo, flndtopo, mksrf_offline_fnavyoro, &
<LI>+                           mksrf_furban,mksrf_fglacier,mksrf_fsoitex, &
<LI>+                           mksrf_flanwat,mksrf_fvegtyp !abt
<LI>     use controlMod, only : control_init, control_print
<LI>     use shr_InputInfo_mod, only : shr_InputInfo_initType
<LI>+    use clm_varsur, only : landmask  !abt rcm
<LI>+    use mod_clm
<LI>+    use mod_dynparam
<LI> !
<LI> ! !ARGUMENTS:
<LI>     type(shr_InputInfo_initType), intent(in), optional :: CCSMInit
<LI>@@ -101,6 +109,8 @@
<LI>     integer  :: begg_atm, endg_atm    ! proc beg and ending gridcell indices
<LI>     type(domain_type) :: lgdomain   ! generic "global" domain for i/o
<LI>     type(domain_type) :: agdomain   ! generic "global" domain for i/o
<LI>+
<LI>+    integer :: nns,nni,nnj,llat,llon  !indices abt rcm
<LI> !-----------------------------------------------------------------------
<LI> 
<LI>     ! ------------------------------------------------------------------------
<LI>@@ -137,8 +147,17 @@
<LI> #endif
<LI>     endif
<LI> 
<LI>-    call surfrd_get_latlon(alatlon, fatmgrid, amask, fatmlndfrc)
<LI>+
<LI>+!!!!!! abt rcm below
<LI>+
<LI>+!    call surfrd_get_latlon(alatlon, fatmgrid, amask, fatmlndfrc)
<LI>+!    call latlon_check(alatlon)
<LI>+    call rcmsurfrd_get_latlon(alatlon,mksrf_offline_fnavyoro,amask)
<LI>     call latlon_check(alatlon)
<LI>+
<LI>+!!!!!! abt rcm above
<LI>+
<LI>+
<LI>     if (masterproc) then
<LI>        write (6,*) 'amask size/min/max ',size(amask),minval(amask),maxval(amask)
<LI> #ifndef UNICOSMP
<LI>@@ -153,11 +172,15 @@
<LI> #endif
<LI>     endif
<LI> 
<LI>-    call surfrd_get_latlon(llatlon, fsurdat, pftm, pftmflag=.true.)
<LI>+!!!!! abt rcm below
<LI>+
<LI>+!    call surfrd_get_latlon(llatlon, fsurdat, pftm, pftmflag=.true.)
<LI>+!    call latlon_check(llatlon)
<LI>+
<LI>+    call rcmsurfrd_get_latlon(llatlon,mksrf_offline_fnavyoro, pftm, pftmflag=.true.)
<LI>     call latlon_check(llatlon)
<LI> 
<LI>-    lsmlon = llatlon%ni
<LI>-    lsmlat = llatlon%nj
<LI>+!!!!! abt rcm above
<LI> 
<LI>     if (llatlon%ni < alatlon%ni .or. llatlon%nj < alatlon%nj) then
<LI>        if (masterproc) write(6,*) 'ERROR llatlon size > alatlon size: ', &
<LI>@@ -209,11 +232,15 @@
<LI>        call map_setgatm_UNITY(gatm,alatlon,amask)
<LI>     endif
<LI> #endif
<LI>+
<LI>+
<LI>     call map_setgatm(gatm,alatlon,llatlon,amask,pftm)
<LI> 
<LI>+
<LI>     ! Initialize clump and processor decomposition 
<LI>     call decomp_lnd_init(alatlon%ns,alatlon%ni,alatlon%nj,llatlon%ns,llatlon%ni,llatlon%nj)
<LI> 
<LI>+
<LI>     !--- Read atm grid -------------------------------------------------------------------
<LI> 
<LI>     if (masterproc) then
<LI>@@ -222,7 +249,13 @@
<LI>        call shr_sys_flush(6)
<LI> #endif
<LI>     endif
<LI>-    call surfrd_get_grid(agdomain, fatmgrid)
<LI>+
<LI>+!!!!!!!! abt rcm below
<LI>+
<LI>+!    call surfrd_get_grid(agdomain, fatmgrid)
<LI>+    call rcmsurfrd_get_grid(agdomain,mksrf_offline_fnavyoro)
<LI>+
<LI>+
<LI> 
<LI>     if (masterproc) then
<LI>        write (6,*) 'Attempting to read atm landfrac from fatmlndfrc'
<LI>@@ -230,17 +263,26 @@
<LI>        call shr_sys_flush(6)
<LI> #endif
<LI>     endif
<LI>-    call surfrd_get_frac(agdomain, fatmlndfrc)
<LI> 
<LI>-    if (fatmtopo /= " ") then
<LI>+!    call surfrd_get_frac(agdomain, fatmlndfrc)
<LI>+    call rcmsurfrd_get_frac(agdomain, mksrf_offline_fnavyoro)
<LI>+
<LI>+!    if (fatmtopo /= " ") then
<LI>     if (masterproc) then
<LI>        write (6,*) 'Attempting to read atm topo from fatmtopo'
<LI> #ifndef UNICOSMP
<LI>        call shr_sys_flush(6)
<LI> #endif
<LI>     endif
<LI>-    call surfrd_get_topo(agdomain, fatmtopo)
<LI>-    endif
<LI>+!    call surfrd_get_topo(agdomain, fatmtopo)
<LI>+    call rcmsurfrd_get_topo(agdomain, mksrf_offline_fnavyoro)
<LI>+
<LI>+
<LI>+!    endif
<LI>+
<LI>+!!!!!!!!! abt rcm above
<LI>+
<LI>+
<LI> 
<LI>     if (masterproc) then
<LI>        write(6,*) 'agdomain status:'
<LI>@@ -265,7 +307,12 @@
<LI>        call shr_sys_flush(6)
<LI> #endif
<LI>     endif
<LI>-    call surfrd_get_grid(lgdomain, fsurdat)
<LI>+
<LI>+! abt rcm below
<LI>+!    call surfrd_get_grid(lgdomain, fsurdat)
<LI>+    call rcmsurfrd_get_grid(lgdomain,mksrf_offline_fnavyoro)
<LI>+
<LI>+! abt rcm above
<LI> 
<LI>     if (flndtopo /= " ") then
<LI>     if (masterproc) then
<LI>@@ -274,7 +321,13 @@
<LI>        call shr_sys_flush(6)
<LI> #endif
<LI>     endif
<LI>-    call surfrd_get_topo(lgdomain, flndtopo)
<LI>+
<LI>+
<LI>+! abt rcm below
<LI>+!    call surfrd_get_topo(lgdomain, flndtopo)
<LI>+    call rcmsurfrd_get_topo(lgdomain, mksrf_offline_fnavyoro)
<LI>+! abt rcm above
<LI>+
<LI>     endif
<LI> 
<LI>     if (masterproc) then
<LI>@@ -288,6 +341,7 @@
<LI>        call domain_check(ldomain)
<LI>     endif
<LI> 
<LI>+
<LI>     call domain_clean(lgdomain)
<LI> 
<LI>     !--- overwrite ldomain if same grids --------------------------------------------
<LI>@@ -297,6 +351,7 @@
<LI>        call domain_setsame(adomain,ldomain)
<LI>     endif
<LI> 
<LI>+
<LI>     ! Allocate surface grid dynamic memory (for wtxy and vegxy arrays)
<LI> 
<LI>     call get_proc_bounds    (begg    , endg)
<LI>@@ -307,10 +362,15 @@
<LI>        write(6,*)'initialize allocation error'; call endrun()
<LI>     endif
<LI> 
<LI>+
<LI>+
<LI>     ! Read surface dataset and set up vegetation type [vegxy] and 
<LI>     ! weight [wtxy] arrays for [maxpatch] subgrid patches.
<LI>-    
<LI>-    call surfrd (fsurdat, ldomain)
<LI>+!  abt rcm below    
<LI>+!    call surfrd (fsurdat, ldomain)
<LI>+    call rcmsurfrd (mksrf_flanwat,mksrf_fglacier,mksrf_furban,   &
<LI>+                    mksrf_fsoitex,mksrf_fvegtyp,ldomain)
<LI>+!  abt rcm below
<LI> 
<LI>     call decomp_glcp_init(alatlon%ns,alatlon%ni,alatlon%nj,llatlon%ns,llatlon%ni,llatlon%nj)
<LI> 
<LI>@@ -383,6 +443,9 @@
<LI>     use clm_time_manager, only : get_curr_date, get_nstep, advance_timestep, &
<LI>                                  timemgr_init, timemgr_restart_io, timemgr_restart
<LI>     use fileutils       , only : getfil
<LI>+#if (defined VOC)
<LI>+    use clm_varvoc      , only : n_start
<LI>+#endif
<LI> !
<LI> ! !ARGUMENTS:
<LI>    type(eshr_timeMgr_clockType), optional, intent(IN) :: SyncClock ! Synchronization clock
<LI>@@ -594,11 +657,11 @@
<LI>     ! ------------------------------------------------------------------------
<LI>     ! Start offline run at nstep = 1
<LI>     ! ------------------------------------------------------------------------
<LI>-
<LI>-#if (defined OFFLINE)
<LI>-    if (nsrest == 0) call advance_timestep()
<LI>-#endif
<LI>-
<LI>+! c abt rcm below
<LI>+!#if (defined OFFLINE)
<LI>+!    if (nsrest == 0) call advance_timestep()
<LI>+!#endif
<LI>+! c abt rcm above !!!! advance timestep later
<LI>     ! ------------------------------------------------------------------------
<LI>     ! Initialization of model parameterizations that are needed after
<LI>     ! restart file is read in
<LI>@@ -624,7 +687,8 @@
<LI>     ! restart data read above. Note that routine htapes_build needs time manager 
<LI>     ! information, so this call must be made after the restart information has been read.
<LI> 
<LI>-    if (nsrest == 0 .or. nsrest == 3) call htapes_build ()
<LI>+!abt commented    if (nsrest == 0 .or. nsrest == 3) call htapes_build ()
<LI>+    call htapes_build ()
<LI> 
<LI>     ! Initialize clmtype variables that are obtained from accumulated fields.
<LI>     ! This routine is called in an initial run at nstep=0 for cam and csm mode
<LI>@@ -662,6 +726,12 @@
<LI> !$OMP END PARALLEL DO
<LI> #endif
<LI> 
<LI>+!abt added below
<LI>+#if (defined VOC)
<LI>+    n_start = get_nstep()
<LI>+#endif
<LI>+!abt added above
<LI>+
<LI>     ! End initialization
<LI> 
<LI>     if (masterproc) then
</OL>
</PRE>

<HR>

</BODY>
</HTML>

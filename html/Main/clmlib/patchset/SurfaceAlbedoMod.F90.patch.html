<HTML>

<HEAD>
<TITLE>SurfaceAlbedoMod.F90.patch</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>clmlib/patchset/SurfaceAlbedoMod.F90.patch</H1>
<HR>
<H2 ALIGN=CENTER>SurfaceAlbedoMod.F90.patch</H2>
<HR>
</FONT>

<HR>

<PRE>
<OL>
<LI>--- orig/SurfaceAlbedoMod.F90	2010-03-10 16:34:21.000000000 +0100
<LI>+++ patchd/SurfaceAlbedoMod.F90	2010-03-10 16:30:48.038638375 +0100
<LI>@@ -61,6 +61,12 @@
<LI>     use clm_varpar      , only : numrad
<LI>     use shr_orb_mod
<LI>     use clm_time_manager, only : get_nstep
<LI>+    use decompMod       , only : ldecomp
<LI>+!abt added below
<LI>+!    use clm_varsur      , only : c2rcosz1d
<LI>+!abt added above
<LI>+    use mod_clm
<LI>+    use mod_dynparam
<LI> !
<LI> ! !ARGUMENTS:
<LI>     implicit none
<LI>@@ -145,6 +151,11 @@
<LI>     integer  :: num_novegsol               ! number of vegetated pfts where coszen>0
<LI>     integer  :: filter_novegsol(ubp-lbp+1) ! pft filter where vegetated and coszen>0
<LI>     integer  :: num_solar                  ! number of gridcells where coszen>0
<LI>+!rcm abt below
<LI>+    integer  :: i,j,ns,jy    
<LI>+    real(r8),allocatable :: r2cxlat1d(:)
<LI>+    real(r8),allocatable :: r2cxlon1d(:)
<LI>+!rcm above
<LI>   !-----------------------------------------------------------------------
<LI> 
<LI>     ! Assign local pointers to derived subtypes components (gridcell-level)
<LI>@@ -194,10 +205,20 @@
<LI> 
<LI> !dir$ concurrent
<LI> !cdir nodep
<LI>+!!!!!!!!!! rcm abt below
<LI>+
<LI>     do g = lbg, ubg
<LI>-       coszen_gcell(g) = shr_orb_cosz (caldayp1, lat(g), lon(g), declinp1)
<LI>+       i = ldecomp%gdc2i(g)
<LI>+       j = ldecomp%gdc2j(g)
<LI>+!       coszen_gcell(g) = shr_orb_cosz (caldayp1, lat(g), lon(g), declinp1)
<LI>+       coszen_gcell(g) = shr_orb_cosz (caldayp1, r2cxlat_all(i,j), r2cxlon_all(i,j), &
<LI>+                                       declinp1)
<LI>+!       c2rcosz1d(g) = max(0.d0,coszen_gcell(g))
<LI>+       c2rcosz(i,j) = max(0.d0,coszen_gcell(g))
<LI>     end do
<LI> 
<LI>+!!!!!!!!!!!!!!!!! rcm above
<LI>+
<LI>     ! Save coszen and declination values to  clm3 data structures for
<LI>     ! use in other places in the CN code
<LI> 
</OL>
</PRE>

<HR>

</BODY>
</HTML>

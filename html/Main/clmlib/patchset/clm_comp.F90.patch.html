<HTML>

<HEAD>
<TITLE>clm_comp.F90.patch</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>clmlib/patchset/clm_comp.F90.patch</H1>
<HR>
<H2 ALIGN=CENTER>clm_comp.F90.patch</H2>
<HR>
</FONT>

<HR>

<PRE>
<OL>
<LI>--- orig/clm_comp.F90	2010-03-10 16:34:21.000000000 +0100
<LI>+++ patchd/clm_comp.F90	2010-03-10 16:21:26.738638750 +0100
<LI>@@ -28,7 +28,7 @@
<LI> ! !IROUTINE: clm_init0
<LI> !
<LI> ! !INTERFACE:
<LI>-  subroutine clm_init0( CCSMInit )
<LI>+  subroutine clm_init0(CCSMInit)
<LI> !
<LI> ! !DESCRIPTION:
<LI> ! Initialize land surface model and obtain relevant atmospheric model arrays
<LI>@@ -51,7 +51,7 @@
<LI> 
<LI>     call t_startf('clm_init0')
<LI>     if ( present(CCSMInit) )then
<LI>-       call initialize1( CCSMInit )
<LI>+       call initialize1(CCSMInit)
<LI>     else
<LI>        call initialize1( )
<LI>     end if
<LI>@@ -145,6 +145,7 @@
<LI>           call shr_orb_decl( calday, eccen, mvelpp, lambm0, obliqr, declin, eccf )
<LI>           
<LI>           dtime = get_step_size()
<LI>+
<LI>           caldaym1 = get_curr_calday(offset=-int(dtime))
<LI>           call shr_orb_decl( caldaym1, eccen, mvelpp, lambm0, obliqr, declinm1, eccf )
<LI>           
<LI>@@ -166,7 +167,8 @@
<LI> ! !IROUTINE: clm_run1
<LI> !
<LI> ! !INTERFACE:
<LI>-  subroutine clm_run1( nextsw_cday, dosend )
<LI>+!  subroutine clm_run1( nextsw_cday, dosend )
<LI>+  subroutine clm_run1( doalb, eccen, obliqr, lambm0, mvelpp)
<LI> !
<LI> ! !DESCRIPTION:
<LI> ! land model run1 phase
<LI>@@ -175,18 +177,30 @@
<LI>     use shr_orb_mod     , only : shr_orb_decl
<LI>     use clm_varctl      , only : irad 
<LI>     use clm_time_manager, only : get_nstep, get_step_size, get_curr_calday
<LI>-    use clm_varorb      , only : eccen, mvelpp, lambm0, obliqr
<LI>+!    use clm_varorb      , only : eccen, mvelpp, lambm0, obliqr
<LI>     use driver          , only : driver1
<LI>     use clm_atmlnd      , only : clm_map2gcell
<LI>+    use mod_clm
<LI>+    use mod_dynparam
<LI> !
<LI> ! !ARGUMENTS:
<LI>-    real(r8), intent(in) , optional :: nextsw_cday
<LI>-    logical , intent(out), optional :: dosend
<LI>+!    real(r8), intent(in) , optional :: nextsw_cday
<LI>+!    logical , intent(out), optional :: dosend
<LI>+!c abt rcm below
<LI>+    logical , intent(in) :: doalb  !true if time for surface albedo
<LI>+                                   !calculation
<LI>+    real(r8), intent(in) :: eccen  !Earth's orbital eccentricity
<LI>+    real(r8), intent(in) :: obliqr !Earth's obliquity in radians
<LI>+    real(r8), intent(in) :: lambm0 !Mean longitude of perihelion at the
<LI>+                                   !vernal equinox (radians)
<LI>+    real(r8), intent(in) :: mvelpp !Earth's moving vernal equinox longitude
<LI>+                                   !of perihelion + pi (radians)
<LI>+!c abt rcm above
<LI> !
<LI> ! !LOCAL VARIABLES:
<LI>     integer  :: nstep                 ! model time step
<LI>     integer  :: dtime                 ! time step increment (sec)
<LI>-    logical  :: doalb                 ! true if surface albedo calculation time step from atm
<LI>+!    logical  :: doalb                 ! true if surface albedo calculation time step from atm
<LI>     real(r8) :: caldayp1_clm          ! calendar day for nstep+1 for clm (debug need only)
<LI>     real(r8) :: caldayp1              ! calendar day for nstep+1
<LI>     real(r8) :: declinp1              ! solar declination angle in radians for nstep+1
<LI>@@ -194,7 +208,7 @@
<LI> !
<LI> ! !REVISION HISTORY:
<LI> ! Author: Mariana Vertenstein
<LI>-!
<LI>+! 2008.5.8    A Tawfik Revised to work with RegCM
<LI> !EOP
<LI> !---------------------------------------------------------------------------
<LI> 
<LI>@@ -202,23 +216,26 @@
<LI> 
<LI>     ! Determine doalb (true when the next time step is a radiation time step) 
<LI> 
<LI>-    nstep = get_nstep()
<LI>-    doalb = ((irad==1) .or. (mod(nstep,irad)==0 .and. nstep/=0))
<LI>+!   nstep = get_nstep()
<LI>+!abt    nstep = r2cnstep
<LI>+
<LI>+!abt    doalb = ((irad==1) .or. (mod(nstep,irad)==0 .and. nstep/=0))
<LI>     dtime = get_step_size()
<LI>+!abt    dtime = r2cdtime
<LI> 
<LI>-    if (present(nextsw_cday) .and. present(dosend)) then
<LI>-       caldayp1 = nextsw_cday
<LI>-       if (doalb) then
<LI>-          caldayp1_clm = get_curr_calday( offset=dtime )
<LI>-          if (caldayp1_clm /= caldayp1) then
<LI>-             write(6,*)'caldayp1_atm= ',nextsw_cday,' caldayp1_atm= ',caldayp1_clm
<LI>-             call shr_sys_abort('caldayp1 from atm and clm do not match')
<LI>-          end if
<LI>-       end if
<LI>-       dosend = doalb
<LI>-    else
<LI>+!    if (present(nextsw_cday) .and. present(dosend)) then
<LI>+!       caldayp1 = nextsw_cday
<LI>+!       if (doalb) then
<LI>+!          caldayp1_clm = get_curr_calday( offset=dtime )
<LI>+!          if (caldayp1_clm /= caldayp1) then
<LI>+!             write(6,*)'caldayp1_atm= ',nextsw_cday,' caldayp1_atm= ',caldayp1_clm
<LI>+!             call shr_sys_abort('caldayp1 from atm and clm do not match')
<LI>+!          end if
<LI>+!       end if
<LI>+!       dosend = doalb
<LI>+!    else
<LI>        caldayp1 = get_curr_calday( offset=int(dtime) )
<LI>-    endif
<LI>+!    endif
<LI> 
<LI>     ! Determine declination angle for next time step
<LI>     
<LI>@@ -246,7 +263,8 @@
<LI> ! !IROUTINE: clm_run2
<LI> !
<LI> ! !INTERFACE:
<LI>-  subroutine clm_run2(rstwr)
<LI>+!  subroutine clm_run2(rstwr)
<LI>+   subroutine clm_run2(eccen, obliqr, lambm0, mvelpp, rstwr)
<LI> !
<LI> ! !DESCRIPTION:
<LI> ! land model run2 phase
<LI>@@ -254,14 +272,26 @@
<LI> ! !USES:
<LI>     use shr_orb_mod     , only : shr_orb_decl
<LI>     use clm_time_manager, only : get_nstep, get_step_size, get_curr_calday
<LI>-    use clm_varorb      , only : eccen, mvelpp, lambm0, obliqr
<LI>+ !   use clm_varorb      , only : eccen, mvelpp, lambm0, obliqr
<LI>     use driver          , only : driver2
<LI>+    use mod_clm
<LI>+    use mod_dynparam
<LI> !
<LI> ! !ARGUMENTS:
<LI>     logical,optional,intent(in) :: rstwr    ! true => write restart file this step
<LI>+!c abt rcm below
<LI>+  real(r8), intent(in) :: eccen  !Earth's orbital eccentricity
<LI>+  real(r8), intent(in) :: obliqr !Earth's obliquity in radians
<LI>+  real(r8), intent(in) :: lambm0 !Mean longitude of perihelion at the
<LI>+                                 !vernal equinox (radians)
<LI>+  real(r8), intent(in) :: mvelpp !Earth's moving vernal equinox longitude
<LI>+                                 !of perihelion + pi (radians)
<LI>+!c abt rcm above
<LI> !
<LI> ! !REVISION HISTORY:
<LI> ! Author: Mariana Vertenstein
<LI>+! 2008.5.8    A Tawfik Revised to work with RegCM
<LI>+!
<LI> !
<LI> !EOP
<LI> !
</OL>
</PRE>

<HR>

</BODY>
</HTML>

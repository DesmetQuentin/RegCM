<HTML>

<HEAD>
<TITLE>chsrfem.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>chsrfem.F90</H1>
<HR>
<H2 ALIGN=CENTER>chsrfem.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=chsrfem><H3>chsrfem</H3></a></p> Click <a href="./callingtree/chsrfem_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where chsrfem is used.
<hr>
20:       subroutine chsrfem
21: 
22:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
23:       use <a href="./mod_mainchem.F90.html#mod_mainchem" TARGET=CENT_PANEL>mod_mainchem</a>
24:       use <a href="./mod_trachem.F90.html#mod_trachem" TARGET=CENT_PANEL>mod_trachem</a>
25:       use <a href="./mod_dust.F90.html#mod_dust" TARGET=CENT_PANEL>mod_dust</a>
26:       use <a href="./mod_iunits.f90.html#mod_iunits" TARGET=CENT_PANEL>mod_iunits</a>
27:       use <a href="./mod_aerosol.F90.html#mod_aerosol" TARGET=CENT_PANEL>mod_aerosol</a> , only : dgmix , dssamix , dextmix
28:       use <a href="./mod_message.F90.html#mod_message" TARGET=CENT_PANEL>mod_message</a>
29: #ifdef MPP1
30:       use <a href="./mod_mppio.F90.html#mod_mppio" TARGET=CENT_PANEL>mod_mppio</a>
31: #ifndef IBM
32:       use <a href="#" TARGET=CENT_PANEL>mpi</a>
33: #else 
34:       include 'mpif.h'
35: #endif 
36: #ifdef CLM
37: !      use surfrdMod , only : clm_getsoitex
38: !      use clm_varsur, only : clm_soitex
39: #endif
40: #endif
41:       implicit none
42: !
43: ! Local variables
44: !
45:       character(5) :: aerctl
46:       integer :: i , itr , j , k , l , m , n
47:       logical :: rd_tex , there
48:       real(4) , dimension(iy,jx) :: toto
49: #ifdef MPP1
50:       integer :: ierr
51: #endif
52: !
53:       rd_tex = .false.
54: #ifdef MPP1
55:       if ( myid.eq.0 ) then
56:         do itr = 1 , ntr
57:           aerctl = chtrname(itr)
58:           if ( aerctl(1:4).eq.'DUST' ) then
59:             rd_tex = .true.
60:             exit
61:           end if
62:         end do
63:       end if
64: #else
65:       do itr = 1 , ntr
66:         aerctl = chtrname(itr)
67:         if ( aerctl(1:4).eq.'DUST' ) then
68:           rd_tex = .true.
69:           exit
70:         end if
71:       end do
72: #endif
73: 
74: #ifdef MPP1
75:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(rd_tex,1,mpi_logical,0,mpi_comm_world,ierr)
76:       if ( myid.eq.0 ) then
77:         do itr = 1 , ntr
78:           aerctl = chtrname(itr)
79:           print * , itr , aerctl
80:           if ( aerctl(1:4).ne.'DUST' .and. aertyp(4:5).ne.'00' ) then
81:             open (unit=iutchsrc,file=trim(dirglob)//pthsep//            &
82:                 & trim(domname)//'_AERO.dat',status='old',              &
83:                 & form='unformatted',access='direct',recl=iy*jx*ibyte)
84:             if ( aerctl(1:3).eq.'SO2' ) then
85:               if ( aertyp(4:4).eq.'1' ) then
86:                 read (iutchsrc,rec=1) ((toto(i,j),j=1,jx),i=1,iy)
87:                 do m = 1 , 12
88:                   do j = 1 , jx
89:                     do i = 1 , iy
90:                       chemsrc_io(i,j,m,itr) = toto(i,j)
91:                     end do
92:                   end do
93:                 end do
94:               else
95:                 do m = 1 , 12
96:                   do j = 1 , jx
97:                     do i = 1 , iy
98:                       chemsrc_io(i,j,m,itr) = 0.0D0
99:                     end do
100:                   end do
101:                 end do
102:               end if
103:               if ( aertyp(5:5).eq.'1' ) then
104:                 do m = 1 , 12
105:                   read (iutchsrc,rec=3+m) ((toto(i,j),j=1,jx),i=1,iy)
106:                   do j = 1 , jx
107:                     do i = 1 , iy
108:                       chemsrc_io(i,j,m,itr) = chemsrc_io(i,j,m,itr)     &
109:                       & + toto(i,j)
110:                     end do
111:                   end do
112:                 end do
113:               end if
114:             else if ( aerctl(1:2).eq.'BC' ) then
115:               if ( aertyp(4:4).eq.'1' ) then
116:                 read (iutchsrc,rec=2) ((toto(i,j),j=1,jx),i=1,iy)
117:                 do m = 1 , 12
118:                   do j = 1 , jx
119:                     do i = 1 , iy
120:                       chemsrc_io(i,j,m,itr) = toto(i,j)
121:                     end do
122:                   end do
123:                 end do
124:               else
125:                 do m = 1 , 12
126:                   do j = 1 , jx
127:                     do i = 1 , iy
128:                       chemsrc_io(i,j,m,itr) = 0.0D0
129:                     end do
130:                   end do
131:                 end do
132:               end if
133:               if ( aertyp(5:5).eq.'1' ) then
134:                 do m = 1 , 12
135:                   read (iutchsrc,rec=15+m) ((toto(i,j),j=1,jx),i=1,iy)
136:                   do j = 1 , jx
137:                     do i = 1 , iy
138:                       chemsrc_io(i,j,m,itr) = chemsrc_io(i,j,m,itr)     &
139:                       & + toto(i,j)
140:                     end do
141:                   end do
142:                 end do
143:               end if
144:             else if ( aerctl(1:2).eq.'OC' ) then
145:               if ( aertyp(4:4).eq.'1' ) then
146:                 read (iutchsrc,rec=3) ((toto(i,j),j=1,jx),i=1,iy)
147:                 do m = 1 , 12
148:                   do j = 1 , jx
149:                     do i = 1 , iy
150:                       chemsrc_io(i,j,m,itr) = toto(i,j)
151:                     end do
152:                   end do
153:                 end do
154:               else
155:                 do m = 1 , 12
156:                   do j = 1 , jx
157:                     do i = 1 , iy
158:                       chemsrc_io(i,j,m,itr) = 0.0D0
159:                     end do
160:                   end do
161:                 end do
162:               end if
163:               if ( aertyp(5:5).eq.'1' ) then
164:                 do m = 1 , 12
165:                   read (iutchsrc,rec=27+m) ((toto(i,j),j=1,jx),i=1,iy)
166:                   do j = 1 , jx
167:                     do i = 1 , iy
168:                       chemsrc_io(i,j,m,itr) = chemsrc_io(i,j,m,itr)     &
169:                       & + toto(i,j)
170:                     end do
171:                   end do
172:                 end do
173:               end if
174:             else
175:             end if
176:           end if
177:         end do
178:         do j = 1 , jx
179:           do itr = 1 , ntr
180:             do m = 1 , 12
181:               do i = 1 , iy
182:                 src_0(i,m,itr,j) = chemsrc_io(i,j,m,itr)
183:               end do
184:             end do
185:           end do
186:         end do
187:       end if
188: !     call MPI_BARRIER(MPI_COMM_WORLD,ierr)
189:       call <a href="#" TARGET=CENT_PANEL>mpi_scatter</a>(src_0(1,1,1,1),iy*12*ntr*jxp,mpi_real8,          &
190:                      & src0(1,1,1,1), iy*12*ntr*jxp,mpi_real8,          &
191:                      & 0,mpi_comm_world,ierr)
192:       do j = 1 , jendl
193:         do itr = 1 , ntr
194:           do m = 1 , 12
195:             do i = 1 , iy
196:               chemsrc(i,j,m,itr) = src0(i,m,itr,j)
197:             end do
198:           end do
199:         end do
200:       end do
201: #else
202:       do itr = 1 , ntr
203:         aerctl = chtrname(itr)
204:         print * , itr , aerctl
205:         if ( aerctl(1:4).ne.'DUST' .and. aertyp(4:5).ne.'00' ) then
206:           open (unit=iutchsrc,file=trim(dirglob)//pthsep//              &
207:               & trim(domname)//'_AERO.dat',status='old',                &
208:               & form='unformatted',access='direct',recl=iy*jx*ibyte)
209:           if ( aerctl(1:3).eq.'SO2' ) then
210:             if ( aertyp(4:4).eq.'1' ) then
211:               read (iutchsrc,rec=1) ((toto(i,j),j=1,jx),i=1,iy)
212:               do m = 1 , 12
213:                 do j = 1 , jx
214:                   do i = 1 , iy
215:                     chemsrc(i,j,m,itr) = toto(i,j)
216:                   end do
217:                 end do
218:               end do
219:             else
220:               do m = 1 , 12
221:                 do j = 1 , jx
222:                   do i = 1 , iy
223:                     chemsrc(i,j,m,itr) = 0.0D0
224:                   end do
225:                 end do
226:               end do
227:             end if
228:             if ( aertyp(5:5).eq.'1' ) then
229:               do m = 1 , 12
230:                 read (iutchsrc,rec=3+m) ((toto(i,j),j=1,jx),i=1,iy)
231:                 do j = 1 , jx
232:                   do i = 1 , iy
233:                     chemsrc(i,j,m,itr) = chemsrc(i,j,m,itr) + toto(i,j)
234:                   end do
235:                 end do
236:               end do
237:             end if
238:           else if ( aerctl(1:2).eq.'BC' ) then
239:             if ( aertyp(4:4).eq.'1' ) then
240:               read (iutchsrc,rec=2) ((toto(i,j),j=1,jx),i=1,iy)
241:               do m = 1 , 12
242:                 do j = 1 , jx
243:                   do i = 1 , iy
244:                     chemsrc(i,j,m,itr) = toto(i,j)
245:                   end do
246:                 end do
247:               end do
248:             else
249:               do m = 1 , 12
250:                 do j = 1 , jx
251:                   do i = 1 , iy
252:                     chemsrc(i,j,m,itr) = 0.0D0
253:                   end do
254:                 end do
255:               end do
256:             end if
257:             if ( aertyp(5:5).eq.'1' ) then
258:               do m = 1 , 12
259:                 read (iutchsrc,rec=15+m) ((toto(i,j),j=1,jx),i=1,iy)
260:                 do j = 1 , jx
261:                   do i = 1 , iy
262:                     chemsrc(i,j,m,itr) = chemsrc(i,j,m,itr) + toto(i,j)
263:                   end do
264:                 end do
265:               end do
266:             end if
267:           else if ( aerctl(1:2).eq.'OC' ) then
268:             if ( aertyp(4:4).eq.'1' ) then
269:               read (iutchsrc,rec=3) ((toto(i,j),j=1,jx),i=1,iy)
270:               do m = 1 , 12
271:                 do j = 1 , jx
272:                   do i = 1 , iy
273:                     chemsrc(i,j,m,itr) = toto(i,j)
274:                   end do
275:                 end do
276:               end do
277:             else
278:               do m = 1 , 12
279:                 do j = 1 , jx
280:                   do i = 1 , iy
281:                     chemsrc(i,j,m,itr) = 0.0D0
282:                   end do
283:                 end do
284:               end do
285:             end if
286:             if ( aertyp(5:5).eq.'1' ) then
287:               do m = 1 , 12
288:                 read (iutchsrc,rec=27+m) ((toto(i,j),j=1,jx),i=1,iy)
289:                 do j = 1 , jx
290:                   do i = 1 , iy
291:                     chemsrc(i,j,m,itr) = chemsrc(i,j,m,itr) + toto(i,j)
292:                   end do
293:                 end do
294:               end do
295:             end if
296:           else
297:           end if
298:         end if
299:       end do
300: #endif
301:  
302: !     modification dust : read the soil texture type
303: 
304: #ifdef MPP1
305: #ifdef CLM
306: !      if ( myid.eq.0 ) then
307: !        if ( rd_tex ) then
308: !          call clm_getsoitex()
309: !          do j = 1 , jx
310: !            do i = 1 , iy
311: !              dustsotex_io(i,j) = clm_soitex(i,j)
312: !            end do
313: !          end do
314: !        end if
315: !      end if
316: !      if ( allocated(clm_soitex) ) deallocate(clm_soitex)
317: #else
318:       if ( myid.eq.0 ) then
319:         if ( rd_tex ) then
320:           if ( lsmtyp.eq.'BATS' ) then
321:             read (iutin,rec=14) ((toto(i,j),j=1,jx),i=1,iy)
322:           else if ( lsmtyp.eq.'USGS' ) then
323:             read (iutin,rec=43) ((toto(i,j),j=1,jx),i=1,iy)
324:           else
325:           end if
326:           close (iutin)
327:           do j = 1 , jx
328:             do i = 1 , iy
329:               dustsotex_io(i,j) = dble(toto(i,j))
330:             end do
331:           end do
332:         end if
333:       end if
334: !     call MPI_BARRIER(MPI_COMM_WORLD,ierr)
335: #endif
336:       call <a href="#" TARGET=CENT_PANEL>mpi_scatter</a>(dustsotex_io(1,1),iy*jxp,mpi_real8,              &
337:                      & dustsotex(1,1),iy*jxp,mpi_real8,0,               &
338:                      & mpi_comm_world,ierr)
339: #else
340:       if ( rd_tex ) then
341:         if ( lsmtyp.eq.'BATS' ) then
342:           read (iutin,rec=14) ((toto(i,j),j=1,jx),i=1,iy)
343:         else if ( lsmtyp.eq.'USGS' ) then
344:           read (iutin,rec=43) ((toto(i,j),j=1,jx),i=1,iy)
345:         else
346:         end if
347:         close (iutin)
348:         do j = 1 , jx
349:           do i = 1 , iy
350:             dustsotex(i,j) = dble(toto(i,j))
351:           end do
352:         end do
353:       end if
354: #endif
355: 
356:       if ( rd_tex ) call <a href="./mod_dust.F90.html#inidust" TARGET=CENT_PANEL>inidust</a>
357:  
358: !     sulfates sources
359:       do m = 1 , 12
360: #ifdef MPP1
361:         do j = 1 , jendl
362: #else
363:         do j = 1 , jx
364: #endif
365:           do i = 1 , iy
366:             if ( iso4.gt.0 ) chemsrc(i,j,m,iso4)                        &
367:                & = 0.02*chemsrc(i,j,m,iso2)
368:             if ( iso2.gt.0 ) chemsrc(i,j,m,iso2)                        &
369:                & = 0.98*chemsrc(i,j,m,iso2)
370:  
371: !           partition hydrophilic hydrophonic ( cooke et al.1999)
372: !           BC
373:             if ( ibchb.gt.0 .and. ibchl.gt.0 ) then
374:               chemsrc(i,j,m,ibchl) = 0.2*chemsrc(i,j,m,ibchb)
375:               chemsrc(i,j,m,ibchb) = 0.8*chemsrc(i,j,m,ibchb)
376:             end if
377: !           OC
378:             if ( iochb.gt.0 .and. iochl.gt.0 ) then
379:               chemsrc(i,j,m,iochl) = 0.5*chemsrc(i,j,m,iochb)
380:               chemsrc(i,j,m,iochb) = 0.5*chemsrc(i,j,m,iochb)
381:             end if
382:           end do
383:         end do
384:       end do
385:  
386: !     OPtical properties / internal mixing
387:       if ( mixtype.eq.2 ) then
388: #ifdef MPP1
389:         if ( myid.eq.0 ) then
390:           inquire (file='optdat.bin',exist=there)
391:           if ( .not.there ) then
392:             write (*,*) 'For mixtype=2, optdat.bin is required'
393:             write (*,*) 'ln -s ../Main/Commons/optdat.bin optdat.bin'
394:             call <a href="./mod_message.F90.html#fatal" TARGET=CENT_PANEL>fatal</a>(__FILE__,__LINE__,'optdat.bin is required')
395:           end if
396:           open (iutopt,file='optdat.bin',form='unformatted',            &
397:               & recl=4*19*11*11*11*11*ibyte,access='direct')
398:           read (iutopt,rec=1) ((((((dextmix(i,j,k,l,m,n),i=1,4),j=1,19),&
399:                             & k=1,11),l=1,11),m=1,11),n=1,11)
400:           read (iutopt,rec=2) ((((((dssamix(i,j,k,l,m,n),i=1,4),j=1,19),&
401:                             & k=1,11),l=1,11),m=1,11),n=1,11)
402:           read (iutopt,rec=3) ((((((dgmix(i,j,k,l,m,n),i=1,4),j=1,19),k=&
403:                             & 1,11),l=1,11),m=1,11),n=1,11)
404:           close (iutopt)
405:         end if
406:         call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(dextmix,4*19*11*11*11*11,mpi_real,0,             &
407:                      & mpi_comm_world,ierr)
408:         call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(dssamix,4*19*11*11*11*11,mpi_real,0,             &
409:                      & mpi_comm_world,ierr)
410:         call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(dgmix,4*19*11*11*11*11,mpi_real,0,mpi_comm_world,&
411:                      & ierr)
412: #else
413:         inquire (file='optdat.bin',exist=there)
414:         if ( .not.there ) then
415:           write (*,*) 'For mixtype=2, optdat.bin is required'
416:           write (*,*) 'ln -s ../Main/Commons/optdat.bin optdat.bin'
417:           call <a href="./mod_message.F90.html#fatal" TARGET=CENT_PANEL>fatal</a>(__FILE__,__LINE__,'optdat.bin is required')
418:         end if
419:         open (iutopt,file='optdat.bin',form='unformatted',              &
420:             & recl=4*19*11*11*11*11*ibyte,access='direct')
421:         read (iutopt,rec=1) ((((((dextmix(i,j,k,l,m,n),i=1,4),j=1,19),k=&
422:                           & 1,11),l=1,11),m=1,11),n=1,11)
423:         read (iutopt,rec=2) ((((((dssamix(i,j,k,l,m,n),i=1,4),j=1,19),k=&
424:                           & 1,11),l=1,11),m=1,11),n=1,11)
425:         read (iutopt,rec=3) ((((((dgmix(i,j,k,l,m,n),i=1,4),j=1,19),k=1,&
426:                           & 11),l=1,11),m=1,11),n=1,11)
427:         close (iutopt)
428: #endif
429:  
430: !       Check !
431:  
432:         do k = 1 , 11
433:           do l = 1 , 11
434:             do m = 1 , 11
435:               do n = 1 , 11
436:  
437:                 if ( k+l+m+n.eq.14 ) then
438:                   do i = 1 , 4
439:                     do j = 1 , 19
440:  
441:                       if ( (dextmix(i,j,k,l,m,n).lt.0.) .or.            &
442:                          & (dextmix(i,j,k,l,m,n).gt.20.) ) then
443:                         write (aline,*) 'problem in dextmix ' ,         &
444:                                       & dextmix(i,j,k,l,m,n)
445:                         call <a href="./mod_message.F90.html#say" TARGET=CENT_PANEL>say</a>
446:                         call <a href="./mod_message.F90.html#fatal" TARGET=CENT_PANEL>fatal</a>(__FILE__,__LINE__,'DETMIX ERROR')
447:                       end if
448:  
449:                       if ( (dssamix(i,j,k,l,m,n).lt.0.) .or.            &
450:                          & (dssamix(i,j,k,l,m,n).gt.1.) ) then
451:                         write (aline,*) 'problem in dssamix ' ,         &
452:                                       & dssamix(i,j,k,l,m,n)
453:                         call <a href="./mod_message.F90.html#say" TARGET=CENT_PANEL>say</a>
454:                         call <a href="./mod_message.F90.html#fatal" TARGET=CENT_PANEL>fatal</a>(__FILE__,__LINE__,'DSSAMIX ERROR')
455:                       end if
456:  
457:                       if ( (dgmix(i,j,k,l,m,n).lt.0.) .or.              &
458:                          & (dgmix(i,j,k,l,m,n).gt.1.) ) then
459:                         write (aline,*) 'problem in dgmix ' ,           &
460:                                       & dgmix(i,j,k,l,m,n)
461:                         call <a href="./mod_message.F90.html#say" TARGET=CENT_PANEL>say</a>
462:                         call <a href="./mod_message.F90.html#fatal" TARGET=CENT_PANEL>fatal</a>(__FILE__,__LINE__,'DGMIX ERROR')
463:                       end if
464:  
465:                     end do
466:                   end do
467:                 end if
468:  
469:               end do
470:             end do
471:           end do
472:         end do
473:  
474: #ifdef MPP1
475:         if ( myid.eq.0 ) write (*,*) '! OPDATA CHECKED !'
476: #else
477:         write (*,*) '! OPDATA CHECKED !'
478: #endif
479:       end if
480:       end subroutine chsrfem
</PRE>

<HR>

</BODY>
</HTML>

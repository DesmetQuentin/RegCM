<HTML>

<HEAD>
<TITLE>tracdiag.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>tracdiag.F90</H1>
<HR>
<H2 ALIGN=CENTER>tracdiag.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=tracdiag><H3>tracdiag</H3></a></p> Click <a href="./callingtree/tracdiag_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where tracdiag is used.
<hr>
20:       subroutine tracdiag(xkc)
21:  
22:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
23:       use <a href="./mod_param1.f90.html#mod_param1" TARGET=CENT_PANEL>mod_param1</a>
24:       use <a href="./mod_param3.f90.html#mod_param3" TARGET=CENT_PANEL>mod_param3</a> , only : dsigma
25:       use <a href="./mod_diagnosis.f90.html#mod_diagnosis" TARGET=CENT_PANEL>mod_diagnosis</a>
26:       use <a href="./mod_main.F90.html#mod_main" TARGET=CENT_PANEL>mod_main</a>
27:       use <a href="./mod_mainchem.F90.html#mod_mainchem" TARGET=CENT_PANEL>mod_mainchem</a>
28:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rgti
29: #ifdef MPP1
30:       use <a href="./mod_mppio.F90.html#mod_mppio" TARGET=CENT_PANEL>mod_mppio</a>
31:       use <a href="#" TARGET=CENT_PANEL>mpi</a>
32: #endif
33:       implicit none
34: !
35: ! Dummy arguments
36: !
37: #ifdef MPP1
38:       real(8) , dimension(iy,kz,jxp) :: xkc
39: #else
40:       real(8) , dimension(iy,kz,jx) :: xkc
41: #endif
42:       intent (in) xkc
43: !
44: ! Local variables
45: !
46: #ifdef MPP1
47:       integer :: ierr
48:       real(8) , dimension(kz,ntr,jxp) :: chia01 , chia02 , chiaill ,    &
49:            & chiaill1
50:       real(8) , dimension(kz,ntr,jx) :: chia01_g , chia02_g ,           &
51:            & chiaill1_g , chiaill_g
52:       real(8) , dimension(jxp) :: psa01 , psa02 , psaill , psaill1
53:       real(8) , dimension(jx) :: psa01_g , psa02_g , psaill1_g ,        &
54:                                 & psaill_g
55:       real(8) , dimension(kz,jxp) :: va02 , vaill , xkc02 , xkcill1
56:       real(8) , dimension(kz,jx) :: va02_g , vaill_g , xkc02_g ,        &
57:                                    & xkcill1_g
58:       real(8) :: chid1 , chid2
59: #endif
60:       real(8) :: fact1 , fact2 , fx1 , fx2 , uavg1 , uavg2 , vavg1 ,    &
61:            &  vavg2
62:       integer :: i , j , k , n
63:       real(8) , dimension(iym1,kz,ntr) :: worka , workb
64: !
65: !     real(kind=8)  chixp1,chiym1,chiyp1,chiym1,chi00,chidx,chidy
66: !     real(kind=8)  chixp2,chiym2,chiyp2,chiym2
67:  
68: !ccccccccccccccccccccccccccccccccccccccccccccccc
69:  
70: !-------------------------
71: !     1  ADVECTION budgets
72: !-----------------------
73:  
74: !-----advection of tracer through lateral boundaries
75:  
76: !
77: !.....advection through east-west boundaries:
78: !
79: !     the 'relaxed' upstream scheme
80:       fact1 = 0.6
81:       fact2 = 1 - fact1
82:  
83: !     inflow/outflow
84: #ifdef MPP1
85:       do n = 1 , ntr
86:         do k = 1 , kz
87:           do i = 2 , iym2
88:             if ( myid.eq.nproc-1 ) then
89:               uavg2 = 0.5*(ua(i+1,k,jendx)+ua(i,k,jendx))
90:               if ( uavg2.lt.0. ) then
91:                 worka(i,k,n) = -uavg2*(fact1*chia(i,k,jendx,n)/psa(i,   &
92:                              & jendx)/(msfx(i,jendx)*msfx(i,jendx))     &
93:                              & +fact2*chia(i,k,jendm,n)/psa(i,jendm)    &
94:                              & /(msfx(i,jendm)*msfx(i,jendm)))
95:               else
96:                 worka(i,k,n) = -uavg2*(fact1*chia(i,k,jendm,n)/psa(i,   &
97:                              & jendm)/(msfx(i,jendm)*msfx(i,jendm))     &
98:                              & +fact2*chia(i,k,jendx,n)/psa(i,jendx)    &
99:                              & /(msfx(i,jendx)*msfx(i,jendx)))
100:               end if
101:             end if
102:             if ( myid.eq.0 ) then
103:               uavg1 = 0.5*(ua(i+1,k,1+1)+ua(i,k,1+1))
104:               if ( uavg1.gt.0. ) then
105:                 workb(i,k,n) = -uavg1*(fact1*chia(i,k,1,n)/psa(i,1)/(   &
106:                              & msfx(i,1)*msfx(i,1))                     &
107:                              & +fact2*chia(i,k,1+1,n)/psa(i,1+1)        &
108:                              & /(msfx(i,1+1)*msfx(i,1+1)))
109:               else
110:                 workb(i,k,n) = -uavg1*(fact1*chia(i,k,1+1,n)/psa(i,1+1) &
111:                              & /(msfx(i,1+1)*msfx(i,1+1))               &
112:                              & +fact2*chia(i,k,1,n)/psa(i,1)            &
113:                              & /(msfx(i,1)*msfx(i,1)))
114:               end if
115:             end if
116:           end do
117:         end do
118:       end do
119:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(worka,iym1*kz*ntr,mpi_real8,nproc-1,               &
120:                    & mpi_comm_world,ierr)
121: #else
122:       do n = 1 , ntr
123:         do k = 1 , kz
124:           do i = 2 , iym2
125:             uavg2 = 0.5*(ua(i+1,k,jxm1)+ua(i,k,jxm1))
126:             if ( uavg2.lt.0. ) then
127:               worka(i,k,n) = -uavg2*(fact1*chia(i,k,jxm1,n)/psa(i,jxm1) &
128:                            & /(msfx(i,jxm1)*msfx(i,jxm1))               &
129:                            & +fact2*chia(i,k,jxm2,n)/psa(i,jxm2)        &
130:                            & /(msfx(i,jxm2)*msfx(i,jxm2)))
131:             else
132:               worka(i,k,n) = -uavg2*(fact1*chia(i,k,jxm2,n)/psa(i,jxm2  &
133:                            & )/(msfx(i,jxm2)*msfx(i,jxm2))              &
134:                            & +fact2*chia(i,k,jxm1,n)/psa(i,jxm1)        &
135:                            & /(msfx(i,jxm1)*msfx(i,jxm1)))
136:             end if
137:  
138:             uavg1 = 0.5*(ua(i+1,k,1+1)+ua(i,k,1+1))
139:             if ( uavg1.gt.0. ) then
140:               workb(i,k,n) = -uavg1*(fact1*chia(i,k,1,n)/psa(i,1)/(msfx(&
141:                            & i,1)*msfx(i,1))+fact2*chia(i,k,1+1,n)      &
142:                            & /psa(i,1+1)/(msfx(i,1+1)*msfx(i,1+1)))
143:             else
144:               workb(i,k,n) = -uavg1*(fact1*chia(i,k,1+1,n)/psa(i,1+1)   &
145:                            & /(msfx(i,1+1)*msfx(i,1+1))                 &
146:                            & +fact2*chia(i,k,1,n)/psa(i,1)              &
147:                            & /(msfx(i,1)*msfx(i,1)))
148:             end if
149:           end do
150:         end do
151:       end do
152: #endif 
153: 
154: #ifdef MPP1
155:       do j = 1 , jendl
156:         do k = 1 , kz
157:           vaill(k,j) = va(iym1,k,j)
158:           va02(k,j) = va(2,k,j)
159:           xkcill1(k,j) = xkc(iym2,k,j)
160:           xkc02(k,j) = xkc(2,k,j)
161:           do n = 1 , ntr
162:             chiaill(k,n,j) = chia(iym1,k,j,n)
163:             chiaill1(k,n,j) = chia(iym2,k,j,n)
164:             chia01(k,n,j) = chia(1,k,j,n)
165:             chia02(k,n,j) = chia(2,k,j,n)
166:           end do
167:         end do
168:         psaill(j) = psa(iym1,j)
169:         psaill1(j) = psa(iym2,j)
170:         psa01(j) = psa(1,j)
171:         psa02(j) = psa(2,j)
172:       end do
173:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(vaill(1,1),  kz*jxp,mpi_real8,                    &
174:                     & vaill_g(1,1),kz*jxp,mpi_real8,                    &
175:                     & 0,mpi_comm_world,ierr)
176:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(va02(1,1),  kz*jxp,mpi_real8,                     &
177:                     & va02_g(1,1),kz*jxp,mpi_real8,                     &
178:                     & 0,mpi_comm_world,ierr)
179:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(xkcill1(1,1),  kz*jxp,mpi_real8,                  &
180:                     & xkcill1_g(1,1),kz*jxp,mpi_real8,                  &
181:                     & 0,mpi_comm_world,ierr)
182:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(xkc02(1,1),  kz*jxp,mpi_real8,                    &
183:                     & xkc02_g(1,1),kz*jxp,mpi_real8,                    &
184:                     & 0,mpi_comm_world,ierr)
185:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(chiaill(1,1,1),  kz*ntr*jxp,mpi_real8,            &
186:                     & chiaill_g(1,1,1),kz*ntr*jxp,mpi_real8,            &
187:                     & 0,mpi_comm_world,ierr)
188:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(chiaill1(1,1,1),  kz*ntr*jxp,mpi_real8,           &
189:                     & chiaill1_g(1,1,1),kz*ntr*jxp,mpi_real8,           &
190:                     & 0,mpi_comm_world,ierr)
191:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(chia01(1,1,1),  kz*ntr*jxp,mpi_real8,             &
192:                     & chia01_g(1,1,1),kz*ntr*jxp,mpi_real8,             &
193:                     & 0,mpi_comm_world,ierr)
194:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(chia02(1,1,1),  kz*ntr*jxp,mpi_real8,             &
195:                     & chia02_g(1,1,1),kz*ntr*jxp,mpi_real8,             &
196:                     & 0,mpi_comm_world,ierr)
197:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(psaill(1),  jxp,mpi_real8,                        &
198:                     & psaill_g(1),jxp,mpi_real8,0,mpi_comm_world,ierr)
199:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(psaill1(1),  jxp,mpi_real8,                       &
200:                     & psaill1_g(1),jxp,mpi_real8,0,mpi_comm_world,ierr)
201:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(psa01(1),  jxp,mpi_real8,                         &
202:                     & psa01_g(1),jxp,mpi_real8,0,mpi_comm_world,ierr)
203:       call <a href="#" TARGET=CENT_PANEL>mpi_gather</a>(psa02(1),  jxp,mpi_real8,                         &
204:                     & psa02_g(1),jxp,mpi_real8,0,mpi_comm_world,ierr)
205:       if ( myid.eq.0 ) then
206:         do n = 1 , ntr
207:           do k = 1 , kz
208:             do i = 2 , iym2
209:               tchiad(n) = tchiad(n) + dtmin*6.E4*dsigma(k)              &
210:                         & *dx*(worka(i,k,n)-workb(i,k,n))*rgti
211:             end do
212:           end do
213: !.....
214: !.....advection through north-south boundaries:
215: !
216:           do k = 1 , kz
217:             do j = 2 , jxm2
218: !hy           inflow/outflow
219:               vavg2 = 0.5*(vaill_g(k,j+1)+vaill_g(k,j))
220:               if ( vavg2.lt.0. ) then
221:                 fx2 = -vavg2*(fact1*chiaill_g(k,n,j)/psaill_g(j)        &
222:                     & /(msfx_io(iym1,j)*msfx_io(iym1,j))                &
223:                     & +fact2*chiaill1_g(k,n,j)/psaill1_g(j)             &
224:                     & /(msfx_io(iym2,j)*msfx_io(iym2,j)))
225:               else
226:                 fx2 = -vavg2*(fact1*chiaill1_g(k,n,j)/psaill1_g(j)      &
227:                     & /(msfx_io(iym2,j)*msfx_io(iym2,j))                &
228:                     & +fact2*chiaill_g(k,n,j)/psaill_g(j)               &
229:                     & /(msfx_io(iym1,j)*msfx_io(iym1,j)))
230:               end if
231:  
232:               vavg1 = 0.5*(va02_g(k,j+1)+va02_g(k,j))
233:               if ( vavg1.gt.0. ) then
234:                 fx1 = -vavg1*(fact1*chia01_g(k,n,j)/psa01_g(j)          &
235:                     & /(msfx_io(1,j)*msfx_io(1,j))+fact2*chia02_g(k,n,j)&
236:                     & /psa02_g(j)/(msfx_io(2,j)*msfx_io(2,j)))
237:               else
238:                 fx1 = -vavg1*(fact1*chia02_g(k,n,j)/psa02_g(j)          &
239:                     & /(msfx_io(2,j)*msfx_io(2,j))+fact2*chia01_g(k,n,j)&
240:                     & /psa01_g(j)/(msfx_io(1,j)*msfx_io(1,j)))
241:               end if
242:               tchiad(n) = tchiad(n) + dtmin*6.E4*dsigma(k)*dx*(fx2-fx1) &
243:                         & *rgti
244:             end do
245:           end do
246:         end do
247:       endif
248:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tchiad,ntr,mpi_real8,0,mpi_comm_world,ierr)
249: #else
250:       do n = 1 , ntr
251:         do k = 1 , kz
252:           do i = 2 , iym2
253:             tchiad(n) = tchiad(n) + dtmin*6.E4*dsigma(k)                &
254:                       & *dx*(worka(i,k,n)-workb(i,k,n))*rgti
255:           end do
256:         end do
257:       end do
258: !.....
259: !.....advection through north-south boundaries:
260: !
261:       do n = 1 , ntr
262:         do k = 1 , kz
263:           do j = 2 , jxm2
264: !hy         inflow/outflow
265:             vavg2 = 0.5*(va(iym1,k,j+1)+va(iym1,k,j))
266:             if ( vavg2.lt.0. ) then
267:               fx2 = -vavg2*(fact1*chia(iym1,k,j,n)/psa(iym1,j)          &
268:                   & /(msfx(iym1,j)*msfx(iym1,j))+fact2*chia(iym2,k,j,n) &
269:                   & /psa(iym2,j)/(msfx(iym2,j)*msfx(iym2,j)))
270:             else
271:               fx2 = -vavg2*(fact1*chia(iym2,k,j,n)/psa(iym2,j)          &
272:                   & /(msfx(iym2,j)*msfx(iym2,j))                        &
273:                   & +fact2*chia(iym1,k,j,n)/psa(iym1,j)                 &
274:                   & /(msfx(iym1,j)*msfx(iym1,j)))
275:             end if
276:  
277:             vavg1 = 0.5*(va(1+1,k,j+1)+va(1+1,k,j))
278:             if ( vavg1.gt.0. ) then
279:               fx1 = -vavg1*(fact1*chia(1,k,j,n)/psa(1,j)                &
280:                   & /(msfx(1,j)*msfx(1,j))+fact2*chia(1+1,k,j,n)        &
281:                   & /psa(1+1,j)/(msfx(1+1,j)*msfx(1+1,j)))
282:             else
283:               fx1 = -vavg1*(fact1*chia(1+1,k,j,n)/psa(1+1,j)            &
284:                   & /(msfx(1+1,j)*msfx(1+1,j))+fact2*chia(1,k,j,n)      &
285:                   & /psa(1,j)/(msfx(1,j)*msfx(1,j)))
286:             end if
287:  
288:             tchiad(n) = tchiad(n) + dtmin*6.E4*dsigma(k)*dx*            &
289:                   & (fx2-fx1)*rgti
290:  
291:           end do
292:         end do
293:       end do
294: #endif
295:  
296: !
297: !..... diffusion through east-west boundaries:
298: !
299: #ifdef MPP1
300:       do n = 1 , ntr
301:         do k = 1 , kz
302:           do i = 2 , iym2
303:             if ( myid.eq.nproc-1 ) worka(i,k,n) = xkc(i,k,jendm)        &
304:                & *psa(i,jendm)                                          &
305:                & *(chia(i,k,jendm,n)/psa(i,jendm)-chia(i,k,jendx,n)     &
306:                & /psa(i,jendx))
307:             if ( myid.eq.0 ) workb(i,k,n) = xkc(i,k,2)*psa(i,2)         &
308:                & *(chia(i,k,2,n)/psa(i,2)-chia(i,k,1,n)/psa(i,1))
309:           end do
310:         end do
311:       end do
312:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(worka,iym1*kz*ntr,mpi_real8,nproc-1,               &
313:                    & mpi_comm_world,ierr)
314: #else
315:       do n = 1 , ntr
316:         do k = 1 , kz
317:           do i = 2 , iym2
318:             worka(i,k,n) = xkc(i,k,jxm2)*psa(i,jxm2)                    &
319:                          & *(chia(i,k,jxm2,n)/psa(i,jxm2)               &
320:                          & -chia(i,k,jxm1,n)/psa(i,jxm1))
321:             workb(i,k,n) = xkc(i,k,2)*psa(i,2)                          &
322:                          & *(chia(i,k,2,n)/psa(i,2)-chia(i,k,1,n)       &
323:                          & /psa(i,1))
324:           end do
325:         end do
326:       end do
327: #endif
328: 
329: #ifdef MPP1
330:       if ( myid.eq.0 ) then
331:         do n = 1 , ntr
332:           do k = 1 , kz
333:             do i = 2 , iym2
334:               tchitb(n) = tchitb(n) - dtmin*6.E4*dsigma(k)              &
335:                         & *(workb(i,k,n)+worka(i,k,n))*rgti
336:             end do
337:           end do
338:  
339: !.....  diffusion through north-south boundaries:
340:  
341:           do k = 1 , kz
342:             do j = 2 , jxm2
343:               chid1 = xkcill1_g(k,j)*psaill1_g(j)                       &
344:                     & *(chiaill1_g(k,n,j)/psaill1_g(j)-chiaill_g(k,n,j) &
345:                     & /psaill_g(j))
346:               chid2 = xkc02_g(k,j)*psa02_g(j)                           &
347:                     & *(chia02_g(k,n,j)/psa02_g(j)-chia01_g(k,n,j)      &
348:                     & /psa01_g(j))
349:               tchitb(n) = tchitb(n) - dtmin*6.E4*dsigma(k)*(chid2+chid1)&
350:                         & *rgti
351:             end do
352:           end do
353:         end do
354:       end if
355:       call <a href="#" TARGET=CENT_PANEL>mpi_bcast</a>(tchitb,ntr,mpi_real8,0,mpi_comm_world,ierr)
356: #else
357:       do n = 1 , ntr
358:         do k = 1 , kz
359:           do i = 2 , iym2
360:             tchitb(n) = tchitb(n) - dtmin*6.E4*dsigma(k)                &
361:                       & *(workb(i,k,n)+worka(i,k,n))*rgti
362:           end do
363:         end do
364:       end do
365: #endif
366: 
367:       end subroutine tracdiag
</PRE>

<HR>

</BODY>
</HTML>

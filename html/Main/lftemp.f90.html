<HTML>

<HEAD>
<TITLE>lftemp.f90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>lftemp.f90</H1>
<HR>
<H2 ALIGN=CENTER>lftemp.f90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=lftemp><H3>lftemp</H3></a></p> Click <a href="./callingtree/lftemp_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where lftemp is used.
<hr>
20:       subroutine lftemp(iemiss)
21: 
22: !:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
23: !
24: !     calculate leaf temperature, leaf fluxes, and net transpiration.
25: !     documented in ncar tech note, dickinson et al., 1986.
26: !     modifications by klaus blumel, 1988.
27: !
28: !        f l o w   d i a g r a m   f o r   l e f t e m
29: !
30: !              lftemp ===> stomat
31: !                          frawat
32: !                            root
33: !                           satur
34: !                          lfdrag
35: !                          condch
36: !                          condcq
37: !                           deriv
38: !
39: !     cf = heat transfer coeff. from leaves; assumes same for moisture
40: !          (see e.g. d. gates' book) for laminar flow past leaf;
41: !          from ewing paper, cf has dimensions t**1/2 l**-1;
42: !          so to make it dimensionless, premultiply by 0.01 (si).
43: !     cgrnd = deriv. of soil energy flux with respect to soil temp.
44: !                             (used in tgrund)
45: !     delt = ts-taf
46: !     ef = transpiration rate
47: !     efpot = potential evaporation rate (kg/m**2/s)
48: !     fevpg = evaporative heat flux from ground
49: !     flnet = (temp gradient)*(d/dt(sig t**4)); hence, t**3 term
50: !     fseng = sensible heat flux from ground
51: !     iter = leaf temp iteration counter; runs from 1 to max of 100
52: !     ra = leaf aerodynamic resistance factor
53: !     taf = air temperature within foliage canopy
54: !     tbef = leaf temp at time step before current one
55: !     ts = air temperature of lowest model layer
56: !     uaf = mean wind within canopy
57: !
58: !     taf1d(n,i) = temperature of air in canopy
59: !     delt1d(n,i)= difference between temperature of overlying air
60: !                          and that in canopy
61: !     delq1d(n,i)= difference between humidity of overlying air
62: !                          and that in canopy
63: !
64: !     convergence of leaf temperature calculation is declared if
65: !     enough iterations (itmin) and change of temp small enough and
66: !     change of latent heat fluxes small enough, or if
67: !     maximum iteration reached (itmax).
68: !
69:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
70:       use <a href="./mod_param1.f90.html#mod_param1" TARGET=CENT_PANEL>mod_param1</a> , only : dtbat
71:       use <a href="./mod_bats.F90.html#mod_bats" TARGET=CENT_PANEL>mod_bats</a>
72:       use <a href="./mod_ictp01.F90.html#mod_ictp01" TARGET=CENT_PANEL>mod_ictp01</a>
73:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : tzero , c1es , sigm , wlhv , cpd , ep2
74:       implicit none
75: !
76: ! Dummy arguments
77: !
78:       integer :: iemiss
79:       intent (in) iemiss
80: !
81: ! Local variables
82: !
83:       real(8) :: dcn , delmax , efeb , eg1 , epss , fbare , qbare ,     &
84:                & qcan , qsatdg , rppdry , sf1 , sf2 , sgtg3 , vakb ,    &
85:                & xxkb
86:       real(8) , dimension(nnsg,iym1) :: dels , efpot , tbef
87:       integer :: iter , itfull , itmax , n , i
88: !
89: !=======================================================================
90: !l    1.   setup information
91: !=======================================================================
92: !
93: !l    1.1  get stress-free stomatal resistance
94: !     (1st guess at vapor pressure deficit)
95:       do i = 2 , iym1
96:         do n = 1 , nnsg
97:           if ( ldoc1d(n,i).gt.0.5 ) then
98:             if ( sigf(n,i).gt.0.001 ) then
99:               vpdc(n,i) = 10.
100:               if ( iemiss.eq.1 ) then
101:                 sgtg3 = emiss_1d(n,i)*(sigm*tg1d(n,i)**3)
102:               else
103:                 sgtg3 = sigm*tg1d(n,i)**3
104:               end if
105:               flneto(n,i) = 4.0*sgtg3*(tlef1d(n,i)-tg1d(n,i))
106:             end if
107:           end if
108:         end do
109:       end do
110:       call <a href="./stomat.f90.html#stomat" TARGET=CENT_PANEL>stomat</a>
111: !
112: !l    1.3  determine fraction of total and green canopy surface
113: !l    covered by water
114:       call <a href="./frawat.f90.html#frawat" TARGET=CENT_PANEL>frawat</a>
115: !
116: !l    1.4  establish root function in terms of etrc = maximum
117: !l    sustainable transpiration rate
118: !     (routine also returns efpr, used in subr. water to
119: !     define upper soil layer transpiration)
120:       call <a href="./mod_bats.F90.html#root" TARGET=CENT_PANEL>root</a>
121:  
122: !l    1.5  saturation specific humidity of leaf
123:       call <a href="./satur.f90.html#satur" TARGET=CENT_PANEL>satur</a>(qsatl,tlef1d,p1d)
124:  
125: !=======================================================================
126: !l    2.   begin iteration for leaf temperature calculation
127: !=======================================================================
128:       iter = 0
129:       efeb = 0.
130:       delmax = 1.
131:       itmax = 10
132:       itfull = itmax
133: !     itmax = 40
134: !     itfull = 20
135:  
136:       do iter = 0 , itmax
137: !
138: !l      2.1  recalc stability dependent canopy & leaf drag coeffs
139:         if ( iter.eq.0 ) call <a href="./condch.f90.html#condch" TARGET=CENT_PANEL>condch</a>
140:         call <a href="./lfdrag.f90.html#lfdrag" TARGET=CENT_PANEL>lfdrag</a>
141:         call <a href="./condch.f90.html#condch" TARGET=CENT_PANEL>condch</a>
142:  
143:         do i = 2 , iym1
144:           do n = 1 , nnsg
145:             if ( ldoc1d(n,i).gt.0.5 ) then
146:               if ( sigf(n,i).gt.0.001 ) then
147:                 ra(n,i) = 1./(cf(n,i)*uaf(n,i))
148:                 cn1(n,i) = wtlh(n,i)*rhs1d(n,i)
149:                 df(n,i) = cn1(n,i)*cpd
150:  
151: !l              2.2  decrease foliage conductance for stomatal
152: !               resistance
153:                 rppdry = ra(n,i)*fdry(n,i)/(rs(n,i)+ra(n,i))
154:                 rpp(n,i) = rppdry + fwet(n,i)
155:  
156: !l              2.3  recalculate saturation vapor pressure
157:                 eg1 = eg(n,i)
158:                 eg(n,i) = c1es*dexp(a(n,i)*(tlef1d(n,i)-tzero)/         &
159:                          & (tlef1d(n,i)-b(n,i)))
160:                 qsatl(n,i) = qsatl(n,i)*eg(n,i)/eg1
161:               end if
162:             end if
163:           end do
164:         end do
165:  
166: !l      2.4  canopy evapotranspiration
167:         if ( iter.eq.0 ) call <a href="./condcq.f90.html#condcq" TARGET=CENT_PANEL>condcq</a>
168:  
169:         epss = 1.E-10
170:         do i = 2 , iym1
171:           do n = 1 , nnsg
172:             if ( ldoc1d(n,i).gt.0.5 ) then
173:               if ( sigf(n,i).gt.0.001 ) then
174:                 efpot(n,i) = cn1(n,i)*(wtgaq(n,i)*qsatl(n,i)-wtgq0(n,i) &
175:                             & *qg1d(n,i)-wtaq0(n,i)*qs1d(n,i))
176:  
177: !as             if(efpot(n,i).ge.0.) then     !if 0 rpp could have
178: !               floating pt
179:                 if ( efpot(n,i).gt.0. ) then
180:                   etr(n,i) = efpot(n,i)*ra(n,i)*fdry(n,i)/(rs(n,i)+     &
181:                            & ra(n,i))
182:                   rpp(n,i) = dmin1(rpp(n,i),(etr(n,i)+ldew1d(n,i)/      &
183:                             & dtbat)/efpot(n,i)-epss)
184:                 else
185:                   etr(n,i) = 0.
186:                   rpp(n,i) = 1.
187:                 end if
188:  
189:                 if ( (efpot(n,i).ge.0.) .and. (etr(n,i).ge.etrc(n,i)))  &
190:                    & then
191: !*                transpiration demand exceeds supply, stomat adjust
192: !                 demand
193:                   rppdry = ra(n,i)*fdry(n,i)/(rs(n,i)+ra(n,i))
194:                   rppdry = rppdry/(etr(n,i)/etrc(n,i))
195:                   etr(n,i) = etrc(n,i)
196: !*                recalculate stomatl resistance and rpp
197:                   rs(n,i) = ra(n,i)*(fdry(n,i)/rppdry-1.)
198:                   rpp(n,i) = rppdry + fwet(n,i)
199:                   rpp(n,i) = dmin1(rpp(n,i),(etr(n,i)+ldew1d(n,i)/      &
200:                             & dtbat)/efpot(n,i)-epss)
201:                 end if
202:  
203:                 rppq(n,i) = wlhv*rpp(n,i)
204:                 efe(n,i) = rppq(n,i)*efpot(n,i)
205:                 if ( efe(n,i)*efeb.lt.0.0 ) efe(n,i) = 0.1*efe(n,i)
206:               end if
207:             end if
208:           end do
209:         end do
210: !=======================================================================
211: !l      3.   solve for leaf temperature
212: !=======================================================================
213: !l      3.1  update conductances for changes in rpp and cdr
214:         call <a href="./condcq.f90.html#condcq" TARGET=CENT_PANEL>condcq</a>
215: !
216: !l      3.2  derivatives of energy fluxes with respect to leaf
217: !l      temperature for newton-raphson calculation of
218: !l      leaf temperature.
219: !l      subr.  ii: rs,ra,cdrd,rppq,efe.
220: !l      subr. output: qsatld,dcd.
221:         if ( iter.le.itfull ) call <a href="./deriv.f90.html#deriv" TARGET=CENT_PANEL>deriv</a>
222: !
223: !l      3.3  compute dcn from dcd, output from subr. deriv
224:         do i = 2 , iym1
225:           do n = 1 , nnsg
226:             if ( ldoc1d(n,i).gt.0.5 ) then
227:               if ( sigf(n,i).gt.0.001 ) then
228:                 dcn = dcd(n,i)*tlef1d(n,i)
229: !
230: !l              1.2  radiative forcing for leaf temperature calculation
231:                 if ( iemiss.eq.1 ) then
232:                   sgtg3 = emiss_1d(n,i)*(sigm*tg1d(n,i)**3)
233:                 else
234:                   sgtg3 = sigm*tg1d(n,i)**3
235:                 end if
236:                 sf1 = sigf(n,i)*(sabveg(i)-flw1d(i)-(1.-sigf(n,i))*     &
237:                     & flneto(n,i)+4.0*sgtg3*tg1d(n,i))
238:                 sf2 = 4.*sigf(n,i)*sgtg3 + df(n,i)*wtga(n,i) + dcd(n,i)
239:  
240: !l              3.4  iterative leaf temperature calculation
241:                 tbef(n,i) = tlef1d(n,i)
242:                 tlef1d(n,i) = (sf1+df(n,i)*(wta0(n,i)*ts1d(n,i)+        &
243:                        & wtg0(n,i)*tg1d(n,i))-efe(n,i)+dcn)/sf2
244: !
245: !l              3.5  chk magnitude of change; limit to max allowed value
246:                 dels(n,i) = tlef1d(n,i) - tbef(n,i)
247:                 if ( dabs(dels(n,i)).gt.delmax )                        &
248:                   &   tlef1d(n,i) = tbef(n,i) + delmax*dels(n,i)/       &
249:                   &   dabs(dels(n,i))
250:  
251: !l              3.6  update dependence of stomatal resistance
252: !l              on vapor pressure deficit
253:                 qcan = wtlq0(n,i)*qsatl(n,i) + qg1d(n,i)*wtgq0(n,i)     &
254:                      & + qs1d(n,i)*wtaq0(n,i)
255:                 vpdc(n,i) = (1.-rpp(n,i))*(qsatl(n,i)-qcan)*1.E3/ep2
256:               end if
257:             end if
258:           end do
259:         end do
260:  
261:         call <a href="./stomat.f90.html#stomat" TARGET=CENT_PANEL>stomat</a>
262:  
263: !l      3.8  end iteration
264:  
265:       end do
266:  
267:       do i = 2 , iym1
268:         do n = 1 , nnsg
269:           if ( ldoc1d(n,i).gt.0.5 ) then
270:             if ( sigf(n,i).gt.0.001 ) then
271: !=======================================================================
272: !l            4.   update dew accumulation (kg/m**2/s)
273: !=======================================================================
274:               ldew1d(n,i) = ldew1d(n,i) + (etr(n,i)-efe(n,i)/wlhv)*dtbat
275:  
276: !=======================================================================
277: !l            5.   collect parameters needed to evaluate
278: !l            sensible and latent fluxes
279: !=======================================================================
280:  
281: !l            5.1  canopy properties
282:               taf1d(n,i) = wtg0(n,i)*tg1d(n,i) + wta0(n,i)              &
283:                           & *ts1d(n,i) + wtl0(n,i)*tlef1d(n,i)
284:               delt1d(n,i) = wtgl(n,i)*ts1d(n,i) - (wtl0(n,i)*           &
285:                            & tlef1d(n,i)+wtg0(n,i)*tg1d(n,i))
286:               delq1d(n,i) = wtglq(n,i)*qs1d(n,i) - (wtlq0(n,i)*         &
287:                            & qsatl(n,i)+wtgq0(n,i)*qg1d(n,i))
288:               if ( iemiss.eq.1 ) then
289:                 sgtg3 = emiss_1d(n,i)*(sigm*tg1d(n,i)**3)
290:               else
291:                 sgtg3 = sigm*tg1d(n,i)**3
292:               end if
293:               flnet(n,i) = sgtg3*(tlef1d(n,i)-tg1d(n,i))*4.0
294:               xxkb = dmin1(rough(lveg(n,i)),1.D0)
295:               vakb = (1.-sigf(n,i))*vspda(n,i) + sigf(n,i)              &
296:                    & *(xxkb*uaf(n,i)+(1.-xxkb)*vspda(n,i))
297:               wtg2(n,i) = (1.-sigf(n,i))*cdr(n,i)*vakb
298:               fbare = wtg2(n,i)*(tg1d(n,i)-ts1d(n,i))
299:               qbare = wtg2(n,i)*(qg1d(n,i)-qs1d(n,i))
300:  
301: !l            5.2  fluxes from soil
302:               fseng(n,i) = cpd*rhs1d(n,i)*(wtg(n,i)*((wta0(n,i)+        &
303:                           & wtl0(n,i))*tg1d(n,i)-wta0(n,i)*ts1d(n,i)-   &
304:                           & wtl0(n,i)*tlef1d(n,i))+fbare)
305:               fevpg(n,i) = rhs1d(n,i)*rgr(n,i)*(wtg(n,i)*((wtaq0(n,i)+  &
306:                           & wtlq0(n,i))*qg1d(n,i)-wtaq0(n,i)*qs1d(n,i)- &
307:                           & wtlq0(n,i)*qsatl(n,i))+qbare)
308:  
309: !l            5.3  deriv of soil energy flux with respect to soil temp
310:               qsatdg = qg1d(n,i)*rgr(n,i)*a(n,i)*(tzero-b(n,i))         &
311:                      & *(1./(tg1d(n,i)-b(n,i)))**2
312:               cgrnds(n,i) = rhs1d(n,i)*cpd*(wtg(n,i)*(wta0(n,i)+        &
313:                      & wtl0(n,i))+wtg2(n,i))
314:               cgrndl(n,i) = rhs1d(n,i)*qsatdg*((wta(n,i)+wtlq(n,i))*    &
315:                      & wtg(n,i)*wtsqi(n,i)+wtg2(n,i))
316:               cgrnd(n,i) = cgrnds(n,i) + cgrndl(n,i)*htvp(n,i)
317:  
318: !l            5.4  reinitialize cdrx
319: !!!           shuttleworth mods #3 removed here !!!!!!
320:               cdrx(n,i) = cdr(n,i)
321: !
322: !l            5.5  fluxes from canopy and soil to overlying air
323:               fbare = wtg2(n,i)*(tg1d(n,i)-ts1d(n,i))
324:               qbare = wtg2(n,i)*(qg1d(n,i)-qs1d(n,i))
325:               sent1d(n,i) = cpd*rhs1d(n,i)*(-wta(n,i)*delt1d(n,i)+fbare)
326:               evpr1d(n,i) = rhs1d(n,i)*(-wta(n,i)*delq1d(n,i)+          &
327:                      & rgr(n,i)*qbare)
328:             end if
329:           end if
330:         end do
331:       end do
332:  
333:       end subroutine lftemp
</PRE>

<HR>

</BODY>
</HTML>

<HTML>

<HEAD>
<TITLE>colmod3.F90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>colmod3.F90</H1>
<HR>
<H2 ALIGN=CENTER>colmod3.F90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19:  
<p><a name=colmod3><H3>colmod3</H3></a></p> Click <a href="./callingtree/colmod3_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where colmod3 is used.
<hr>
20:       subroutine colmod3(jslc)
21: 
22: !ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
23: !-----------------------------NOTICE------------------------------------
24: !
25: !            NCAR COMMUNITY CLIMATE MODEL, VERSION 3.0
26: !            COPYRIGHT (C) 1996
27: !            UNIVERSITY CORPORATION FOR ATMOSPHERIC RESEARCH
28: !            ALL RIGHTS RESERVED
29: !
30: !               ------------ ----- --- ---------- ------
31: !  ********** | distribution terms and conditions notice | ************
32: !               ------------ ----- --- ---------- ------
33: !
34: ! (c) copyright 1996 university corporation for atmospheric research/
35: ! national center for atmospheric research/
36: ! climate and global dynamics division
37: !
38: ! this software, the community climate model (ccm), version ccm3, was
39: ! developed by the climate and global dynamics division (cgd) climate
40: ! modeling section (cms) of the national center for atmospheric research
41: ! (ncar), which is operated by the university corporation for
42: ! atmospheric research (ucar) and sponsored by the national science
43: ! foundation (nsf).
44: !
45: ! access and use of this software shall impose the following obligations
46: ! and understandings on the user.  the user is granted the right,
47: ! without any fee or cost, to use, copy, modify, alter, enhance and
48: ! distribute this software, and any derivative works thereof, and its
49: ! supporting documentation for any purpose whatsoever, except commercial
50: ! sales, provided that this entire notice appears in all copies of the
51: ! software, derivative works and supporting documentation.  further, the
52: ! user agrees to credit ucar/ncar/cgd in any publications that result
53: ! from the use of this software or in any software package that includes
54: ! this software.  the names ucar/ncar/cgd, however, may not be used in
55: ! any advertising or publicity to endorse or promote any products or
56: ! commercial entity unless specific written permission is obtained from
57: ! ucar/ncar/cgd.
58: !
59: ! the ccm3 materials are made available with the understanding that
60: ! ucar/ncar/cgd is not obligated to provide (and will not provide) the
61: ! user with any support, consulting, training, or assistance of any kind
62: ! with regard to the use, operation and performance of this software, nor
63: ! to provide the user with any updates, revisions, new versions, or "bug
64: ! fixes."
65: !
66: ! this software is provided by ucar/ncar/cgd "as is" and any express or
67: ! implied warranties, including but not limited to, the implied
68: ! warranties of merchantability and fitness for a particular purpose are
69: ! disclaimed.  in no event shall ucar/ncar/cgd be liable for any
70: ! special, indirect or consequential damages or any damages whatsoever,
71: ! including but not limited to claims associated with the loss of data
72: ! or profits, which may result from an action in contract, negligence or
73: ! other tortious claim that arises out of or in connection with the
74: ! access, use or performance of this software.
75: !
76: !ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
77: !
78: !     ccm3 column radiation model (crm)
79: !     Jeffrey Kiehl, Bruce Briegleb, and Charlie Zender
80: !     May 1996
81: !
82: !ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
83: !
84: !     This radiation model has been implemented in regcm3
85: !     by Keiichi Nishizawa on leave from CRIEPI (Japan)
86: !     in April, 1997
87: !
88: !     NB:
89: !     The following comments have not been changed from the original
90: !     in the ccm3 column radiation model (crm)
91: !     Therefore, they are not necessarily appropriate
92: !     for the regcm3 radiation package
93: !
94: !ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
95: !
96: !     All routines except crm(), getdat(), radctl(), and four
97: !     dummy routines (readric(), writeric(), outfld(), and radozn()) are
98: !     included straight from CCM3 code. The purpose of the (non-dummy)
99: !     routines is:
100: !
101: !     crm(): the main() routine. This routine takes the place of tphysbc()
102: !     in the ccm3 calling tree. It places the required calls to the cloud
103: !     routines cldefr() and cldems() directly, rather than invoking cldint().
104: !
105: !     getdat(): reads the stdin file to parse the user-specified column
106: !     profile. overwrites the co2vmr previsouly set by radini() with the
107: !     user specified value. computes o3vmr (instead of in radozn()).
108: !     sets the calday variable in comtim.h used in zenith() and radinp().
109: !
110: !     radctl(): main radiation driving routine, same as ccm3 version except:
111: !     receives additional input variable o3vmr, and passes out
112: !     additional diagnostic radiation quantities and eccf usually local to
113: !     radctl(). does all cgs-->mks conversion for all fluxes.
114: !
115: !
116: !     The files that need to be either -included-, specified in the
117: !     compilation statement, or linked from a ccm3 library are...
118: !
119: !     aermix.F    fmrgrid.F    radclr.F   radinp.F    trcabn.F    whenfgt.F
120: !     albland.F   intmax.F     radclw.F   radoz2.F    trcems.F    whenflt.F
121: !     albocean.F  isrchfgt.F   radcsw.F   radtpl.F    trcmix.F    whenne.F
122: !     blkdat.F    isrchfle.F   radded.F   resetr.F    trcplk.F    zenith.F
123: !     cldefr.F    myhandler.F  radems.F   torgrid.F   trcpth.F
124: !     cldems.F    radabs.F     radini.F   trcab.F     wheneq.F
125: !
126: !
127: !     Standard input file is a text (ascii) file. At the end of the included
128: !     input file are notes describing more fully the input. The standard
129: !     output file is also a text (ascii) file.
130: !
131: !
132:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
133:       use <a href="./mod_bats.F90.html#mod_bats" TARGET=CENT_PANEL>mod_bats</a> , only : emiss1d , ilat , ps , sice1d , aldirs ,     &
134:                     & aldifs , aldirl , aldifl , ldoc1d , ocld2d
135:       use <a href="./mod_date.F90.html#mod_date" TARGET=CENT_PANEL>mod_date</a>
136:       use <a href="./mod_comctl.f90.html#mod_comctl" TARGET=CENT_PANEL>mod_comctl</a>
137:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : gti , sigm , ep2 , cpd
138:       implicit none
139: !
140: ! Dummy arguments
141: !
142:       integer :: jslc
143: !
144: ! Local variables
145: !
146:       real(8) , dimension(iym1) :: alb , albc , aldif , aldir , asdif ,&
147:                                   & asdir , alat , coslat , flns ,      &
148:                                   & flnsc , flnt , flntc , flwds ,      &
149:                                   & fsds , fsnirt , fsnirtsq , fsnrtc , &
150:                                   & fsns , fsnsc , fsnt , fsntc ,       &
151:                                   & loctim , solin , soll , solld ,     &
152:                                   & sols , solsd , srfrad , ts
153:       real(8) , dimension(iym1,kzp1) :: cld , effcld , pilnm1 , pintm1
154:       real(8) , dimension(iym1,kz) :: clwp , emis , fice , h2ommr ,  &
155:            & o3mmr , o3vmr , pmidm1 , pmlnm1 , qm1 , qrl , qrs , rei ,  &
156:            & rel , tm1
157:       real(8) :: eccf
158:       integer :: i , ii0 , ii1 , ii2 , k , n
159:       integer , dimension(iym1) :: ioro
160: !
161: !KN   added below
162: !
163: !
164: !     Fields specified by the user in getdat()
165: !
166: ! land/ocean/sea ice flag
167: ! Current latitude (radians)
168: ! fractional cloud cover
169: ! cloud liquid water path
170: !
171: !     NB: o3mmr and o3vmr should be dimensioned (iym1,kz) if a
172: !     different size radiation grid is used. Clashes between prgrid.h
173: !     and ptrrgrid.h (they both define plngbuf) prevent us from
174: !     dimensioning anything by kz in this top level crm() routine.
175: !
176: ! cosine latitude
177: ! water vapor mass mixing ratio
178: ! Ozone mass mixing ratio
179: ! Ozone volume mixing ratio
180: ! natural log of pintm1
181: ! model interface pressures
182: ! model level pressures
183: ! natural log of pmidm1
184: ! model level specific humidity
185: ! model level temperatures
186: !
187: !     Fields computed from user input
188: !
189: ! surface air temperature
190: ! effective cloud=cld*emis
191: ! cloud emissivity
192: ! fractional amount of ice
193: ! ice particle size
194: ! liquid effective drop size (microns)
195: ! earth/sun distance factor
196: ! local time of solar computation
197: ! srf radiative heat flux
198: ! albedo: shortwave, direct
199: ! albedo: shortwave, diffuse
200: ! albedo: longwave, direct
201: !
202: !     Output longwave arguments from radctl()
203: !
204: ! albedo: longwave, diffuse
205: ! Surface down longwave flux
206: !
207: !     Output shortwave arguments from radctl()
208: !
209: ! Longwave cooling rate
210: ! Surface absorbed solar flux
211: ! Solar heating rate
212: ! Downward solar rad onto surface (lw direct)
213: ! Downward solar rad onto surface (lw diffuse)
214: ! Downward solar rad onto surface (sw direct)
215: !
216: !     Additional CRM diagnostic output from radctl()
217: !
218: ! Downward solar rad onto surface (sw diffuse)
219: ! srf longwave cooling (up-dwn) flux
220: ! clr sky lw flx at srf (up-dwn)
221: ! net outgoing lw flx at model top
222: ! clr sky lw flx at model top
223: ! clr sky surface abs solar flux
224: ! total column absorbed solar flux
225: ! clr sky total column abs solar flux
226: !
227: !EES  next 3 added, they are calculated in radcsw
228: ! solar incident flux
229: ! Near-IR flux absorbed at toa
230: ! Clear sky near-IR flux absorbed at toa
231: ! Near-IR flux absorbed at toa >= 0.7 microns
232: ! Flux Shortwave Downwelling Surface
233: !
234: !     Fundamental constants needed by radini()
235: !
236: ! heat capacity dry air at constant prs (J/kg/K)
237: ! ratio mean mol weight h2o to dry air
238: ! gravitational acceleration (m/s**2)
239: ! Sefan-Boltzmann constant (W/m**2/K**4)
240: !
241: !     Set latitude index to jslc
242: !
243:       ilat = jslc
244: !
245: !     Set parameters in common block comtim : dosw,dolw,doabsems
246: !
247:       dosw = .true.
248:       dolw = .true.
249:       doabsems = .true.
250: !
251: !     Set parameters in common block comctl:
252: !     anncyc,dodiavg,iradsw,iradlw,iradae
253: !
254:       anncyc = .true.
255:       dodiavg = .false.
256:       iradsw = 1
257:       iradlw = 1
258:       iradae = 1
259: !
260: !     radini sets many radiation parameters
261: !     radini() must be called before getdat(), because
262: !     the co2 mixing ratio set (by the user) in getdat() should
263: !     overwrite the default CCM3 co2 mixing ratio set by radini().
264: !
265:       call <a href="./radini.F90.html#radini" TARGET=CENT_PANEL>radini</a>
266: !
267: !     NB: orography types are specified in the following
268: !
269:       do i = 1 , iym1
270:         ii0 = 0
271:         ii1 = 0
272:         ii2 = 0
273:         do n = 1 , nnsg
274: #ifdef CLM
275:           if ( ocld2d(n,i,jslc).gt.0.1 .and. sice1d(n,i).eq.0.0 ) then
276: #else
277:           if ( ldoc1d(n,i).gt.0.1 .and. sice1d(n,i).eq.0.0 ) then
278: #endif
279:             ii1 = ii1 + 1
280:           else if ( sice1d(n,i).gt.0.0 ) then
281:             ii2 = ii2 + 1
282:           else
283:             ii0 = ii0 + 1
284:           end if
285:         end do
286:         if ( ii0.ge.ii1 .and. ii0.ge.ii2 ) ioro(i) = 0
287:         if ( ii1.gt.ii0 .and. ii1.ge.ii2 ) ioro(i) = 1
288:         if ( ii2.gt.ii0 .and. ii2.gt.ii1 ) ioro(i) = 2
289:       end do
290: !
291: !     getdat() also sets calday (used in zenith() and radinp()).
292: !
293:       call <a href="./getdat.f90.html#getdat" TARGET=CENT_PANEL>getdat</a>(jslc,h2ommr,alat,cld,clwp,coslat,loctim,o3mmr,o3vmr,  &
294:                 & pilnm1,pintm1,pmidm1,pmlnm1,ps,qm1,tm1,ts)
295: !
296: !     NB:
297: !     variable coszrs is not calculated here in zenith()
298: !     but passed from vecbats() to colmod3() as an argument
299: !     therefore, subroutine zenith() is not necessary in regcm3
300: !
301: !     Get coszrs: needed as input to albland(), albocean(), radctl()
302: !
303: !KN   call zenith (calday  ,dodiavg ,alat    ,coszrs  )
304: !
305: !     NB:
306: !     land and ocean albedos are calculated
307: !     not in albland() and albocean() located below
308: !     but in albedov() called from subroutine vecbats()
309: !     therefore, the following subroutines are not called here
310: !
311: !     Find the albedo for land points
312: !
313: !KN   call albland(ilat     ,ioro    ,sndpth  ,coszrs  ,asdir   ,
314: !KN   $     aldir   ,asdif   ,aldif   )
315: !
316: !     Find the albedo for ocean/sea-ice points
317: !
318: !KN   call albocean(ilat     ,ioro    ,sndpth  ,coszrs  ,asdir   ,
319: !KN   $     aldir   ,asdif   ,aldif   )
320: !
321: !     NB:
322: !     albedos are copied from module bats2,
323: !     because variable names for albedos are somewhat different
324: !
325:       do i = 1 , iym1
326:         asdir(i) = aldirs(i)
327:         asdif(i) = aldifs(i)
328:         aldir(i) = aldirl(i)
329:         aldif(i) = aldifl(i)
330:       end do
331: !
332: !KN   modified above
333: !
334: !     Cloud particle size and fraction of ice
335: !
336:       call <a href="./cldefr.f90.html#cldefr" TARGET=CENT_PANEL>cldefr</a>(ioro,tm1,rel,rei,fice,ps,pmidm1)
337: !
338: !     Cloud emissivity
339: !
340:       call <a href="./cldems.f90.html#cldems" TARGET=CENT_PANEL>cldems</a>(clwp,fice,rei,emis)
341: !
342: !     Effective cloud cover
343: !
344:       do k = 1 , kz
345:         do i = 1 , iym1
346:           effcld(i,k) = cld(i,k)*emis(i,k)
347:         end do
348:       end do
349: !
350: !     Cloud cover at surface interface always zero (for safety's sake)
351: !
352:       do i = 1 , iym1
353:         effcld(i,kzp1) = 0.
354:         cld(i,kzp1) = 0.
355:       end do
356: !
357: !     Main radiation driving routine.
358: !     NB: All fluxes returned from radctl() have already been converted
359: !     to MKS.
360: !++csz
361: !add  by bixq
362: !add_
363:       call <a href="./radctl.f90.html#radctl" TARGET=CENT_PANEL>radctl</a>(jslc,alat,coslat,ts,pmidm1,pintm1,pmlnm1,pilnm1,tm1,  &
364:                 & qm1,cld,effcld,clwp,asdir,asdif,aldir,aldif,fsns,qrs, &
365:                 & qrl,flwds,rel,rei,fice,sols,soll,solsd,solld,emiss1d, &
366:                 & fsnt,fsntc,fsnsc,flnt,flns,flntc,flnsc,solin,alb,albc,&
367:                 & fsds,fsnirt,fsnrtc,fsnirtsq,eccf,o3vmr)
368:                   ! input
369: !--csz
370: !
371: !     write out final results:
372: !
373: !KN   added below
374: !
375: !     subroutine radout() is not included in the ccm3 crm itself
376: !     but introduced from the former regcm2 radiation package
377: !     for the output of results from radiation calculations
378: !     this subroutine is used also for the coupling with bats
379: !
380: !     NB:
381: !     Names of some output variables (in MKS) have been changed
382: !     from those in the CCM2 radiation package.
383: !
384: !add  by bixq
385: !add_
386:       call <a href="./radout.F90.html#radout" TARGET=CENT_PANEL>radout</a>(solin,fsnt,fsns,fsntc,fsnsc,qrs,flnt,flns,flntc,flnsc,&
387:                 & qrl,flwds,srfrad,sols,soll,solsd,solld,alb,albc,fsds, &
388:                 & fsnirt,fsnrtc,fsnirtsq,jslc,h2ommr,cld,clwp)
389: !
390: !KN   added above
391: !
392:       end subroutine colmod3
</PRE>

<HR>

</BODY>
</HTML>

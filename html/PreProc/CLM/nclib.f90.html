<HTML>

<HEAD>
<TITLE>nclib.f90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>nclib.f90</H1>
<HR>
<H2 ALIGN=CENTER>nclib.f90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19: 
20: !-----------------------------------------------------------------------
21: !     Purpose:
22: !        This routine is called to create a netCDF file for use with 
23: !        the UWGAP plotting package.
24: !           Any netCDF file written to must be closed with the call
25: !        'call clscdf(cdfid,ierr)', where cdfid and ierr are
26: !        as in the argumentlist below. 
27: !     Arguments:
28: !        filnam  char  input   the user-supplied netCDF file name.
29: !        cdfid   int   output  the file-identifier
30: !        phymin  real  input   the minimum physical dimension of the
31: !                              entire physical domain along each axis.
32: !                              phymin is dimensioned (ndim)
33: !        phymax  real  input   the maximum physical dimension of the
34: !                              entire physical domain along each axis.
35: !                              phymax is dimensioned (ndim)
36: !        ndim    int   input   the number of dimensions in the file
37: !                              (i.e. number of elements in phymin,
38: !                              phymax)
39: !        ierr   int   output  indicates possible ierrs found in this
40: !                              routine.
41: !                              ierr = 0   no ierrs detected.
42: !                              ierr = 1   ierr detected.
43: !     History:
44: !        Nov. 91  PPM  UW  Created cr3df.
45: !        Jan. 92  CS   UW  Created crecdf.
46: !-----------------------------------------------------------------------
47: 
<p><a name=crecdf><H3>crecdf</H3></a></p> Click <a href="./callingtree/crecdf_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where crecdf is used.
<hr>
48:       subroutine crecdf (filnam, cdfid, phymin, phymax, ndim, ierr) 
49: 
50:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
51: 
52:       implicit none
53: 
54: !     Argument declarations.
55:       integer , intent (in) :: ndim
56:       character(256), intent(in) :: filnam
57:       real(4) , dimension(ndim) :: phymin , phymax
58:       integer , intent (out) :: ierr , cdfid
59: 
60: !     Local variable declarations.
61:       integer , parameter :: maxdim = 4
62:       character(64) :: attnam
63:       character(1)  :: chrid(maxdim)
64:       integer :: k
65:       data chrid /'x','y','z','a'/
66: 
67: !     create the netCDF file
68:       ierr = nf90_create(filnam,nf90_clobber, cdfid)
69:       if ( ierr/=nf90_noerr ) go to 920
70: 
71: !     define global attributes
72:       do k = 1 , ndim
73:         attnam(1:3) = 'dom'
74:         attnam(4:4) = chrid(k)
75:         attnam(5:7) = 'min'
76:         attnam = attnam(1:7)
77:         ierr = nf90_put_att(cdfid,nf90_global,attnam,phymin(k))
78:         if ( ierr/=nf90_noerr ) go to 920
79: 
80:         attnam(1:3) = 'dom'
81:         attnam(4:4) = chrid(k)
82:         attnam(5:7) = 'max'
83:         attnam = attnam(1:7)
84:         ierr = nf90_put_att(cdfid,nf90_global,attnam,phymax(k))
85:         if ( ierr/=nf90_noerr ) go to 920
86:       end do
87: 
88: !     End variable definitions.
89:       ierr = nf90_enddef(cdfid)
90:       if ( ierr/=nf90_noerr ) go to 920
91: 
92: !     normal exit
93:       return
94: 
95: !     ierr exit
96:  920  write (6, *) 'ERROR: An error occurred while attempting to ',     &
97:             &      'create the data file in subroutine crecdf.'
98:       write (6, *) nf90_strerror(ierr)
99:       ierr = nf90_close(cdfid)
100:       ierr = 1
101: 
102:       end subroutine crecdf
103: 
104: 
<p><a name=rcrecdf><H3>rcrecdf</H3></a></p> Click <a href="./callingtree/rcrecdf_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where rcrecdf is used.
<hr>
105:       subroutine rcrecdf (filnam,cdfid,varmin,varmax,ndim,ierr)
106: 
107:       implicit none
108: 
109:       character(256) , intent(in) :: filnam
110:       integer , intent(in) :: ndim
111:       integer , intent(out) :: cdfid
112:       integer , intent(out) :: ierr
113:       real(4) , dimension(ndim) , intent (in) :: varmin , varmax
114: 
115:       call <a href="./nclib.f90.html#crecdf" TARGET=CENT_PANEL>crecdf</a> (filnam,cdfid,varmin,varmax,3,ierr)
116: 
117:       end subroutine rcrecdf
118: 
119: !-----------------------------------------------------------------------
120: !     Purpose:
121: !        This routine closes an open netCDF file.
122: !     Aguments :
123: !        cdfid  int  input   the id of the file to be closed.
124: !        ierr  int  output  indicates possible ierrs found in this
125: !                            routine.
126: !                            ierr = 0   no ierrs detected.
127: !                            ierr = 1   ierr detected.
128: !     History:
129: !        Nov. 91  PPM  UW  Created.
130: !-----------------------------------------------------------------------
131: 
<p><a name=clscdf><H3>clscdf</H3></a></p> Click <a href="./callingtree/clscdf_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where clscdf is used.
<hr>
132:       subroutine clscdf (cdfid, ierr)
133: 
134:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
135: 
136:       implicit none
137: 
138: !     Argument declarations.
139:       integer , intent(in) :: cdfid
140:       integer , intent(out) :: ierr
141: 
142: !     Close requested file.
143:       ierr = nf90_close(cdfid)
144: 
145:       end subroutine clscdf
146: 
147: ! &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
148: ! write data in array arr to netcdf-file for timestep vtstep
149: ! 
150: ! arguments an its meaning
151: !    cdfid     integer            ID returned by crecdf      
152: !    varnam    character*10       name of the variable to be written
153: !    arr       real*8(ie,je,ke)   array containing data to be written
154: !    ie,je,ke  integer            dimensions of arr as used in declar
155: !    iadim     integer(3)         array with used dimensions
156: !    vtstep    real*8             timestep to be written
157: !    lname     character*20       long name of variable
158: !    vunit     character*13       units of variable
159: !    factor    real*8             scaling factor for output
160: !    offset    real*8             offset for output
161: !    vvarmin   real*8(3)          minimum values of dim in phys. space
162: !    vvarmax   real*8(3)          maximum values of dim in phys. space
163: !    izstag    integer            1 for full levels   0 otherwise
164: !    vmisdat   real*8             value for missing data
165: 
<p><a name=writecdf><H3>writecdf</H3></a></p> Click <a href="./callingtree/writecdf_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where writecdf is used.
<hr>
166:       subroutine writecdf(cdfid,varnam,arr,ie,je,ke,iadim,vtstep,       &
167:         &  lname,vunit,factor,offset,vvarmin,vvarmax,xlat1d,xlon1d,sigh,&
168:         &  izstag,vmisdat,iotype)
169: 
170:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
171:       implicit none
172: 
173:       integer , intent(in) :: cdfid , ie , je , ke
174:       character(64) :: varnam , lname , vunit
175:       real(4) , dimension(ie,je,ke) , intent(in) :: arr
176:       real(4) , dimension(ie) , intent(in) :: xlon1d
177:       real(4) , dimension(je) , intent(in) :: xlat1d
178:       real(4) , dimension(ke) , intent(in) :: sigh
179:       integer , dimension(3) , intent(in) :: iadim
180:       real(4) , dimension(3) , intent (in) :: vvarmin , vvarmax
181:       real(8) , intent(in) :: vtstep
182:       real(4) , intent(in) :: offset , factor , vmisdat
183:       integer , intent(in) :: izstag , iotype
184: 
185: !     declarations needed for netcdf-stuff
186: 
187:       real(4) , dimension(3) :: varmin , varmax , varstg
188:       integer , dimension(3) :: vardim
189:       real(4) :: tstep
190:       integer :: idtest , it , ndims
191:       real(4) :: rfac
192: 
193: ! *********** declare some auxiliary variables **********
194: 
195:       integer :: i , k , iputlev
196:       integer :: ievar , jevar , kevar
197: 
198: !     convert real*8 input variables to real*4 variables
199:       do i = 1 , 3
200:         varmin(i) = vvarmin(i)
201:         varmax(i) = vvarmax(i)
202:       end do
203: 
204:       tstep  = vtstep
205:       ievar  = iadim(1)
206:       jevar  = iadim(2)
207:       kevar  = iadim(3)
208: 
209: !     set dimensions used in call to putdef and putdat
210:       ndims = 4
211:       vardim(1) = ievar
212:       vardim(2) = jevar
213:       vardim(3) = kevar
214:       varstg(1) = 0.
215:       varstg(2) = 0.
216:       varstg(3) = -0.5
217:       if ( izstag/=0 ) varstg(3) = 0.0
218: 
219:       it = nf90_inq_varid(cdfid,varnam,idtest)
220:       if ( it/=nf90_noerr ) then
221:         call <a href="./nclib.f90.html#putdefcdf" TARGET=CENT_PANEL>putdefcdf</a>(cdfid,varnam,ndims,vmisdat,lname,vunit,          &
222:               &        offset,factor,vardim,varmin,varmax,iotype,it)
223:         call <a href="./nclib.f90.html#putcoords" TARGET=CENT_PANEL>putcoords</a>(cdfid,ndims,vardim,ievar,jevar,kevar,            &
224:               &        xlat1d,xlon1d,sigh,it)
225:       end if
226: 
227: !     loop over all vertical levels and write the data
228:       do k = 1, kevar
229:         if ( kevar==1 ) then
230:           iputlev = 0
231:         else
232:           iputlev = k
233:         end if
234: 
235:         if ( iotype==1 ) then        ! Integer*2 format
236:           rfac = 1./factor
237:           call <a href="./nclib.f90.html#putdatcdfi2" TARGET=CENT_PANEL>putdatcdfi2</a>(cdfid, varnam, vtstep, k,              &
238:                  &         iputlev, ievar, jevar, arr, ie, je, ke,      &
239:                  &         vmisdat, rfac, offset, it) 
240:         else if ( iotype==2 ) then   ! Real*4 format
241:           call <a href="./nclib.f90.html#putdatcdfr4" TARGET=CENT_PANEL>putdatcdfr4</a>(cdfid,varnam,vtstep,k,iputlev,         &
242:                  &         ievar,jevar,arr,ie,je,ke,it)
243:         end if
244:       
245:       end do   ! loop over vertical levels
246: 
247:       end subroutine writecdf
248: 
249: !------------------------------------------------------------------------
250: !     Purpose:
251: !        Get all times on the specified NetCDF file
252: !     Arguments: 
253: !        cdfid  int  input   identifier for NetCDF file
254: !        times  real input   array contains all time values on the file,
255: !                            dimensioned at least times(ntimes)
256: !        ntimes int  input   number of times on the file
257: !        ierr  int  output  ierrflag 
258: !     History:
259: !        Heini Wernli, ETHZ  
260: !        Christoph Schaer, ETHZ
261: !     Note:
262: !        This preliminary version does not define the times-array, but only
263: !        overwrites or extends an existing times-array.
264: !------------------------------------------------------------------------
265: 
<p><a name=putcoords><H3>putcoords</H3></a></p> Click <a href="./callingtree/putcoords_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where putcoords is used.
<hr>
266:       subroutine putcoords(cdfid,ndim,vardim,ie,je,ke,xlat1d,xlon1d,    &
267:                      &     sigh,ierr)
268: 
269:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
270:       implicit none
271: 
272:       integer , intent(in) :: cdfid , ie , je , ke , ndim
273:       integer , dimension(ndim) , intent(in) :: vardim
274:       real(4) , dimension(ie) :: xlon1d
275:       real(4) , dimension(je) :: xlat1d
276:       real(4) , dimension(ke) :: sigh
277:       integer , intent(out) :: ierr
278: 
279:       integer :: ncvid
280: 
281:       ierr = 0
282: 
283:       ierr = nf90_inq_varid(cdfid,'lon',ncvid)
284:       if ( ierr/=nf90_noerr) go to 920
285:       ierr = nf90_put_var(cdfid,ncvid,xlon1d)
286:       if ( ierr/=nf90_noerr) go to 920
287:       ierr = nf90_inq_varid(cdfid,'lat',ncvid)
288:       if ( ierr/=nf90_noerr) go to 920
289:       ierr = nf90_put_var(cdfid,ncvid,xlat1d)
290:       if ( ierr/=nf90_noerr) go to 920
291:       if ( vardim(3) > 1) then
292:         ierr = nf90_inq_varid(cdfid,'level',ncvid)
293:         if ( ierr/=nf90_noerr) go to 920
294:         ierr = nf90_put_var(cdfid,ncvid,sigh)
295:         if ( ierr/=nf90_noerr) go to 920
296:       end if
297: 
298:       return
299: 
300: !     ierr exit
301:  920  write (6, *) 'ERROR: An error occurred while attempting to ',     &
302:             &      'write variable dimension values in putcoords.'
303:       write (6, *) nf90_strerror(ierr)
304:       ierr = nf90_close(cdfid)
305:       ierr = 1
306: 
307:       end subroutine putcoords
308: 
309: !-----------------------------------------------------------------------
310: !     Purpose:
311: !        This routine is called to write the data of a variable
312: !        to an IVE-NetCDF file for use with the IVE plotting package. 
313: !        Prior to calling this routine, the file must be opened with 
314: !        a call to opncdf (for extension) or crecdf (for creation), the 
315: !        variable must be defined with a call to putdef.
316: !     Arguments:
317: !        cdfid   int   input   file-identifier
318: !                              (must be obtained by calling routine 
319: !                              opncdf or crecdf)
320: !        varnam  char  input   the user-supplied variable name (must 
321: !                              previously be defined with a call to
322: !                              putdef)
323: !        time    real  input   the user-supplied time-level of the
324: !                              data to be written to the file (the time-
325: !                              levels stored in the file can be obtained
326: !                              with a call to gettimes). If 'time' is not
327: !                              yet known to the file, a knew time-level is
328: !                              allocated and appended to the times-array.
329: !        level   int input     the horizontal level(s) to be written 
330: !                              to the NetCDF file. Suppose that the
331: !                              variable is defined as (nx,ny,nz,nt).
332: !                              level>0: the call writes the subdomain
333: !                                       (1:nx,1:ny,level,itimes)
334: !                              level=0: the call writes the subdomain
335: !                                       (1:nx,1:ny,1:nz,itimes)
336: !                              Here itimes is the time-index corresponding
337: !                              to the value of 'time'. 
338: !        dat     real  output  data-array dimensioned sufficiently 
339: !                              large. The dimensions (nx,ny,nz)
340: !                              of the variable must previously be defined
341: !                              with a call to putdef. No previous 
342: !                              definition of the time-dimension is
343: !                              required.
344: !        ierr   int output    indicates possible ierrs found in this
345: !                              routine.
346: !                              ierr = 0   no ierrs detected.
347: !                              ierr = 1   the variable is not present on
348: !                                          the file.
349: !                              ierr = 2   the value of 'time' is new, but
350: !                                          appending it would yield a non
351: !                                          ascending times-array.
352: !                              ierr = 3   inconsistent value of level
353: !                              ierr =10   another ierr.
354: !     History:
355: !       March 93    Heini Wernli (ETHZ)      Created wr2cdf.
356: !       April 93    Bettina Messmer (ETHZ)   Created putdat.
357: !-----------------------------------------------------------------------
358: 
<p><a name=putdatcdfi2><H3>putdatcdfi2</H3></a></p> Click <a href="./callingtree/putdatcdfi2_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where putdatcdfi2 is used.
<hr>
359:       subroutine putdatcdfi2(cdfid, varnam, time, k, level,             &
360:                     &        ievar, jevar, arr, ie, je, ke,             &
361:                     &        vmisdat, rfac, offset, ierr)
362: 
363:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
364: 
365:       implicit none
366: 
367:       integer , intent(in) :: cdfid , ievar , jevar , ie , je , ke , k ,&
368:                             & level
369:       character(64) , intent(in) :: varnam
370:       real(4) , dimension(ie,je,ke) , intent(in) :: arr
371:       real(4) , intent(in) :: vmisdat , rfac , offset
372:       integer , intent(out) :: ierr
373:       real(8) , intent(in) :: time
374: 
375:       integer(2) , dimension(ie*je*ke) :: dat
376:       real(4) :: misdat
377:       real(8) :: timeval
378:       real(8) , dimension(2) :: dvrange
379:       integer , dimension(4) :: corner , edgeln , did , vardim
380:       integer :: ndims , ntime
381:       integer :: idtime , idvar , iflag
382:       integer :: i , j , ik , ij
383:       integer , dimension(1) :: istart
384:  
385:       integer(2) , parameter :: shfill = -32767
386:       ierr = 0
387: 
388:       ij = 0
389:       do j = 1 , jevar
390:         do i = 1 , ievar
391:           ij = ij + 1
392:           if ( arr(i,j,k)<vmisdat ) then 
393:             dat(ij) = shfill  ! the lowest integer value, should match min
394:           else 
395:             dat(ij) = nint((arr(i,j,k)-offset)*rfac)
396:           end if
397:         end do
398:       end do
399: 
400: !     get definitions of data
401:       call <a href="./nclib.f90.html#getdefi2" TARGET=CENT_PANEL>getdefi2</a> (cdfid,varnam,ndims,misdat,vardim,ierr)
402:       if ( ierr/=0 ) go to 920
403: 
404: !     get id of variable
405:       ierr = nf90_inq_varid(cdfid,varnam,idvar)
406:       if ( ierr/=nf90_noerr ) go to 920
407: 
408: !     get times-array 
409:       ierr = nf90_inq_dimid(cdfid,'time',did(4))
410:       if ( ierr/=nf90_noerr ) go to 920
411:       ierr = nf90_inquire_dimension(cdfid,did(4),len=ntime)
412:       if ( ierr/=nf90_noerr ) go to 920
413:       ierr = nf90_inq_varid(cdfid,'time',idtime)
414:       if ( ierr/=nf90_noerr ) go to 920
415: !     Check if a new time step is starting
416:       iflag = 0
417:       do  i = 1 , ntime
418:         istart(1) = i
419:         ierr = nf90_get_var(cdfid,idtime,timeval,istart)
420:         if ( ierr/=nf90_noerr ) go to 920
421:         if ( time==timeval ) iflag = i
422:       end do
423:       if ( iflag==0 ) then         ! new time step
424:         ntime = ntime + 1
425:         iflag = ntime
426:         istart(1) = ntime
427:         ierr = nf90_put_var(cdfid,idtime,time,istart)
428:         if ( ierr/=nf90_noerr ) go to 920
429:         ierr = nf90_get_att(cdfid,idtime,'actual_range',dvrange)
430:         if ( ierr/=nf90_noerr ) go to 920
431:         if ( ( dvrange(1)>time ) .or. ( dvrange(1)==0. ) ) &
432:              &  dvrange(1) = time 
433:         if ( ( dvrange(2)<time ) .or. ( dvrange(2)==0. ) ) &
434:              &  dvrange(2) = time
435:         ierr = nf90_put_att(cdfid,idtime,'actual_range',dvrange)
436:         if ( ierr/=nf90_noerr ) go to 920
437:       end if
438: 
439: !     Define data volume to write on the NetCDF file in index space
440:       corner(1) = 1               ! starting corner of data volume
441:       corner(2) = 1
442:       edgeln(1) = vardim(1)       ! edge lengthes of data volume
443:       edgeln(2) = vardim(2)
444:       if ( level==0 ) then
445:         ik = 3
446:       else
447:         ik = 4
448:         corner(3) = level
449:         edgeln(3) = 1
450:       end if
451:       corner(ik) = iflag
452:       edgeln(ik) = 1
453:       
454: !     Put data on NetCDF file
455:       ierr = nf90_put_var(cdfid,idvar,dat,corner(1:ik),edgeln(1:ik))
456:       if ( ierr/=nf90_noerr ) go to 920
457: 
458: !     Synchronize output to disk and close the files
459:       ierr = nf90_sync(cdfid)
460:       if ( ierr/=nf90_noerr ) go to 920
461: 
462:       return
463: 
464: !     ierr exit
465:  920  write (6, *) 'ERROR: An error occurred while attempting to ',     &
466:             &      'write variable ', varnam, ' values ',               &
467:             &      'at time ', time, ' in putdatcdfi2.'
468:       write (6, *) nf90_strerror(ierr)
469:       ierr = nf90_close(cdfid)
470:       ierr = 1
471: 
472:       end subroutine putdatcdfi2
473: 
474: !-----------------------------------------------------------------------
475: !     Purpose:
476: !        This routine is called to define the dimensions and the
477: !        attributes of a variable on an IVE-NetCDF file for use with the
478: !        IVE plotting package. Prior to calling this routine, the file must
479: !        be opened with a call to opncdf (extend an existing file) or
480: !        crecdf (create a new file).
481: !     Arguments:
482: !        cdfid   int   input   file-identifier
483: !                              (can be obtained by calling routine 
484: !                              opncdf)
485: !        varnam  char  input   the user-supplied variable name.
486: !        ndim    int   input   the number of dimensions (ndim<=4). 
487: !                              Upon ndim=4, the fourth dimension of the
488: !                              variable is specified as 'unlimited'
489: !                              on the file (time-dimension). It can 
490: !                              later be extended to arbitrary length.
491: !        misdat  real  input   missing data value for the variable. 
492: !        vardim  int   input   the dimensions of the variable.
493: !                              Is dimensioned at least Min(3,ndim). 
494: !        varmin  real  input   the location in physical space of the
495: !                              origin of each variable.
496: !                              Is dimensioned at least Min(3,ndim). 
497: !        varmax  real  input   the extent of each variable in physical
498: !                              space.
499: !                              Is dimensioned at least Min(ndim). 
500: !        ierr   int   output  indicates possible ierrs found in this
501: !                              routine.
502: !                              ierr = 0   no ierrs detected.
503: !                              ierr =10   other ierrs detected.
504: !     History:
505: !       Apr. 93    Christoph Schaer (ETHZ)     Created.
506: !-----------------------------------------------------------------------
507: 
<p><a name=putdefcdf><H3>putdefcdf</H3></a></p> Click <a href="./callingtree/putdefcdf_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where putdefcdf is used.
<hr>
508:       subroutine putdefcdf(cdfid,varnam,ndim,misdat,clname,             &
509:                   &        clunits,offset,xscale,vardim,varmin,varmax,  &
510:                   &        iotype,ierr)
511: 
512:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
513:       implicit none
514: 
515:       integer , parameter :: maxdim = 4
516: 
517: !     Argument declarations.
518:       integer , intent(in) :: cdfid , ndim , iotype
519:       character(64) , intent(in) :: varnam , clname , clunits
520:       integer , dimension(ndim) :: vardim
521:       real(4) , dimension(ndim) :: varmin , varmax
522:       real(4) , intent(in) :: xscale , offset , misdat
523:       integer , intent(out) :: ierr
524: 
525: !     Local variable declarations.
526:       character(64) :: dimnam , dimchk
527:       character(64) , dimension(10) :: dimnams
528:       character(5) , dimension(maxdim) :: rdim
529:       integer , dimension(10) :: dimvals
530:       integer , dimension(maxdim) :: did
531:       integer :: numdims , numvars , numgats , dimulim
532:       integer :: id , idtime , i , k , ik
533:       integer :: idcoor
534:       real(4) , dimension(2) :: vrange
535:       real(8) , dimension(2) :: dvrange
536:       character(64) , dimension(maxdim) :: long_name
537:       character(64) , dimension(maxdim) :: units
538:       integer(2) , parameter :: shfill = -32767
539:       real(4) , parameter :: flfill = 9.9692099683868690e+36
540: 
541:       data rdim /'lon','lat','level','time'/
542:       data long_name /'Longitude','Latitude','Height_Index','Time'/
543: 
544:       data units / 'degrees_east', 'degrees_north',                     &
545:              &     'level' , 'hours since 1900-1-1 00:00:0.0' /
546: 
547: 
548: !     initialize vardim to something negative
549:       vardim(4) = -99
550: 
551: !     Make sure ndim <= maxdim.
552:       if ( ndim>maxdim ) then
553:          ierr = 10
554:          go to 900
555:       end if
556: 
557: !     Read existing dimensions-declarations from the file
558:       ierr = nf90_inquire(cdfid,numdims,numvars,numgats,dimulim)
559:       if ( ierr/=nf90_noerr ) go to 920
560: 
561:       if ( numdims>0 ) then
562:         do i = 1 , numdims
563:           ierr = nf90_inquire_dimension(cdfid,i,dimnams(i),dimvals(i))
564:           if ( ierr/=nf90_noerr ) go to 920
565:         end do
566:       end if
567: 
568: !     put file into define mode
569:       ierr = nf90_redef(cdfid)
570:       if ( ierr/=nf90_noerr ) go to 920
571: 
572: 
573: !     define spatial dimensions
574:       ik = 0 
575:       do k = 1 , max0(ndim,3)
576:         if ( vardim(k)>1 ) then
577:           ik = ik + 1
578:           dimnam = rdim(k)
579:           did(ik) = -1
580:           if ( numdims>0 ) then
581: !           check if an existing dimension-declaration can be used
582: !           instead of defining a new dimension
583:             do i = 1 , numdims
584:               dimchk = dimnams(i)
585:               if ( ( dimnam(1:3) == dimchk(1:3) ) ) then 
586:                 did(ik) = i
587:                 exit
588:               end if
589:             end do
590:           end if
591:           if ( did(ik)<0 ) then
592: !         define the dimension and an array with name of dimension
593:             ierr = nf90_def_dim(cdfid,dimnam,vardim(k),did(ik))
594:             if ( ierr/=nf90_noerr ) go to 920
595:             ierr = nf90_def_var(cdfid,dimnam,nf90_float,did(ik),idcoor)
596:             if ( ierr/=nf90_noerr ) go to 920
597:             vrange(1) = varmin(k)
598:             vrange(2) = varmax(k)
599:             ierr = nf90_put_att(cdfid,idcoor,'long_name',long_name(k))
600:             if ( ierr/=nf90_noerr ) go to 920
601:             ierr = nf90_put_att(cdfid,idcoor,'units',units(k))
602:             if ( ierr/=nf90_noerr ) go to 920
603:             ierr = nf90_put_att(cdfid,idcoor,'actual_range',vrange)
604:             if ( ierr/=nf90_noerr ) go to 920
605:           end if
606:         end if
607:       end do
608: 
609: 
610: !     define the times-array
611:       if ( ndim==4 ) then
612:         ik = ik + 1
613: !       define dimension 'time'
614:         ierr = nf90_inq_dimid(cdfid,'time',did(ik))
615:         if ( ierr/=nf90_noerr ) then 
616: !         this dimension must first be defined
617:           ierr = nf90_def_dim(cdfid,'time',nf90_unlimited,did(ik))
618:           if ( ierr/=nf90_noerr ) go to 920
619:         end if
620: !       define array 'time'
621:         ierr = nf90_inq_varid(cdfid,'time',idtime)
622:         if ( ierr/=nf90_noerr ) then 
623: !         define the times-array
624:           ierr = nf90_def_var(cdfid,'time',nf90_double,did(ik),idtime)
625:           if ( ierr/=nf90_noerr ) go to 920
626:           ierr = nf90_put_att(cdfid,idtime,'long_name',long_name(4))
627:           if ( ierr/=nf90_noerr ) go to 920
628:           ierr = nf90_put_att(cdfid,idtime,'units',units(4))
629:           if ( ierr/=nf90_noerr ) go to 920
630:           dvrange(1)=0.
631:           dvrange(2)=0.
632:           ierr = nf90_put_att(cdfid,idtime,'actual_range',dvrange)
633:           if ( ierr/=nf90_noerr ) go to 920
634:         end if
635:       end if
636: 
637: !     define variable
638:       if ( iotype==1 ) then
639:         ierr = nf90_def_var(cdfid,varnam,nf90_short,did(1:ik),id)
640:       else if (iotype==2) then
641:         ierr = nf90_def_var(cdfid,varnam,nf90_float,did(1:ik),id)
642:       end if
643:       if ( ierr/=nf90_noerr ) go to 920
644: 
645: !     define long_name
646:       ierr = nf90_put_att(cdfid,id,'long_name',clname)
647:       if ( ierr/=nf90_noerr ) go to 920
648: !     define units
649:       ierr = nf90_put_att(cdfid,id,'units',clunits)
650:       if ( ierr/=nf90_noerr ) go to 920
651: !     define missing data value
652:       if ( iotype==1 ) then
653:         ierr = nf90_put_att(cdfid,id,'missing_value',shfill)
654:       else if ( iotype==2 ) then
655:         ierr = nf90_put_att(cdfid,id,'missing_value',misdat)
656:       end if
657:       if ( ierr/=nf90_noerr ) go to 920
658: 
659:       if ( iotype==1 ) then
660: !       define offset_value
661:         ierr = nf90_put_att(cdfid,id,'add_offset',offset)
662:         if ( ierr/=nf90_noerr ) go to 920
663: 
664: !       define scale_factor
665:         ierr = nf90_put_att(cdfid,id,'scale_factor',xscale)
666:         if ( ierr/=nf90_noerr ) go to 920
667:       end if
668: 
669: !     leave define mode
670:       ierr = nf90_enddef(cdfid)
671:       if ( ierr/=nf90_noerr ) go to 920
672: 
673: !     synchronise output to disk and exit
674:       ierr = nf90_sync(cdfid)
675:       if ( ierr/=nf90_noerr ) go to 920
676:       return
677: 
678: !     Error exits.
679:  900  write (6, *) '*ERROR*: When calling putdefcdf, the number of ',   &
680:                &   'variable dimensions must be less or equal 4.'
681:       ierr = nf90_close(cdfid)
682:       ierr = 1
683:       return
684: 
685:  920  write (6, *) '*ERROR*: An error occurred while attempting to ',   &
686:                &   'write the data file in subroutine putdefcdf.'
687:       write (6, *) nf90_strerror(ierr)
688:       ierr = nf90_close(cdfid)
689:       ierr = 1
690:       return
691:       end subroutine putdefcdf
692: 
693: !-----------------------------------------------------------------------
694: !     Purpose:
695: !        This routine is called to write the data of a variable
696: !        to an IVE-NetCDF file for use with the IVE plotting package. 
697: !        Prior to calling this routine, the file must be opened with 
698: !        a call to opncdf (for extension) or crecdf (for creation), the 
699: !        variable must be defined with a call to putdef.
700: !     Arguments:
701: !        cdfid   int   input   file-identifier
702: !                              (must be obtained by calling routine 
703: !                              opncdf or crecdf)
704: !        varnam  char  input   the user-supplied variable name (must 
705: !                              previously be defined with a call to
706: !                              putdef)
707: !        time    real  input   the user-supplied time-level of the
708: !                              data to be written to the file (the time-
709: !                              levels stored in the file can be obtained
710: !                              with a call to gettimes). If 'time' is not
711: !                              yet known to the file, a knew time-level is
712: !                              allocated and appended to the times-array.
713: !        level   int input     the horizontal level(s) to be written 
714: !                              to the NetCDF file. Suppose that the
715: !                              variable is defined as (nx,ny,nz,nt).
716: !                              level>0: the call writes the subdomain
717: !                                       (1:nx,1:ny,level,itimes)
718: !                              level=0: the call writes the subdomain
719: !                                       (1:nx,1:ny,1:nz,itimes)
720: !                              Here itimes is the time-index corresponding
721: !                              to the value of 'time'. 
722: !        dat     real  output  data-array dimensioned sufficiently 
723: !                              large. The dimensions (nx,ny,nz)
724: !                              of the variable must previously be defined
725: !                              with a call to putdef. No previous 
726: !                              definition of the time-dimension is
727: !                              required.
728: !        ierr   int output    indicates possible ierrs found in this
729: !                              routine.
730: !                              ierr = 0   no ierrs detected.
731: !                              ierr = 1   the variable is not present on
732: !                                          the file.
733: !                              ierr = 2   the value of 'time' is new, but
734: !                                          appending it would yield a non
735: !                                          ascending times-array.
736: !                              ierr = 3   inconsistent value of level
737: !                              ierr =10   another ierr.
738: !     History:
739: !       March 93    Heini Wernli (ETHZ)      Created wr2cdf.
740: !       April 93    Bettina Messmer (ETHZ)   Created putdat.
741: !-----------------------------------------------------------------------
742: 
<p><a name=putdatcdfr4><H3>putdatcdfr4</H3></a></p> Click <a href="./callingtree/putdatcdfr4_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where putdatcdfr4 is used.
<hr>
743:       subroutine putdatcdfr4(cdfid, varnam, time, k, level, ievar,      &
744:                         &    jevar, arr, ie, je, ke, ierr)
745: 
746:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
747: 
748:       implicit none
749: 
750:       integer , intent(in) :: cdfid
751:       character(64) , intent(in) :: varnam
752:       real(8) , intent(in) :: time
753:       integer , intent(in) :: k , level , ievar , jevar , ie ,  je , ke
754:       real(4) , dimension(ie,je,ke) , intent(in) :: arr
755:       integer , intent(out) :: ierr
756:       integer , dimension(1) :: istart
757: 
758: !     Declaration of local variables
759: 
760:       real(4), dimension(ie*je*ke) :: dat
761:       real(4) :: misdat
762:       real(8) :: timeval
763:       real(8) , dimension(2) :: dvrange
764: 
765:       integer , dimension(4) :: corner , edgeln , did , vardim
766:       integer :: ndims , ntime
767:       integer :: idtime , idvar , iflag
768:       integer :: i , j , ik , ij
769: 
770:       ij = 0
771:       do j = 1 , jevar
772:         do i = 1 , ievar
773:           ij = ij + 1
774:           dat(ij) = arr(i,j,k)
775:         end do
776:       end do
777: 
778: !     get definitions of data
779:       call <a href="./nclib.f90.html#getdefcdfr4" TARGET=CENT_PANEL>getdefcdfr4</a>(cdfid,varnam,ndims,misdat,vardim,ierr)
780:       if ( ierr/=0 ) go to 920
781: 
782: !     get id of variable
783:       ierr = nf90_inq_varid(cdfid,varnam,idvar)
784:       if ( ierr/=nf90_noerr ) go to 920
785: 
786: !     get times-array 
787:       ierr = nf90_inq_dimid(cdfid,'time',did(4))
788:       if ( ierr/=nf90_noerr ) go to 920
789:       ierr = nf90_inquire_dimension(cdfid,did(4),len=ntime)
790:       if ( ierr/=nf90_noerr ) go to 920
791:       ierr = nf90_inq_varid(cdfid,'time',idtime)
792:       if ( ierr/=nf90_noerr ) go to 920
793: 
794: !     Check if a new time step is starting
795:       iflag = 0
796:       do i = 1 , ntime
797:         istart(1) = i
798:         ierr = nf90_get_var(cdfid,idtime,timeval,istart)
799:         if ( ierr/=nf90_noerr ) go to 920
800:         if ( time==timeval ) iflag = i
801:       end do
802: 
803:       if ( iflag==0 ) then              ! new time step
804:         ntime = ntime+1
805:         iflag = ntime
806:         istart(1) = ntime
807:         ierr = nf90_put_var(cdfid,idtime,time,istart)
808:         if ( ierr/=nf90_noerr ) go to 920
809:         ierr = nf90_get_att(cdfid,idtime,'actual_range',dvrange)
810:         if ( ierr/=nf90_noerr ) go to 920
811:         if ( ( dvrange(1)>time ) .or. ( dvrange(1)==0. ) )              &
812:              &   dvrange(1) = time 
813:         if ( ( dvrange(2)<time ) .or. ( dvrange(2)==0. ) )              &
814:              &   dvrange(2) = time
815:         ierr = nf90_put_att(cdfid,idtime,'actual_range',dvrange)
816:         if ( ierr/=nf90_noerr ) go to 920
817:       end if
818: 
819: !     Define data volume to write on the NetCDF file in index space
820:       corner(1) = 1               ! starting corner of data volume
821:       corner(2) = 1
822:       edgeln(1) = vardim(1)       ! edge lengthes of data volume
823:       edgeln(2) = vardim(2)
824:       if ( level==0 ) then
825:         ik = 3
826:       else
827:         ik = 4
828:         corner(3) = level
829:         edgeln(3) = 1
830:       end if
831:       corner(ik) = iflag
832:       edgeln(ik) = 1
833:       
834: !     Put data on NetCDF file
835: 
836:       ierr = nf90_put_var(cdfid,idvar,dat,corner(1:ik),edgeln(1:ik))
837:       if ( ierr/=nf90_noerr ) go to 920
838: 
839: !     Synchronize output to disk and close the files
840: 
841:       ierr = nf90_sync(cdfid)
842:       if ( ierr/=nf90_noerr ) go to 920
843: 
844:       return
845: 
846:  920  write (6, *) 'ERROR: An error occurred while attempting to ',     &
847:             &      'write variable ', varnam, ' values ',               &
848:             &      'at time ', time, ' in putdatcdfr4.'
849:       write (6, *) nf90_strerror(ierr)
850:       ierr = nf90_close(cdfid)
851:       ierr = 1
852: 
853:       end subroutine putdatcdfr4
854: 
855: !-----------------------------------------------------------------------
856: !     Purpose:
857: !        This routine is called to get the dimensions and attributes of 
858: !        a variable from an IVE-NetCDF file for use with the IVE plotting
859: !        package. Prior to calling this routine, the file must be opened
860: !        with a call to opncdf.
861: !     Arguments:
862: !        cdfid   int   input   file-identifier
863: !                              (can be obtained by calling routine 
864: !                              opncdf)
865: !        varnam  char  input   the user-supplied variable name.
866: !                              (can be obtained by calling routine 
867: !                              opncdf)
868: !        ndim    int   output  the number of dimensions (ndim<=4)
869: !        misdat  real  output  missing data value for the variable. 
870: !        vardim  int   output  the dimensions of the variable.
871: !                              Is dimensioned at least (ndim). 
872: !        ierr   int   output  indicates possible ierrs found in this
873: !                              routine.
874: !                              ierr = 0   no ierrs detected.
875: !                              ierr = 1   the variable is not on the file.
876: !                              ierr =10   other ierrs.
877: !     History:
878: !       Apr. 93    Christoph Schaer (ETHZ)     Created.
879: !-----------------------------------------------------------------------
880: 
<p><a name=getdefi2><H3>getdefi2</H3></a></p> Click <a href="./callingtree/getdefi2_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where getdefi2 is used.
<hr>
881:       subroutine getdefi2 (cdfid, varnam, ndim, misdat, vardim, ierr)
882: 
883:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
884:       implicit none
885: 
886: !     Argument declarations.
887:       integer , parameter :: maxdim = 4
888: 
889:       integer , intent(in) :: cdfid
890:       integer , intent(out) :: ndim
891:       character(64), intent(in) :: varnam
892:       integer, dimension(4) , intent(out) :: vardim
893:       real(4) , intent(out) :: misdat
894:       integer , intent(out) :: ierr
895: 
896: !     Local variable declarations.
897:       character(64) , dimension(maxdim) :: dimnam
898:       character(64) :: vnam
899:       integer :: id , i , k
900:       integer :: ndims , nvars , ngatts , recdim
901:       integer , dimension(maxdim) :: dimsiz
902:       integer :: vartyp , nvatts
903: 
904: !     inquire for number of dimensions
905:       ierr = nf90_inquire(cdfid,ndims,nvars,ngatts,recdim)
906:       if ( ierr/=nf90_noerr ) go to 920
907: 
908: !     read dimension-table
909:       do  i = 1 , ndims 
910:         ierr = nf90_inquire_dimension(cdfid,i,dimnam(i),dimsiz(i))
911:         if ( ierr/=nf90_noerr ) go to 920
912:       end do
913: 
914: !     get id of the variable
915:       ierr = nf90_inq_varid(cdfid,varnam,id)
916:       if ( ierr/=nf90_noerr ) go to 920
917: 
918: !     inquire about variable
919:       ierr = nf90_inquire_variable(cdfid,id,vnam,vartyp,ndim,          &
920:                    &                vardim,nvatts)
921:       if ( ierr/=nf90_noerr ) go to 920
922:       if ( vartyp/=nf90_short ) then
923:         ierr = 1
924:         go to 910
925:       end if
926: 
927: !     Make sure ndim <= maxdim.
928:       if ( ndim>maxdim ) then
929:          ierr = 1
930:          go to 900
931:       end if
932: 
933: !     get dimensions from dimension-table
934:       do k = 1 , ndim 
935:         vardim(k) = dimsiz(vardim(k))
936:       end do
937: 
938: !     get missing data value
939:       ierr = nf90_get_att(cdfid,id,'missing_value',misdat)
940:       if ( ierr/=nf90_noerr ) go to 920
941: 
942: !     normal exit
943:       return
944: 
945: !     Error exits.
946:  900  write (6, *) '*ERROR*: When calling getdefi2, the number of ',    &
947:                  & 'variable dimensions must be less or equal 4.'
948:       ierr = nf90_close(cdfid)
949:       ierr = 1
950:       return
951: 
952:  910  write (6, *) '*ERROR*: The selected variable could not be found ',&
953:                  & 'or is of wrong type in the file by getdefi2.'
954:       ierr = nf90_close(cdfid)
955:       ierr = 1
956:       return
957: 
958:  920  write (6, *) '*ERROR*: An error occurred while attempting to ',   &
959:                  & 'read the data file in subroutine getdefi2.'
960:       write (6, *) nf90_strerror(ierr)
961:       ierr = nf90_close(cdfid)
962:       ierr = 1
963: 
964:       end subroutine getdefi2
965: 
966: !-----------------------------------------------------------------------
967: !     Purpose:
968: !        This routine is called to get the dimensions and attributes of 
969: !        a variable from an IVE-NetCDF file for use with the IVE plotting
970: !        package. Prior to calling this routine, the file must be opened
971: !        with a call to opncdf.
972: !     Arguments:
973: !        cdfid   int   input   file-identifier
974: !                              (can be obtained by calling routine 
975: !                              opncdf)
976: !        varnam  char  input   the user-supplied variable name.
977: !                              (can be obtained by calling routine 
978: !                              opncdf)
979: !        ndim    int   output  the number of dimensions (ndim<=4)
980: !        misdat  real  output  missing data value for the variable. 
981: !        vardim  int   output  the dimensions of the variable.
982: !                              Is dimensioned at least (ndim). 
983: !        ierr   int   output  indicates possible ierrs found in this
984: !                              routine.
985: !                              ierr = 0   no ierrs detected.
986: !                              ierr = 1   the variable is not on the file.
987: !                              ierr =10   other ierrs.
988: !     History:
989: !       Apr. 93    Christoph Schaer (ETHZ)     Created.
990: !-----------------------------------------------------------------------
991: 
<p><a name=getdefcdfr4><H3>getdefcdfr4</H3></a></p> Click <a href="./callingtree/getdefcdfr4_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where getdefcdfr4 is used.
<hr>
992:       subroutine getdefcdfr4(cdfid, varnam, ndim, misdat, vardim, ierr)
993: 
994:       use <a href="#" TARGET=CENT_PANEL>netcdf</a>
995:       implicit none
996: 
997: !     Argument declarations.
998:       integer , intent(in) :: cdfid
999:       character(64) , intent(in) :: varnam
1000:       integer , intent(out) :: ndim
1001:       integer, dimension(4) , intent(out) :: vardim
1002:       real(4) , intent(out) :: misdat
1003:       integer , intent(out) :: ierr
1004: 
1005: !     Local variable declarations.
1006:       character(64), dimension(10) :: dimnam
1007:       character(64) :: vnam
1008:       integer :: id , i , k
1009:       integer :: ndims , nvars , ngatts , recdim
1010:       integer , dimension(10) :: dimsiz
1011:       integer :: vartyp , nvatts
1012: 
1013:       ierr = 0
1014: 
1015: !     inquire for number of dimensions
1016:       ierr = nf90_inquire(cdfid,ndims,nvars,ngatts,recdim)
1017:       if ( ierr/=nf90_noerr ) then
1018:         print *, 'Error in nf90_inquire'
1019:         go to 920
1020:       end if
1021: 
1022: !     read dimension-table
1023:       do  i = 1 , ndims 
1024:         ierr = nf90_inquire_dimension(cdfid,i,dimnam(i),dimsiz(i))
1025:         if ( ierr/=nf90_noerr ) then
1026:           print *, 'Error nf90_inquire_dimension ', dimnam(i)
1027:           go to 920
1028:         end if
1029:       end do
1030: 
1031: !     get id of the variable
1032:       ierr = nf90_inq_varid(cdfid,varnam,id)
1033:       if ( ierr/=nf90_noerr ) then
1034:         print *, 'Error nf90_inq_varid ', varnam
1035:         go to 920
1036:       end if
1037: 
1038: !     inquire about variable
1039:       ierr = nf90_inquire_variable(cdfid,id,vnam,vartyp,ndim,           &
1040:                    &                vardim,nvatts)
1041:       if ( ierr/=nf90_noerr ) then
1042:         print *, 'Error nf90_inquire_variable ', varnam
1043:         go to 920
1044:       end if
1045:       if ( vartyp/=nf90_float ) then
1046:         ierr = 1
1047:         go to 910
1048:       end if
1049: 
1050: !     Make sure ndim <= maxdim.
1051:       if ( ndim>4 ) then
1052:          ierr = 1
1053:          go to 900
1054:       end if
1055: 
1056: !     get dimensions from dimension-table
1057:       do k = 1 , ndims
1058:         vardim(k) = dimsiz(vardim(k))
1059:       end do
1060: 
1061: !     get missing data value
1062:       ierr = nf90_get_att(cdfid,id,'missing_value',misdat)
1063:       if ( ierr/=nf90_noerr ) then
1064:         print *, 'Error in nf90_get_att missing_value'
1065:         go to 920
1066:       end if
1067: 
1068: !     normal exit
1069:       return
1070: 
1071: !     Error exits.
1072:  900  write (6, *) '*ERROR*: When calling getdefcdfr4, the number of ', &
1073:                  & 'variable dimensions must be less or equal 4.'
1074:       ierr = nf90_close(cdfid)
1075:       ierr = 1
1076:       return
1077: 
1078:  910  write (6, *) '*ERROR*: The selected variable could not be found ',&
1079:                  & 'or is of wrong type in the file by getdefcdfr4.'
1080:       ierr = nf90_close(cdfid)
1081:       ierr = 1
1082:       return
1083: 
1084:  920  write (6, *) '*ERROR*: An error occurred while attempting to ',   &
1085:                  & 'read the data file in subroutine getdefcdfr4.'
1086:       write (6, *) nf90_strerror(ierr)
1087:       ierr = nf90_close(cdfid)
1088:       ierr = 1
1089: 
1090:       end subroutine getdefcdfr4
</PRE>

<HR>

</BODY>
</HTML>

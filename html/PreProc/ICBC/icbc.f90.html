<HTML>

<HEAD>
<TITLE>icbc.f90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>icbc.f90</H1>
<HR>
<H2 ALIGN=CENTER>icbc.f90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19: 
<p><a name=icbc><H3>icbc</H3></a></p>20:       program icbc
21: 
22: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
23: !                                                                      !
24: !   ICBC is the third component of the REGional Climate Modeling       !
25: !   (RegCM) system version 3.0 and used to access archived global      !
26: !   analysed datasets at regular latitude-longititude (NNRP1, NNRP2,   !
27: !   ERA40, ERAIN,EIN75,EIN15, EIN25, GFS11)                            !
28: !   or original T159 (N80) datasets(ERAHI),                            !
29: !   or T42 datasets at Gaussian grids (ECWCRP, simply ECMWF), as well  !
30: !   as NEST run from previous FVGCM run (FVGCM), ECHAM5 run  (EH5OM)   !
31: !   and RegCM run (FNEST).                                             !
32: !                                                                      !
33: !   The present ICBC code could treat NNRP1, NNRP2, ECWCRP, ERA40,     !
34: !   ERAIN, EIN75, EIN15, EIN25, GFS11, ERAHI, FVGCM, EH5OM, and RegCM  !
35: !   datasets,  4 times daily.                                          !
36: !                                                                      !
37: !                        Xunqiang Bi, ESP group, Abdus Salam ICTP      !
38: !                                                October 07, 2009      !
39: !                                                                      !
40: !   NNRP1: NCEP/NCAR Reanalysis datasets are available at:             !
41: !          ftp://ftp.cdc.noaa.gov/Datasets/ncep.reanalysis/            !
42: !          Current holdings: 1948 - present, 2.5x2.5L13, netCDF.       !
43: !   NNRP2: NCEP/DOE AMIP-II Reanalysis (Reanalysis-2) are at:          !
44: !          ftp://ftp.cdc.noaa.gov/Datasets/ncep.reanalysis2/           !
45: !          Current holdings: 1979 - 2009, 2.5x2.5L13, netCDF.          !
46: !   NRP2W: Small Window (instead of global) of NNRP1/2 to save disk    !
47: !          space. (For example, African window: 40W,80E;60S,70N)       !
48: !   ECMWF: ECMWF TOGA/WCRP Uninitialized Data - (ECWCRP)               !
49: !          NCAR MSS:/TRENBERT/CTEC/ , ET42yymmdd, where yy=year,       !
50: !          mm=month, dd=day=01,04,07,10,13,16,19,22,25,28, or 31       !
51: !          Current holdings: January, 1993 - December, 1997            !
52: !          Reformatted by PWC/ICTP to direct-access binary,            !
53: !          T42L15, Gaussian Grid.                                      !
54: !   EH5OM: EH5OM run by the MPI at Hamburg, T63, Gaussian grid.        !
55: !          For present day  run: 1941 - 2000;                           !
56: !          For A1B scenario run: 2001 - 2100.                           !
57: !          17 pressure levels, 4 times daily, direct-access binary.    !
58: !   ERA40: ECMWF 40 year reanalysis datasets are available at:         !
59: !          http://data.ecmwf.int/data/d/era40_daily/                   !
60: !          Current holdings: 01/09/1957 - 31/08/2002,                  !
61: !          Pressure levels, 2.5x2.5L23, 4 times daily.                 !
62: !   ERAIN/EIN15: ECMWF INTERIM 10 year reanalysis datasets             !
63: !          Current holdings: 01/01/1989 - 31/05/2009,                  !
64: !          Pressure levels, 1.5x1.5L37, 4 times daily.                 !
65: !   EIN75: ECMWF INTERIM 10 year reanalysis datasets                   !
66: !          Current holdings: 01/01/1989 - 31/12/2007,                  !
67: !          Pressure levels, 0.75x0.75L37, 4 times daily.               !
68: !   EIN25: ECMWF INTERIM 10 year reanalysis datasets                   !
69: !          Current holdings: 01/01/1989 - 31/12/1998,                  !
70: !          Pressure levels, 2.5x2.5L37, 4 times daily.                 !
71: !   GFS11: NCEP Global Forecast System (GFS) product FNL are           !
72: !                                                available at:         !
73: !          http://dss.ucar.edu/datasets/ds083.2/data/fnl-yyyymm/       !
74: !          Current holdings: 01/01/2000 - present,                     !
75: !          Pressure levels, 1.0x1.0L27, 4 times daily.                 !
76: !   ERAHI: ECMWF 40 year reanalysis datasets, origigal model level     !
77: !          fields: T, U, V and log(Ps) are in spectral coefficients    !
78: !          Oro and Q are at the reduced Gaussian grids.                !
79: !          T159L60 (N80L60), 01/09/1957 - 31/08/2002.                  !
80: !   FVGCM: FVGCM run by the PWC group of Abdus Salam ICTP.             !
81: !          For present day run: 1960 - 1990;                           !
82: !          For A2          run: 2070 - 2100.                           !
83: !          1x1.25L18, 4 times daily, direct-access binary.             !
84: !   FNEST: do Further oneway NESTing from previous RegCM run.          !
85: !                                                                      !
86: !   The code need NetCDF library to access ERA40, ERAIN (EIN75/15/25), !
87: !   NNRP1 and NNRP2 data.                                              !
88: !   And we have already provided the NetCDF libraries for many         !
89: !   platforms, if your platform is unfortunately out of our support,   !
90: !   you need install the netcdf library by yourself.                   !
91: !   The code need EMOSLIB library to access ERAHI (T159L60) data, we   !
92: !   have just provided EMOSLIB library for LINUX PGI5 and IBM AIX.     !
93: !                                                                      !
94: !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
95:       use <a href="./mod_dynparam.F90.html#mod_dynparam" TARGET=CENT_PANEL>mod_dynparam</a>
96:       use <a href="./mod_date.f90.html#mod_date" TARGET=CENT_PANEL>mod_date</a>
97:       use <a href="./mod_grid.f90.html#mod_grid" TARGET=CENT_PANEL>mod_grid</a>
98:       use <a href="./mod_ingrid.f90.html#mod_ingrid" TARGET=CENT_PANEL>mod_ingrid</a>
99:       use <a href="./mod_date.f90.html#mod_date" TARGET=CENT_PANEL>mod_date</a>
100:       use <a href="./mod_ecwcp.f90.html#mod_ecwcp" TARGET=CENT_PANEL>mod_ecwcp</a>
101:       use <a href="./mod_eh5om.f90.html#mod_eh5om" TARGET=CENT_PANEL>mod_eh5om</a>
102:       use <a href="./mod_ein15.f90.html#mod_ein15" TARGET=CENT_PANEL>mod_ein15</a>
103:       use <a href="./mod_ein25.f90.html#mod_ein25" TARGET=CENT_PANEL>mod_ein25</a>
104:       use <a href="./mod_ein75.f90.html#mod_ein75" TARGET=CENT_PANEL>mod_ein75</a>
105:       use <a href="./mod_era40.f90.html#mod_era40" TARGET=CENT_PANEL>mod_era40</a>
106:       use <a href="./mod_erahi.f90.html#mod_erahi" TARGET=CENT_PANEL>mod_erahi</a>
107:       use <a href="./mod_fvgcm.f90.html#mod_fvgcm" TARGET=CENT_PANEL>mod_fvgcm</a>
108:       use <a href="./mod_gfs11.f90.html#mod_gfs11" TARGET=CENT_PANEL>mod_gfs11</a>
109:       use <a href="./mod_ncep.f90.html#mod_ncep" TARGET=CENT_PANEL>mod_ncep</a>
110:       use <a href="./mod_nest.f90.html#mod_nest" TARGET=CENT_PANEL>mod_nest</a>
111:       use <a href="./mod_write.f90.html#mod_write" TARGET=CENT_PANEL>mod_write</a>
112:       use <a href="./mod_header.F90.html#mod_header" TARGET=CENT_PANEL>mod_header</a>
113:       implicit none
114: !
115: ! Local variables
116: !
117:       integer :: idate , idatef , iday , ifile , imon , imonnew ,       &
118:                & imonold , isize , iyr , nnn , inmber , numfile
119:       integer :: nnnend , nstart
120:       integer :: ierr
121:       character(256) :: namelistfile, prgname
122:       character(256) :: sstfile , finame
123: !
124:       call <a href="./mod_header.F90.html#header" TARGET=CENT_PANEL>header</a>(0)
125: !
126: !
127: !     Read input global namelist
128: !
129:       call <a href="#" TARGET=CENT_PANEL>getarg</a>(0, prgname)
130:       call <a href="#" TARGET=CENT_PANEL>getarg</a>(1, namelistfile)
131:       call <a href="./mod_dynparam.F90.html#initparam" TARGET=CENT_PANEL>initparam</a>(namelistfile, ierr)
132:       if ( ierr/=0 ) then
133:         write ( 6, * ) 'Parameter initialization not completed'
134:         write ( 6, * ) 'Usage : '
135:         write ( 6, * ) '          ', trim(prgname), ' regcm.in'
136:         write ( 6, * ) ' '
137:         write ( 6, * ) 'Check argument and namelist syntax'
138:         stop
139:       end if
140: !
141:       call <a href="./mod_grid.f90.html#init_grid" TARGET=CENT_PANEL>init_grid</a>(iy,jx,kz)
142:       call <a href="./mod_write.f90.html#init_output" TARGET=CENT_PANEL>init_output</a>(jx,iy,kz)
143:       call <a href="./mod_date.f90.html#initdate_icbc" TARGET=CENT_PANEL>initdate_icbc</a>
144:       call <a href="./mod_date.f90.html#finddate_icbc" TARGET=CENT_PANEL>finddate_icbc</a>(nstart,globidate1)
145:       call <a href="./mod_date.f90.html#finddate_icbc" TARGET=CENT_PANEL>finddate_icbc</a>(nnnend,globidate2)
146: 
147:       write (*,*) 'NSTART,NNNEND: ' , nstart , nnnend
148:       write (*,*) 'IDATE1,IDATE2: ' , globidate1 , globidate2
149:  
150:       isize = jx*iy*4*(kz*4+3)
151:       numfile = 2100000000/isize
152:       numfile = (numfile/20)*20
153:  
154:       write (sstfile,99001) trim(dirglob), pthsep, trim(domname),       &
155:           & '_SST.RCM'
156:       open (60,file=sstfile,form='unformatted',status='old',err=100)
157:  
158:       call <a href="./mod_ingrid.f90.html#commhead" TARGET=CENT_PANEL>commhead</a>
159: 
160:       if ( dattyp=='NNRP1' .or. dattyp=='NNRP2' .or. dattyp=='NRP2W' )  &
161:          & then
162:         call <a href="./mod_ncep.f90.html#headernc" TARGET=CENT_PANEL>headernc</a>
163:       else if ( dattyp=='ECMWF' ) then
164:         call <a href="./mod_ecwcp.f90.html#headerec" TARGET=CENT_PANEL>headerec</a>
165:       else if ( dattyp=='ERA40' ) then
166:         call <a href="./mod_era40.f90.html#headerera" TARGET=CENT_PANEL>headerera</a>
167:       else if ( dattyp=='ERAIN' .or. dattyp=='EIN15' ) then
168:         call <a href="./mod_ein15.f90.html#headerein15" TARGET=CENT_PANEL>headerein15</a>
169:       else if ( dattyp=='EIN75' ) then
170:         call <a href="./mod_ein75.f90.html#headerein75" TARGET=CENT_PANEL>headerein75</a>
171:       else if ( dattyp=='EIN25' ) then
172:         call <a href="./mod_ein25.f90.html#headerein25" TARGET=CENT_PANEL>headerein25</a>
173:       else if ( dattyp=='GFS11' ) then
174:         call <a href="./mod_gfs11.f90.html#headergfs" TARGET=CENT_PANEL>headergfs</a>
175:       else if ( dattyp=='ERAHI' ) then
176:         call <a href="./mod_erahi.f90.html#headerehi" TARGET=CENT_PANEL>headerehi</a>
177:       else if ( dattyp=='EH5OM' ) then
178:         call <a href="./mod_eh5om.f90.html#headermpi" TARGET=CENT_PANEL>headermpi</a>(ehso4)
179:       else if ( dattyp=='FVGCM' ) then
180:         call <a href="./mod_fvgcm.f90.html#headerfv" TARGET=CENT_PANEL>headerfv</a>
181:       else if ( dattyp=='FNEST' ) then
182:         call <a href="./mod_nest.f90.html#headnest" TARGET=CENT_PANEL>headnest</a>
183:       else
184:         write ( 6,* ) 'Unknown dattyp'
185:         stop
186:       end if
187:       if ( ssttyp=='OI_WK' .or. ssttyp=='OI2WK' ) call <a href="./mod_date.f90.html#headwk" TARGET=CENT_PANEL>headwk</a>
188:  
189:       imonold = 0
190:       ifile = 101
191:       do nnn = nstart , nnnend
192:         idate = mdate(nnn)
193:         iyr = idate/1000000
194:         imon = idate/10000 - iyr*100
195: !       IF(MOD(NNN-NSTART,NUMFILE).EQ.0 .or.
196: !       &     (imon.ne.imonold.and.nnn.lt.nnnend.and.nnn.gt.nstart))
197: !       THEN
198:         if ( nnn==nstart .or.                                           &
199:            & (imon/=imonold .and. nnn<nnnend .and. nnn>nstart) ) then
200:           iday = idate/100 - iyr*10000 - imon*100
201:           write (finame,99002) trim(dirglob), pthsep, trim(domname),    &
202:               '_ICBC', idate
203:           if ( nnn>nstart ) then
204:             if ( dattyp=='NNRP1' .or. dattyp=='NNRP2' ) then
205:               call <a href="./mod_ncep.f90.html#getncep" TARGET=CENT_PANEL>getncep</a>(idate)
206:             else if ( dattyp=='NRP2W' ) then
207:               call <a href="./mod_ncep.f90.html#getncepw" TARGET=CENT_PANEL>getncepw</a>(idate)
208:             else if ( dattyp=='ECMWF' ) then
209:               call <a href="./mod_ecwcp.f90.html#getecwcp" TARGET=CENT_PANEL>getecwcp</a>(idate)
210:             else if ( dattyp=='ERA40' ) then
211:               call <a href="./mod_era40.f90.html#getera40" TARGET=CENT_PANEL>getera40</a>(idate)
212:             else if ( dattyp=='ERAIN' .or. dattyp=='EIN15' ) then
213:               call <a href="./mod_ein15.f90.html#getein15" TARGET=CENT_PANEL>getein15</a>(idate)
214:             else if ( dattyp=='EIN75' ) then
215:               call <a href="./mod_ein75.f90.html#getein75" TARGET=CENT_PANEL>getein75</a>(idate)
216:             else if ( dattyp=='EIN25' ) then
217:               call <a href="./mod_ein25.f90.html#getein25" TARGET=CENT_PANEL>getein25</a>(idate)
218:             else if ( dattyp=='GFS11' ) then
219:               call <a href="./mod_gfs11.f90.html#getgfs11" TARGET=CENT_PANEL>getgfs11</a>(idate)
220:             else if ( dattyp=='ERAHI' ) then
221:               call <a href="./mod_erahi.f90.html#geterahi" TARGET=CENT_PANEL>geterahi</a>(idate)
222:             else if ( dattyp=='EH5OM' ) then
223:               call <a href="./mod_eh5om.f90.html#geteh5om" TARGET=CENT_PANEL>geteh5om</a>(idate)
224:             else if ( dattyp=='FVGCM' ) then
225:               call <a href="./mod_fvgcm.f90.html#getfvgcm" TARGET=CENT_PANEL>getfvgcm</a>(idate)
226:             else if ( dattyp=='FNEST' ) then
227:               call <a href="./mod_nest.f90.html#get_nest" TARGET=CENT_PANEL>get_nest</a>(idate,0)
228:             else
229:             end if
230:           end if
231:           imonnew = imon + 1
232:           if ( imon>=12 ) then
233:             imonnew = 1
234:             iyr = iyr + 1
235:           end if
236:           idatef = iyr*1000000 + imonnew*10000 + 100
237:           if ( imon==1 .or. imon==3 .or. imon==5 .or. imon==7 .or.      &
238:              & imon==8 .or. imon==10 .or. imon==12 ) then
239:             inmber = (32-iday)*4 + 1
240:           else if ( imon==4 .or. imon==6 .or. imon==9 .or. imon==11 )   &
241:                   & then
242:             inmber = (31-iday)*4 + 1
243:           else
244:             if ( mod(iyr,4)==0 ) then
245:               inmber = (30-iday)*4 + 1
246:             else
247:               inmber = (29-iday)*4 + 1
248:             end if
249:             if ( mod(iyr,100)==0 ) inmber = (29-iday)*4 + 1
250:             if ( mod(iyr,400)==0 ) inmber = (30-iday)*4 + 1
251:           end if
252:           if ( igrads==1 ) call <a href="./mod_write.f90.html#gradsctl" TARGET=CENT_PANEL>gradsctl</a>(finame,idate,inmber)
253:           call <a href="./mod_write.f90.html#fexist" TARGET=CENT_PANEL>fexist</a>(finame)
254:           open (64,file=finame,form='unformatted',status='unknown',     &
255:               & recl=jx*iy*ibyte,access='direct')
256:           imonold = imon
257:           ifile = ifile + 1
258:           noutrec = 0
259:         end if
260:         if ( dattyp=='NNRP1' .or. dattyp=='NNRP2' ) then
261:           call <a href="./mod_ncep.f90.html#getncep" TARGET=CENT_PANEL>getncep</a>(idate)
262:         else if ( dattyp=='NRP2W' ) then
263:           call <a href="./mod_ncep.f90.html#getncepw" TARGET=CENT_PANEL>getncepw</a>(idate)
264:         else if ( dattyp=='ECMWF' ) then
265:           call <a href="./mod_ecwcp.f90.html#getecwcp" TARGET=CENT_PANEL>getecwcp</a>(idate)
266:         else if ( dattyp=='ERA40' ) then
267:           call <a href="./mod_era40.f90.html#getera40" TARGET=CENT_PANEL>getera40</a>(idate)
268:         else if ( dattyp=='ERAIN' .or. dattyp=='EIN15' ) then
269:           call <a href="./mod_ein15.f90.html#getein15" TARGET=CENT_PANEL>getein15</a>(idate)
270:         else if ( dattyp=='EIN75' ) then
271:           call <a href="./mod_ein75.f90.html#getein75" TARGET=CENT_PANEL>getein75</a>(idate)
272:         else if ( dattyp=='EIN25' ) then
273:           call <a href="./mod_ein25.f90.html#getein25" TARGET=CENT_PANEL>getein25</a>(idate)
274:         else if ( dattyp=='GFS11' ) then
275:           call <a href="./mod_gfs11.f90.html#getgfs11" TARGET=CENT_PANEL>getgfs11</a>(idate)
276:         else if ( dattyp=='ERAHI' ) then
277:           call <a href="./mod_erahi.f90.html#geterahi" TARGET=CENT_PANEL>geterahi</a>(idate)
278:         else if ( dattyp=='EH5OM' ) then
279:           call <a href="./mod_eh5om.f90.html#geteh5om" TARGET=CENT_PANEL>geteh5om</a>(idate)
280:         else if ( dattyp=='FVGCM' ) then
281:           call <a href="./mod_fvgcm.f90.html#getfvgcm" TARGET=CENT_PANEL>getfvgcm</a>(idate)
282:         else if ( dattyp=='FNEST' ) then
283:           call <a href="./mod_nest.f90.html#get_nest" TARGET=CENT_PANEL>get_nest</a>(idate,1)
284:         else
285:         end if
286:       end do
287: 
288:       call <a href="./mod_write.f90.html#free_output" TARGET=CENT_PANEL>free_output</a>
289:       call <a href="./mod_grid.f90.html#free_grid" TARGET=CENT_PANEL>free_grid</a>
290:  
291:       call <a href="./mod_header.F90.html#finaltime" TARGET=CENT_PANEL>finaltime</a>(0)
292:       print *, 'Successfully completed ICBC'
293: 
294:       stop
295:  100  continue
296:       print * , 'ERROR OPENING ', trim(sstfile)
297:       stop '4810 IN PROGRAM ICBC'
298: 99001 format (a,a,a,a)
299: 99002 format (a,a,a,a,i10)
300:       end program icbc
</PRE>

<HR>

</BODY>
</HTML>

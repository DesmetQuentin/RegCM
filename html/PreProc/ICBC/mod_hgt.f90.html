<HTML>

<HEAD>
<TITLE>mod_hgt.f90</TITLE>
</HEAD>

<BODY background="back_granite.gif">
<FONT COLOR="#000000" FACE="Times">
<H1 ALIGN=CENTER>mod_hgt.f90</H1>
<HR>
<H2 ALIGN=CENTER>mod_hgt.f90</H2>
<HR>
</FONT>

<HR>

<PRE>
1: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
2: !
3: !    This file is part of ICTP RegCM.
4: !
5: !    ICTP RegCM is free software: you can redistribute it and/or modify
6: !    it under the terms of the GNU General Public License as published by
7: !    the Free Software Foundation, either version 3 of the License, or
8: !    (at your option) any later version.
9: !
10: !    ICTP RegCM is distributed in the hope that it will be useful,
11: !    but WITHOUT ANY WARRANTY; without even the implied warranty of
12: !    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
13: !    GNU General Public License for more details.
14: !
15: !    You should have received a copy of the GNU General Public License
16: !    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
17: !
18: !::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
19: 
<p><a name=mod_hgt><H3>mod_hgt</H3></a></p>20:       module mod_hgt
21: 
22:       contains
23: 
<p><a name=hydrost><H3>hydrost</H3></a></p> Click <a href="./callingtree/hydrost_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where hydrost is used.
<hr>
24:       subroutine hydrost(h,t,phis,ps,pt,sigmaf,sigmah,dsigma,ni,nj,nk)
25:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rovg
26:       implicit none
27: !
28: ! Dummy arguments
29: !
30:       integer :: ni , nj , nk
31:       real(4) :: pt
32:       real(4) , dimension(nk) :: dsigma , sigmah
33:       real(4) , dimension(ni,nj,nk) :: h , t
34:       real(4) , dimension(ni,nj) :: phis , ps
35:       real(4) , dimension(nk+1) :: sigmaf
36:       intent (in) ni , nj , nk , phis , ps , pt , sigmaf , sigmah , t
37:       intent (inout) dsigma , h
38: !
39: ! Local variables
40: !
41:       integer :: i , j , k , k1 , k2
42:       real(4) :: pf , tbar
43: !
44: !     ROUTINE TO COMPUTE HEIGHT USING THE HYDROSTATIC RELATION.
45: !     THE METHOD UTILIZED HERE IS CONSISTENT WITH THE WAY THE
46: !     HEIGHT IS COMPUTED IN THE RCM MODEL.
47: !
48:       do k = 1 , nk
49:         dsigma(k) = sigmaf(k+1) - sigmaf(k)
50:       end do
51: !
52: !     SET BOUNDARY VALUES TO ZERO AT ALL LEVELS SINCE THE HEIGHT IS
53: !     DEFINED AT CROSS POINTS AND AT HALF LEVELS.
54: !
55:       do i = 1 , ni
56:         do j = 1 , nj
57:           pf = pt/ps(i,j)
58:           h(i,j,nk) = phis(i,j) + rovg*t(i,j,nk)                        &
59:                     & *log((1.+pf)/(sigmah(nk)+pf))
60:           do k2 = 1 , nk - 1
61:             k = nk - k2
62:             k1 = k + 1
63:             tbar = (t(i,j,k)*dsigma(k)+t(i,j,k1)*dsigma(k1))            &
64:                  & /(dsigma(k)+dsigma(k1))
65:             h(i,j,k) = h(i,j,k1)                                        &
66:                      & + rovg*tbar*log((sigmah(k1)+pf)/(sigmah(k)+pf))
67:           end do
68:         end do
69:       end do
70:       end subroutine hydrost
71: !
72: !-----------------------------------------------------------------------
73: !
<p><a name=height><H3>height</H3></a></p> Click <a href="./callingtree/height_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where height is used.
<hr>
74:       subroutine height(hp,h,t,ps,p3d,ht,im,jm,km,p,kp)
75:  
76: !  HEIGHT DETERMINES THE HEIGHT OF PRESSURE LEVELS.
77: !     ON INPUT:
78: !        H AND T ARE HEIGHT AND TEMPERATURE ON SIGMA, RESPECTIVELY.
79: !        PS = SURFACE PRESSURE
80: !        PTOP = MODEL TOP PRESSURE.
81: !        SIG = SIGMA LEVELS.
82: !        P = PRESSURE LEVELS DESIRED.
83: !     ON OUTPUT:
84: !        ALL FIELDS EXCEPT H ARE UNCHANGED.
85: !        H HAS HEIGHT FIELDS AT KP PRESSURE LEVELS.
86: !
87: !  FOR UPWARD EXTRAPOLATION, T IS CONSIDERED TO HAVE 0 VERITCAL DERIV.
88: !  FOR DOWNWARD EXTRAPOLATION, T HAS LAPSE RATE OF TLAPSE (K/KM)
89: !     AND EXTRAPOLATION IS DONE FROM THE LOWEST SIGMA LEVEL ABOVE
90: !     THE BOUNDARY LAYER (TOP ARBITRARILY TAKEN AT SIGMA = BLTOP).
91: !     EQUATION USED IS EXACT SOLUTION TO HYDROSTATIC RELATION,
92: !     GOTTEN FROM R. ERRICO (ALSO USED IN SLPRES ROUTINE):
93: !      Z = Z0 - (T0/TLAPSE) * (1.-EXP(-R*TLAPSE*LN(P/P0)/G))
94: !
95:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rgti , rgas , lrate , bltop
96: 
97:       implicit none
98: !
99: ! Dummy arguments
100: !
101:       integer :: im , jm , km , kp
102:       real(4) , dimension(im,jm,km) :: h , p3d , t
103:       real(4) , dimension(im,jm,kp) :: hp
104:       real(4) , dimension(im,jm) :: ht , ps
105:       real(4) , dimension(kp) :: p
106:       intent (in) h , ht , im , jm , km , kp , p , p3d , ps , t
107:       intent (out) hp
108: !
109: ! Local variables
110: !
111:       real(4) :: psfc , temp , wb , wt
112:       integer :: i , j , k , kb , kbc , kt , n
113:       real(4) , dimension(61) :: psig
114:       real(4) , dimension(60) :: sig
115: !
116:       do j = 1 , jm
117:         do i = 1 , im
118:           psfc = ps(i,j)
119:           kbc = 1
120:           if ( psfc>-9995.0 ) then
121:             do k = 1 , km
122:               sig(k) = p3d(i,j,k)/ps(i,j)
123:               if ( sig(k)<bltop ) kbc = k
124:               psig(k) = p3d(i,j,k)
125:             end do
126:             do n = 1 , kp
127:               kt = 1
128:               do k = 1 , km
129:                 if ( psig(k)<p(n) ) kt = k
130:               end do
131:               kb = kt + 1
132:               if ( p(n)<=psig(1) ) then
133:                 temp = t(i,j,1)
134:                 hp(i,j,n) = h(i,j,1) + rgas*temp*log(psig(1)/p(n))*rgti
135:               else if ( (p(n)>psig(1)) .and. (p(n)<psig(km)) ) then
136:                 wt = log(psig(kb)/p(n))/log(psig(kb)/psig(kt))
137:                 wb = log(p(n)/psig(kt))/log(psig(kb)/psig(kt))
138:                 temp = wt*t(i,j,kt) + wb*t(i,j,kb)
139:                 temp = (temp+t(i,j,kb))/2.
140:                 hp(i,j,n) = h(i,j,kb) + rgas*temp*log(psig(kb)/p(n))    &
141:                           & *rgti
142:               else if ( (p(n)>=psig(km)) .and. (p(n)<=psfc) ) then
143:                 temp = t(i,j,km)
144:                 hp(i,j,n) = ht(i,j) + rgas*temp*log(psfc/p(n))*rgti
145:               else if ( p(n)>psfc ) then
146:                 temp = t(i,j,kbc) + lrate*(h(i,j,kbc)-ht(i,j))
147:                 hp(i,j,n) = ht(i,j) + (temp/lrate)                      &
148:                           & *(1.-exp(+rgas*lrate*log(p(n)/psfc)*rgti))
149: !
150:               else
151:               end if
152:             end do
153:           else
154:             do n = 1 , kp
155:               hp(i,j,n) = -9999.0
156:             end do
157:           end if
158:         end do
159:       end do
160:       end subroutine height
161: !
162: !-----------------------------------------------------------------------
163: !
<p><a name=height_o><H3>height_o</H3></a></p> Click <a href="./callingtree/height_o_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where height_o is used.
<hr>
164:       subroutine height_o(hp,h,t,pstar,ht,sig,ptop,im,jm,km,p,kp)
165:  
166: !  HEIGHT DETERMINES THE HEIGHT OF PRESSURE LEVELS.
167: !     ON INPUT:
168: !        H AND T ARE HEIGHT AND TEMPERATURE ON SIGMA, RESPECTIVELY.
169: !        PSTAR = SURFACE PRESSURE - MODEL TOP PRESSURE.
170: !        SIG = SIGMA LEVELS.
171: !        P = PRESSURE LEVELS DESIRED.
172: !     ON OUTPUT:
173: !        ALL FIELDS EXCEPT H ARE UNCHANGED.
174: !        H HAS HEIGHT FIELDS AT KP PRESSURE LEVELS.
175: !
176: !  FOR UPWARD EXTRAPOLATION, T IS CONSIDERED TO HAVE 0 VERITCAL DERIV.
177: !  FOR DOWNWARD EXTRAPOLATION, T HAS LAPSE RATE OF TLAPSE (K/KM)
178: !     AND EXTRAPOLATION IS DONE FROM THE LOWEST SIGMA LEVEL ABOVE
179: !     THE BOUNDARY LAYER (TOP ARBITRARILY TAKEN AT SIGMA = BLTOP).
180: !     EQUATION USED IS EXACT SOLUTION TO HYDROSTATIC RELATION,
181: !     GOTTEN FROM R. ERRICO (ALSO USED IN SLPRES ROUTINE):
182: !      Z = Z0 - (T0/TLAPSE) * (1.-EXP(-R*TLAPSE*LN(P/P0)/G))
183: !
184:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rgti , rgas , lrate , bltop
185:       implicit none
186: !
187: ! Dummy arguments
188: !
189:       integer :: im , jm , km , kp
190:       real(4) :: ptop
191:       real(4) , dimension(im,jm,km) :: h , t
192:       real(4) , dimension(im,jm,kp) :: hp
193:       real(4) , dimension(im,jm) :: ht , pstar
194:       real(4) , dimension(kp) :: p
195:       real(4) , dimension(km) :: sig
196:       intent (in) h , ht , im , jm , km , kp , p , pstar , ptop , sig , &
197:                 & t
198:       intent (out) hp
199: !
200: ! Local variables
201: !
202:       real(4) :: psfc , temp , wb , wt
203:       integer :: i , j , k , kb , kbc , kt , n
204:       real(4) , dimension(100) :: psig
205: !
206:       kbc = 1
207:       do k = 1 , km
208:         if ( sig(k)<bltop ) kbc = k
209:       end do
210: !     PRINT *,'FIRST SIGMA LEVEL ABOVE BNDY LAYER:', SIG(KBC)
211: !
212:       do j = 1 , jm
213:         do i = 1 , im
214:           do k = 1 , km
215:             psig(k) = sig(k)*(pstar(i,j)-ptop) + ptop
216:           end do
217:           psfc = pstar(i,j)
218:           do n = 1 , kp
219:             kt = 1
220:             do k = 1 , km
221:               if ( psig(k)<p(n) ) kt = k
222:             end do
223:             kb = kt + 1
224:             if ( p(n)<=psig(1) ) then
225:               temp = t(i,j,1)
226:               hp(i,j,n) = h(i,j,1) + rgas*temp*log(psig(1)/p(n))*rgti
227:             else if ( (p(n)>psig(1)) .and. (p(n)<psig(km)) ) then
228:               wt = log(psig(kb)/p(n))/log(psig(kb)/psig(kt))
229:               wb = log(p(n)/psig(kt))/log(psig(kb)/psig(kt))
230:               temp = wt*t(i,j,kt) + wb*t(i,j,kb)
231:               temp = (temp+t(i,j,kb))/2.
232:               hp(i,j,n) = h(i,j,kb) + rgas*temp*log(psig(kb)/p(n))*rgti
233:             else if ( (p(n)>=psig(km)) .and. (p(n)<=psfc) ) then
234:               temp = t(i,j,km)
235:               hp(i,j,n) = ht(i,j) + rgas*temp*log(psfc/p(n))*rgti
236:             else if ( p(n)>psfc ) then
237:               temp = t(i,j,kbc) + lrate*(h(i,j,kbc)-ht(i,j))
238:               hp(i,j,n) = ht(i,j) + (temp/lrate)                        &
239:                         & *(1.-exp(+rgas*lrate*log(p(n)/psfc)*rgti))
240: !
241:             else
242:             end if
243:           end do
244:         end do
245:       end do
246:       end subroutine height_o
247: !
248: !-----------------------------------------------------------------------
249: !
<p><a name=htsig><H3>htsig</H3></a></p> Click <a href="./callingtree/htsig_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where htsig is used.
<hr>
250:       subroutine htsig(t,h,p3d,ps,ht,im,jm,km)
251:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a> , only : rgti, rgas
252:       implicit none
253: !
254: ! Dummy arguments
255: !
256:       integer :: im , jm , km
257:       real(4) , dimension(im,jm,km) :: h , p3d , t
258:       real(4) , dimension(im,jm) :: ht , ps
259:       intent (in) ht , im , jm , km , p3d , ps , t
260:       intent (inout) h
261: !
262: ! Local variables
263: !
264:       real(4) :: tbar
265:       integer :: i , j , k
266: !
267:       do j = 1 , jm
268:         do i = 1 , im
269:           if ( ps(i,j)>-9995.0 ) then
270:             h(i,j,km) = ht(i,j) + rgas*rgti*t(i,j,km)                   &
271:                       & *log(ps(i,j)/p3d(i,j,km))
272:           else
273:             h(i,j,km) = -9999.0
274:           end if
275:         end do
276:       end do
277:       do k = km - 1 , 1 , -1
278:         do j = 1 , jm
279:           do i = 1 , im
280:             if ( h(i,j,k+1)>-9995.0 ) then
281:               tbar = 0.5*(t(i,j,k)+t(i,j,k+1))
282:               h(i,j,k) = h(i,j,k+1)                                     &
283:                        & + rgas*rgti*tbar*log(p3d(i,j,k+1)/p3d(i,j,k))
284:             else
285:               h(i,j,k) = -9999.0
286:             end if
287:           end do
288:         end do
289:       end do
290:       end subroutine htsig
291: !
292: !-----------------------------------------------------------------------
293: !
<p><a name=htsig_o><H3>htsig_o</H3></a></p> Click <a href="./callingtree/htsig_o_rite.html" TARGET=RITE_PANEL>HERE</a> to see the where htsig_o is used.
<hr>
294:       subroutine htsig_o(t,h,pstar,ht,sig,ptop,im,jm,km)
295:       use <a href="./mod_constants.F90.html#mod_constants" TARGET=CENT_PANEL>mod_constants</a>, only : rgas , rgti
296:       implicit none
297: !
298: ! Dummy arguments
299: !
300:       integer :: im , jm , km
301:       real(4) :: ptop
302:       real(4) , dimension(im,jm,km) :: h , t
303:       real(4) , dimension(im,jm) :: ht , pstar
304:       real(4) , dimension(km) :: sig
305:       intent (in) ht , im , jm , km , pstar , ptop , sig , t
306:       intent (inout) h
307: !
308: ! Local variables
309: !
310:       real(4) :: tbar
311:       integer :: i , j , k
312: !
313:       do j = 1 , jm
314:         do i = 1 , im
315:           h(i,j,km) = ht(i,j) + rgas*rgti*t(i,j,km)                     &
316:                     & *log(pstar(i,j)/((pstar(i,j)-ptop)*sig(km)+ptop))
317:         end do
318:       end do
319:       do k = km - 1 , 1 , -1
320:         do j = 1 , jm
321:           do i = 1 , im
322:             tbar = 0.5*(t(i,j,k)+t(i,j,k+1))
323:             h(i,j,k) = h(i,j,k+1)                                       &
324:                      & + rgas*rgti*tbar*log(((pstar(i,j)-ptop)*sig(k+1) &
325:                      & +ptop)/((pstar(i,j)-ptop)*sig(k)+ptop))
326:           end do
327:         end do
328:       end do
329:       end subroutine htsig_o
330: !
331:       end module mod_hgt
</PRE>

<HR>

</BODY>
</HTML>
